--
-- PostgreSQL database dump
--

\restrict wb3J0fnyZNsiwAQ5r5fTnZ4j8WCYtIRH4yH8KY6O4jcYDfnEEJkH0wXgck41blw

-- Dumped from database version 15.8
-- Dumped by pg_dump version 15.14

-- Started on 2026-02-16 15:38:13

SET statement_timeout = 0;
SET lock_timeout = 0;
SET idle_in_transaction_session_timeout = 0;
SET client_encoding = 'UTF8';
SET standard_conforming_strings = on;
SELECT pg_catalog.set_config('search_path', '', false);
SET check_function_bodies = false;
SET xmloption = content;
SET client_min_messages = warning;
SET row_security = off;

--
-- TOC entry 81 (class 2615 OID 29143)
-- Name: auth; Type: SCHEMA; Schema: -; Owner: -
--

CREATE SCHEMA auth;


--
-- TOC entry 30 (class 2615 OID 2200)
-- Name: public; Type: SCHEMA; Schema: -; Owner: -
--

CREATE SCHEMA public;


--
-- TOC entry 5985 (class 0 OID 0)
-- Dependencies: 30
-- Name: SCHEMA public; Type: COMMENT; Schema: -; Owner: -
--

COMMENT ON SCHEMA public IS 'standard public schema';


--
-- TOC entry 3 (class 3079 OID 29537)
-- Name: postgis; Type: EXTENSION; Schema: -; Owner: -
--

CREATE EXTENSION IF NOT EXISTS postgis WITH SCHEMA public;


--
-- TOC entry 5986 (class 0 OID 0)
-- Dependencies: 3
-- Name: EXTENSION postgis; Type: COMMENT; Schema: -; Owner: -
--

COMMENT ON EXTENSION postgis IS 'PostGIS geometry and geography spatial types and functions';


--
-- TOC entry 8 (class 3079 OID 30609)
-- Name: uuid-ossp; Type: EXTENSION; Schema: -; Owner: -
--

CREATE EXTENSION IF NOT EXISTS "uuid-ossp" WITH SCHEMA extensions;


--
-- TOC entry 5987 (class 0 OID 0)
-- Dependencies: 8
-- Name: EXTENSION "uuid-ossp"; Type: COMMENT; Schema: -; Owner: -
--

COMMENT ON EXTENSION "uuid-ossp" IS 'generate universally unique identifiers (UUIDs)';


--
-- TOC entry 2192 (class 1247 OID 30621)
-- Name: aal_level; Type: TYPE; Schema: auth; Owner: -
--

CREATE TYPE auth.aal_level AS ENUM (
    'aal1',
    'aal2',
    'aal3'
);


--
-- TOC entry 2195 (class 1247 OID 30628)
-- Name: code_challenge_method; Type: TYPE; Schema: auth; Owner: -
--

CREATE TYPE auth.code_challenge_method AS ENUM (
    's256',
    'plain'
);


--
-- TOC entry 2198 (class 1247 OID 30634)
-- Name: factor_status; Type: TYPE; Schema: auth; Owner: -
--

CREATE TYPE auth.factor_status AS ENUM (
    'unverified',
    'verified'
);


--
-- TOC entry 2201 (class 1247 OID 30640)
-- Name: factor_type; Type: TYPE; Schema: auth; Owner: -
--

CREATE TYPE auth.factor_type AS ENUM (
    'totp',
    'webauthn',
    'phone'
);


--
-- TOC entry 2368 (class 1247 OID 393208)
-- Name: oauth_authorization_status; Type: TYPE; Schema: auth; Owner: -
--

CREATE TYPE auth.oauth_authorization_status AS ENUM (
    'pending',
    'approved',
    'denied',
    'expired'
);


--
-- TOC entry 2380 (class 1247 OID 393281)
-- Name: oauth_client_type; Type: TYPE; Schema: auth; Owner: -
--

CREATE TYPE auth.oauth_client_type AS ENUM (
    'public',
    'confidential'
);


--
-- TOC entry 2353 (class 1247 OID 338520)
-- Name: oauth_registration_type; Type: TYPE; Schema: auth; Owner: -
--

CREATE TYPE auth.oauth_registration_type AS ENUM (
    'dynamic',
    'manual'
);


--
-- TOC entry 2371 (class 1247 OID 393218)
-- Name: oauth_response_type; Type: TYPE; Schema: auth; Owner: -
--

CREATE TYPE auth.oauth_response_type AS ENUM (
    'code'
);


--
-- TOC entry 2204 (class 1247 OID 30648)
-- Name: one_time_token_type; Type: TYPE; Schema: auth; Owner: -
--

CREATE TYPE auth.one_time_token_type AS ENUM (
    'confirmation_token',
    'reauthentication_token',
    'recovery_token',
    'email_change_token_new',
    'email_change_token_current',
    'phone_change_token'
);


--
-- TOC entry 2137 (class 1247 OID 62254)
-- Name: bid_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.bid_status AS ENUM (
    'Open',
    'Accepted',
    'Declined',
    'Expired',
    'Cancelled'
);


--
-- TOC entry 2456 (class 1247 OID 511722)
-- Name: dispute_priority; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.dispute_priority AS ENUM (
    'low',
    'medium',
    'high',
    'urgent'
);


--
-- TOC entry 2453 (class 1247 OID 511708)
-- Name: dispute_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.dispute_status AS ENUM (
    'open',
    'under_review',
    'awaiting_response',
    'resolved',
    'closed',
    'escalated'
);


--
-- TOC entry 2459 (class 1247 OID 511732)
-- Name: dispute_type; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.dispute_type AS ENUM (
    'payment',
    'delivery',
    'damage',
    'behavior',
    'cancellation',
    'other'
);


--
-- TOC entry 2402 (class 1247 OID 444739)
-- Name: escrow_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.escrow_status AS ENUM (
    'pending',
    'held',
    'released',
    'refunded',
    'partially_refunded'
);


--
-- TOC entry 2314 (class 1247 OID 42538)
-- Name: freight_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.freight_status AS ENUM (
    'Bidding',
    'Pickup',
    'OnRoute',
    'Delivered',
    'Cancelled'
);


--
-- TOC entry 2390 (class 1247 OID 433343)
-- Name: freight_type; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.freight_type AS ENUM (
    'items',
    'moving',
    'rubble',
    'vehicles'
);


--
-- TOC entry 2311 (class 1247 OID 67466)
-- Name: notification_type; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.notification_type AS ENUM (
    'bid_accepted',
    'bid_rejected',
    'outbid',
    'delivery_started',
    'delivery_completed',
    'payment_received',
    'rated',
    'new_bid',
    'driver_registered',
    'new_shipment',
    'profile_updated',
    'vehicle_added',
    'upcoming_job',
    'pickup_confirmed',
    'shipment_cancelled',
    'bid_cancelled',
    'bid_expired',
    'bid_updated',
    'general',
    'dispute_filed',
    'dispute_escalated',
    'dispute_resolved',
    'driver_pending_approval',
    'driver_document_uploaded',
    'driver_suspended',
    'payment_failed',
    'payment_refund_requested',
    'admin_system_alert'
);


--
-- TOC entry 5988 (class 0 OID 0)
-- Dependencies: 2311
-- Name: TYPE notification_type; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TYPE public.notification_type IS 'Notification types: bid_updated = when bid details change, general = system messages (hidden from UI)';


--
-- TOC entry 2132 (class 1247 OID 158787)
-- Name: payment_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.payment_status AS ENUM (
    'pending',
    'completed',
    'failed',
    'refunded'
);


--
-- TOC entry 2362 (class 1247 OID 361896)
-- Name: tracking_point_type; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.tracking_point_type AS ENUM (
    'start',
    'tracking',
    'pickup',
    'dropoff',
    'pause',
    'resume',
    'stop'
);


--
-- TOC entry 2359 (class 1247 OID 361885)
-- Name: tracking_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.tracking_status AS ENUM (
    'idle',
    'active',
    'paused',
    'completed',
    'cancelled'
);


--
-- TOC entry 2408 (class 1247 OID 444762)
-- Name: transaction_type; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.transaction_type AS ENUM (
    'collection',
    'payout',
    'refund',
    'commission',
    'commission_withdrawal'
);


--
-- TOC entry 2405 (class 1247 OID 444750)
-- Name: transfer_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.transfer_status AS ENUM (
    'pending',
    'processing',
    'success',
    'failed',
    'reversed'
);


--
-- TOC entry 2308 (class 1247 OID 55691)
-- Name: user_role; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.user_role AS ENUM (
    'Shipper',
    'Driver',
    'Admin',
    'Guest'
);


--
-- TOC entry 2450 (class 1247 OID 511695)
-- Name: verification_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.verification_status AS ENUM (
    'pending',
    'under_review',
    'documents_requested',
    'approved',
    'rejected',
    'suspended'
);


--
-- TOC entry 1080 (class 1255 OID 30698)
-- Name: email(); Type: FUNCTION; Schema: auth; Owner: -
--

CREATE FUNCTION auth.email() RETURNS text
    LANGUAGE sql STABLE
    AS $$
  select 
  coalesce(
    nullif(current_setting('request.jwt.claim.email', true), ''),
    (nullif(current_setting('request.jwt.claims', true), '')::jsonb ->> 'email')
  )::text
$$;


--
-- TOC entry 5989 (class 0 OID 0)
-- Dependencies: 1080
-- Name: FUNCTION email(); Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON FUNCTION auth.email() IS 'Deprecated. Use auth.jwt() -> ''email'' instead.';


--
-- TOC entry 1083 (class 1255 OID 30699)
-- Name: jwt(); Type: FUNCTION; Schema: auth; Owner: -
--

CREATE FUNCTION auth.jwt() RETURNS jsonb
    LANGUAGE sql STABLE
    AS $$
  select 
    coalesce(
        nullif(current_setting('request.jwt.claim', true), ''),
        nullif(current_setting('request.jwt.claims', true), '')
    )::jsonb
$$;


--
-- TOC entry 1029 (class 1255 OID 30700)
-- Name: role(); Type: FUNCTION; Schema: auth; Owner: -
--

CREATE FUNCTION auth.role() RETURNS text
    LANGUAGE sql STABLE
    AS $$
  select 
  coalesce(
    nullif(current_setting('request.jwt.claim.role', true), ''),
    (nullif(current_setting('request.jwt.claims', true), '')::jsonb ->> 'role')
  )::text
$$;


--
-- TOC entry 5990 (class 0 OID 0)
-- Dependencies: 1029
-- Name: FUNCTION role(); Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON FUNCTION auth.role() IS 'Deprecated. Use auth.jwt() -> ''role'' instead.';


--
-- TOC entry 1067 (class 1255 OID 30701)
-- Name: uid(); Type: FUNCTION; Schema: auth; Owner: -
--

CREATE FUNCTION auth.uid() RETURNS uuid
    LANGUAGE sql SECURITY DEFINER
    AS $$
  -- Get the JWT claims from the current request
  WITH claims AS (
    SELECT
      current_setting('request.jwt.claims', true)::jsonb AS jwt_claims
  )
  SELECT
    -- Extract the 'sub' claim and convert it to UUID
    CASE
      -- When sub claim exists, return it as UUID
      WHEN claims.jwt_claims ? 'sub' THEN 
        (claims.jwt_claims->>'sub')::uuid
      -- Fallback to null UUID if no sub claim is found
      ELSE 
        '00000000-0000-0000-0000-000000000000'::uuid
    END
  FROM claims;
$$;


--
-- TOC entry 5991 (class 0 OID 0)
-- Dependencies: 1067
-- Name: FUNCTION uid(); Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON FUNCTION auth.uid() IS 'Deprecated. Use auth.jwt() -> ''sub'' instead.';


--
-- TOC entry 1434 (class 1255 OID 452998)
-- Name: accept_bid_with_pins(uuid, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.accept_bid_with_pins(p_bid_id uuid, p_freight_post_id uuid) RETURNS jsonb
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_pickup_pin TEXT;
  v_delivery_pin TEXT;
  v_bid_exists BOOLEAN;
  v_freight_exists BOOLEAN;
  v_freight_type public.freight_type;
BEGIN
  -- Validate inputs
  IF p_bid_id IS NULL OR p_freight_post_id IS NULL THEN
    RETURN jsonb_build_object(
      'success', false,
      'error', 'Missing required parameters'
    );
  END IF;

  -- Check if bid exists
  SELECT EXISTS(SELECT 1 FROM public.bids WHERE id = p_bid_id) INTO v_bid_exists;
  IF NOT v_bid_exists THEN
    RETURN jsonb_build_object(
      'success', false,
      'error', 'Bid not found'
    );
  END IF;

  -- Check if freight post exists and get freight_type
  SELECT freight_type INTO v_freight_type
  FROM public.freight_posts 
  WHERE id = p_freight_post_id;
  
  IF v_freight_type IS NULL THEN
    RETURN jsonb_build_object(
      'success', false,
      'error', 'Freight post not found'
    );
  END IF;

  -- Generate two distinct 4-digit PINs
  v_pickup_pin := LPAD(FLOOR(RANDOM() * 10000)::TEXT, 4, '0');
  v_delivery_pin := LPAD(FLOOR(RANDOM() * 10000)::TEXT, 4, '0');
  
  -- Ensure PINs are different
  WHILE v_delivery_pin = v_pickup_pin LOOP
    v_delivery_pin := LPAD(FLOOR(RANDOM() * 10000)::TEXT, 4, '0');
  END LOOP;

  -- Update freight_posts with Pickup status and PINs
  UPDATE public.freight_posts
  SET 
    status = 'Pickup',
    pickup_pin = v_pickup_pin,
    delivery_pin = v_delivery_pin,
    updated_at = NOW()
  WHERE id = p_freight_post_id;

  -- Update accepted bid status
  UPDATE public.bids
  SET 
    status = 'Accepted',
    modified_at = NOW()
  WHERE id = p_bid_id;

  -- Decline all other bids for this shipment
  UPDATE public.bids
  SET 
    status = 'Declined',
    modified_at = NOW()
  WHERE freight_post_id = p_freight_post_id
    AND id != p_bid_id
    AND status != 'Declined';

  -- Log tracking status
  IF v_freight_type = 'rubble' THEN
    RAISE NOTICE 'Rubble shipment %: Tracking should NOT be created', p_freight_post_id;
  ELSE
    RAISE NOTICE 'Non-rubble shipment %: Tracking session should be created', p_freight_post_id;
  END IF;

  -- Return success with PINs and rubble flag
  RETURN jsonb_build_object(
    'success', true,
    'pickup_pin', v_pickup_pin,
    'delivery_pin', v_delivery_pin,
    'shipment_id', p_freight_post_id,
    'bid_id', p_bid_id,
    'is_rubble', (v_freight_type = 'rubble'),
    'freight_type', v_freight_type::text
  );

EXCEPTION
  WHEN OTHERS THEN
    -- Return error details
    RETURN jsonb_build_object(
      'success', false,
      'error', SQLERRM,
      'detail', SQLSTATE
    );
END;
$$;


--
-- TOC entry 5992 (class 0 OID 0)
-- Dependencies: 1434
-- Name: FUNCTION accept_bid_with_pins(p_bid_id uuid, p_freight_post_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.accept_bid_with_pins(p_bid_id uuid, p_freight_post_id uuid) IS 'Accepts a bid with PIN generation. Generates two distinct 4-digit PINs, updates shipment status to Pickup, accepts the bid, and declines other bids. Called by both Paystack webhook and Dart repository. Fixed to use correct column names: bids.modified_at and freight_posts.updated_at';


--
-- TOC entry 1418 (class 1255 OID 373673)
-- Name: analyze_route_quality(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.analyze_route_quality(p_tracking_id uuid) RETURNS TABLE(total_points integer, duplicates_count integer, stationary_points_count integer, average_point_spacing_meters double precision, max_gap_meters double precision, data_quality_score double precision)
    LANGUAGE plpgsql
    AS $$
BEGIN
    RETURN QUERY
    WITH point_analysis AS (
        SELECT 
            COUNT(*) as total,
            COUNT(*) FILTER (WHERE distance_from_previous IS NULL OR distance_from_previous < 1) as duplicates,
            COUNT(*) FILTER (WHERE speed < 1) as stationary,
            AVG(distance_from_previous) FILTER (WHERE distance_from_previous > 0) as avg_spacing,
            MAX(distance_from_previous) as max_gap
        FROM tracking_points
        WHERE tracking_id = p_tracking_id
    )
    SELECT 
        total::integer,
        duplicates::integer,
        stationary::integer,
        (avg_spacing * 1000)::double precision,
        (max_gap * 1000)::double precision,
        CASE 
            WHEN total = 0 THEN 0
            ELSE (100.0 - 
                  (duplicates::double precision / total * 20) - 
                  (LEAST(max_gap, 10.0) / 10.0 * 30) -
                  (stationary::double precision / total * 10))::double precision
        END
    FROM point_analysis;
END;
$$;


--
-- TOC entry 5993 (class 0 OID 0)
-- Dependencies: 1418
-- Name: FUNCTION analyze_route_quality(p_tracking_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.analyze_route_quality(p_tracking_id uuid) IS 'Analyze tracking data quality - detect duplicates, gaps, and calculate quality score';


--
-- TOC entry 1455 (class 1255 OID 483377)
-- Name: auto_calculate_distance_eta(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.auto_calculate_distance_eta() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_shipment_id UUID;
  v_dropoff_location GEOMETRY;
  v_distance_km DOUBLE PRECISION;
  v_eta_minutes INTEGER;
BEGIN
  -- Only calculate if location was updated
  IF NEW.current_latitude IS NOT NULL AND NEW.current_longitude IS NOT NULL THEN

    -- Get the first active shipment for this tracking session
    SELECT shipment_id INTO v_shipment_id
    FROM driver_tracking_shipments
    WHERE driver_tracking_id = NEW.id
      AND removed_at IS NULL
    ORDER BY added_at ASC
    LIMIT 1;

    -- If we have an active shipment, calculate metrics
    IF v_shipment_id IS NOT NULL THEN

      -- Get dropoff location from freight_posts
      SELECT dropoff_location INTO v_dropoff_location
      FROM freight_posts
      WHERE id = v_shipment_id;

      -- If dropoff location exists, calculate distance
      IF v_dropoff_location IS NOT NULL THEN

        -- Calculate distance in kilometers using PostGIS geodesic distance
        -- ST_Distance with geography type returns meters, divide by 1000 for km
        v_distance_km := ST_Distance(
          ST_MakePoint(NEW.current_longitude, NEW.current_latitude)::geography,
          v_dropoff_location::geography
        ) / 1000.0;

        -- Calculate ETA based on current speed (only if moving > 5 km/h)
        IF NEW.current_speed IS NOT NULL AND NEW.current_speed > 5.0 THEN
          v_eta_minutes := ROUND((v_distance_km / NEW.current_speed * 60)::numeric)::integer;
        ELSE
          v_eta_minutes := NULL;
        END IF;

        -- Update the record with calculated values
        NEW.distance_remaining := v_distance_km;
        NEW.eta_minutes := v_eta_minutes;

      END IF;
    ELSE
      -- No active shipments, clear metrics
      NEW.distance_remaining := NULL;
      NEW.eta_minutes := NULL;
    END IF;
  END IF;

  RETURN NEW;
END;
$$;


--
-- TOC entry 5994 (class 0 OID 0)
-- Dependencies: 1455
-- Name: FUNCTION auto_calculate_distance_eta(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.auto_calculate_distance_eta() IS 'Automatically calculates distance_remaining and eta_minutes when driver location is updated';


--
-- TOC entry 1445 (class 1255 OID 479873)
-- Name: auto_update_timestamp(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.auto_update_timestamp() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- TOC entry 1423 (class 1255 OID 373646)
-- Name: calculate_eta(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.calculate_eta(p_tracking_id uuid) RETURNS TABLE(distance_remaining_km double precision, current_speed_kmh double precision, eta_minutes integer, estimated_arrival timestamp with time zone)
    LANGUAGE plpgsql
    AS $$DECLARE
    v_latest_point geometry;
    v_dropoff_location geometry;
    v_current_speed double precision;
    v_avg_speed double precision;
    v_distance_remaining double precision;
    v_eta_minutes integer;
BEGIN
    -- Get latest point and speed
    SELECT location, speed
    INTO v_latest_point, v_current_speed
    FROM tracking_points
    WHERE tracking_id = p_tracking_id
    ORDER BY "timestamp" DESC
    LIMIT 1;

    IF v_latest_point IS NULL THEN
        RETURN;
    END IF;

    -- Get dropoff location
    SELECT fp.dropoff_location
    INTO v_dropoff_location
    FROM tracking_sessions ts
    JOIN freight_posts fp ON ts.shipment_id = fp.id
    WHERE ts.id = p_tracking_id;

    IF v_dropoff_location IS NULL THEN
        RETURN;
    END IF;

    -- Distance remaining (km)
    v_distance_remaining := ST_Distance(
        v_latest_point::geography,
        v_dropoff_location::geography
    ) / 1000.0;

    -- Compute recent average speed over last few minutes
    SELECT AVG(speed)
    INTO v_avg_speed
    FROM tracking_points
    WHERE tracking_id = p_tracking_id
      AND "timestamp" > NOW() - INTERVAL '10 minutes'
      AND speed > 2;  -- ignore near-zero noise

    -- If stationary or slow, use average or conservative fallback
    IF v_current_speed < 5 THEN
        v_current_speed := COALESCE(v_avg_speed, 20.0);  -- fallback 20 km/h
    END IF;

    -- Calculate ETA, guard against zero division
    IF v_current_speed <= 0 THEN
        v_eta_minutes := NULL; -- Unknown / not moving
    ELSE
        v_eta_minutes := CEIL((v_distance_remaining / v_current_speed) * 60);
    END IF;

    -- Optionally clamp ETA to a reasonable range (e.g., < 24 hours)
    IF v_eta_minutes > 1440 THEN
        v_eta_minutes := 1440;
    END IF;

    RETURN QUERY SELECT 
        v_distance_remaining,
        v_current_speed,
        v_eta_minutes,
        CASE 
            WHEN v_eta_minutes IS NOT NULL 
            THEN NOW() + (v_eta_minutes || ' minutes')::interval
            ELSE NULL
        END;
END;$$;


--
-- TOC entry 5995 (class 0 OID 0)
-- Dependencies: 1423
-- Name: FUNCTION calculate_eta(p_tracking_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.calculate_eta(p_tracking_id uuid) IS 'Calculate ETA based on current position, speed, and remaining distance';


--
-- TOC entry 1430 (class 1255 OID 445013)
-- Name: calculate_payment_amounts(numeric, numeric); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.calculate_payment_amounts(p_bid_amount numeric, p_commission_rate numeric DEFAULT 0.05) RETURNS jsonb
    LANGUAGE plpgsql
    AS $$
DECLARE
    v_shipper_commission numeric;
    v_driver_commission numeric;
    v_total_paid numeric;
    v_driver_payout numeric;
    v_platform_commission numeric;
BEGIN
    -- Calculate shipper's additional commission (5%)
    v_shipper_commission := ROUND(p_bid_amount * p_commission_rate, 2);
    
    -- Calculate driver's deducted commission (5%)
    v_driver_commission := ROUND(p_bid_amount * p_commission_rate, 2);
    
    -- Total paid by shipper
    v_total_paid := p_bid_amount + v_shipper_commission;
    
    -- Driver receives
    v_driver_payout := p_bid_amount - v_driver_commission;
    
    -- Platform keeps (10% total)
    v_platform_commission := v_shipper_commission + v_driver_commission;
    
    RETURN jsonb_build_object(
        'bid_amount', p_bid_amount,
        'shipper_commission', v_shipper_commission,
        'driver_commission', v_driver_commission,
        'total_paid_by_shipper', v_total_paid,
        'driver_payout', v_driver_payout,
        'platform_commission', v_platform_commission,
        'commission_rate', p_commission_rate
    );
END;
$$;


--
-- TOC entry 5996 (class 0 OID 0)
-- Dependencies: 1430
-- Name: FUNCTION calculate_payment_amounts(p_bid_amount numeric, p_commission_rate numeric); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.calculate_payment_amounts(p_bid_amount numeric, p_commission_rate numeric) IS 'Calculates all payment amounts for a given bid amount with 5% commission rate';


--
-- TOC entry 1414 (class 1255 OID 361967)
-- Name: calculate_tracking_point_metrics(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.calculate_tracking_point_metrics() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
DECLARE
    prev_point RECORD;
    distance_m double precision;
    duration_s integer;
BEGIN
    -- Get the previous tracking point for this tracking session
    SELECT latitude, longitude, timestamp
    INTO prev_point
    FROM public.tracking_points 
    WHERE tracking_id = NEW.tracking_id 
      AND timestamp < NEW.timestamp
    ORDER BY timestamp DESC 
    LIMIT 1;
    
    IF prev_point IS NOT NULL THEN
        -- Calculate distance using PostGIS (in meters)
        distance_m := ST_Distance(
            ST_SetSRID(ST_MakePoint(prev_point.longitude, prev_point.latitude), 4326)::geography,
            ST_SetSRID(ST_MakePoint(NEW.longitude, NEW.latitude), 4326)::geography
        );
        
        -- Convert distance to kilometers
        NEW.distance_from_previous := distance_m / 1000.0;
        
        -- Calculate duration in seconds
        NEW.duration_from_previous := EXTRACT(EPOCH FROM (NEW.timestamp - prev_point.timestamp));
    END IF;
    
    -- Set the PostGIS geometry point
    NEW.location := ST_SetSRID(ST_MakePoint(NEW.longitude, NEW.latitude), 4326);
    
    RETURN NEW;
END;
$$;


--
-- TOC entry 1360 (class 1255 OID 237338)
-- Name: check_realtime_config(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.check_realtime_config() RETURNS json
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_realtime_enabled BOOLEAN;
  v_rls_enabled BOOLEAN;
  v_policy_count INTEGER;
  v_result JSON;
BEGIN
  -- Check if notifications table is in realtime publication
  SELECT EXISTS (
    SELECT 1 FROM pg_publication_tables 
    WHERE pubname = 'supabase_realtime' 
    AND tablename = 'notifications'
  ) INTO v_realtime_enabled;
  
  -- Check if RLS is enabled
  SELECT c.relrowsecurity 
  FROM pg_class c 
  JOIN pg_namespace n ON n.oid = c.relnamespace 
  WHERE n.nspname = 'public' 
  AND c.relname = 'notifications'
  INTO v_rls_enabled;
  
  -- Count policies
  SELECT COUNT(*) 
  FROM pg_policies 
  WHERE tablename = 'notifications'
  INTO v_policy_count;
  
  -- Build result
  SELECT json_build_object(
    'realtime_enabled', v_realtime_enabled,
    'rls_enabled', v_rls_enabled,
    'policy_count', v_policy_count,
    'recommendation', CASE 
      WHEN NOT v_realtime_enabled THEN 'Run: ALTER PUBLICATION supabase_realtime ADD TABLE notifications;'
      WHEN v_policy_count = 0 THEN 'Add RLS policies for notifications table'
      ELSE 'Configuration looks good'
    END,
    'timestamp', NOW()
  ) INTO v_result;
  
  RETURN v_result;
END;
$$;


--
-- TOC entry 1439 (class 1255 OID 280764)
-- Name: check_recent_sms_results(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.check_recent_sms_results() RETURNS TABLE(request_id bigint, status_code integer, error_msg text, content text, created_at timestamp with time zone, success boolean)
    LANGUAGE sql SECURITY DEFINER
    AS $$
    SELECT 
        id as request_id,
        status_code,
        error_msg,
        content,
        created,
        CASE 
            WHEN status_code = 200 AND error_msg IS NULL THEN true
            ELSE false
        END as success
    FROM net._http_response 
    WHERE created >= NOW() - INTERVAL '1 hour'
    ORDER BY created DESC;
$$;


--
-- TOC entry 1465 (class 1255 OID 489243)
-- Name: check_stale_tracking_sessions(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.check_stale_tracking_sessions() RETURNS TABLE(session_id uuid, driver_id uuid, driver_name text, shipment_ids uuid[], shipper_ids uuid[], minutes_since_update integer)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    dts.id AS session_id,
    dts.driver_id,
    u.name AS driver_name,
    ARRAY_AGG(DISTINCT dship.shipment_id) FILTER (WHERE dship.shipment_id IS NOT NULL) AS shipment_ids,
    ARRAY_AGG(DISTINCT fp.shipper_id) FILTER (WHERE fp.shipper_id IS NOT NULL) AS shipper_ids,
    EXTRACT(EPOCH FROM (NOW() - dts.last_location_update))::INTEGER / 60 AS minutes_since_update
  FROM driver_tracking_sessions dts
  INNER JOIN users u ON u.id = dts.driver_id
  LEFT JOIN driver_tracking_shipments dship
    ON dship.driver_tracking_id = dts.id
    AND dship.removed_at IS NULL
  LEFT JOIN freight_posts fp
    ON fp.id = dship.shipment_id
  WHERE dts.status = 'active'
    AND dts.last_location_update < (NOW() - INTERVAL '10 minutes')
  GROUP BY dts.id, dts.driver_id, u.name, dts.last_location_update;
END;
$$;


--
-- TOC entry 5997 (class 0 OID 0)
-- Dependencies: 1465
-- Name: FUNCTION check_stale_tracking_sessions(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.check_stale_tracking_sessions() IS 'Finds active driver tracking sessions with no location update in last 10 minutes. Used by server-side health monitor to detect when foreground service has been killed.';


--
-- TOC entry 420 (class 1255 OID 423790)
-- Name: cleanup_expired_route_cache(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.cleanup_expired_route_cache() RETURNS integer
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  deleted_count INTEGER;
BEGIN
  DELETE FROM route_cache WHERE expires_at < NOW();
  GET DIAGNOSTICS deleted_count = ROW_COUNT;
  RETURN deleted_count;
END;
$$;


--
-- TOC entry 5998 (class 0 OID 0)
-- Dependencies: 420
-- Name: FUNCTION cleanup_expired_route_cache(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.cleanup_expired_route_cache() IS 'Deletes expired route cache entries. Returns number of deleted rows.';


--
-- TOC entry 1416 (class 1255 OID 361981)
-- Name: cleanup_old_tracking_points(uuid, integer, boolean); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.cleanup_old_tracking_points(p_tracking_id uuid, p_keep_days integer DEFAULT 30, p_keep_milestones boolean DEFAULT true) RETURNS integer
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
    deleted_count integer;
BEGIN
    IF p_keep_milestones THEN
        -- Delete old tracking points but keep milestones
        DELETE FROM public.tracking_points 
        WHERE tracking_id = p_tracking_id 
          AND created_at < (now() - (p_keep_days || ' days')::interval)
          AND type = 'tracking'::public.tracking_point_type;
    ELSE
        -- Delete all old tracking points
        DELETE FROM public.tracking_points 
        WHERE tracking_id = p_tracking_id 
          AND created_at < (now() - (p_keep_days || ' days')::interval);
    END IF;
    
    GET DIAGNOSTICS deleted_count = ROW_COUNT;
    RETURN deleted_count;
END;
$$;


--
-- TOC entry 1464 (class 1255 OID 486911)
-- Name: complete_driver_tracking_if_no_shipments(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.complete_driver_tracking_if_no_shipments(p_driver_id uuid) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_active_session_id UUID;
  v_active_shipment_count INTEGER;
BEGIN
  SELECT id INTO v_active_session_id
  FROM driver_tracking_sessions
  WHERE driver_id = p_driver_id AND status = 'active'
  LIMIT 1;

  IF v_active_session_id IS NULL THEN
    RETURN;
  END IF;

  SELECT COUNT(*) INTO v_active_shipment_count
  FROM driver_tracking_shipments
  WHERE driver_tracking_id = v_active_session_id AND removed_at IS NULL;

  IF v_active_shipment_count = 0 THEN
    UPDATE driver_tracking_sessions
    SET status = 'completed', completed_at = NOW(), updated_at = NOW()
    WHERE id = v_active_session_id;

    RAISE NOTICE 'Driver tracking session % completed', v_active_session_id;
  END IF;
END;
$$;


--
-- TOC entry 1435 (class 1255 OID 385784)
-- Name: confirm_shipment_pickup(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.confirm_shipment_pickup(p_shipment_id uuid) RETURNS jsonb
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
    v_driver_id UUID;
    v_description TEXT;
    v_pickup_pin TEXT;
    v_shipper_name TEXT;
    v_freight_type public.freight_type;
    v_new_status public.freight_status;
BEGIN
    -- Get shipment details including freight_type
    SELECT 
        fp.description,
        fp.pickup_pin,
        fp.freight_type,
        CONCAT(u.first_name, ' ', u.last_name)
    INTO 
        v_description,
        v_pickup_pin,
        v_freight_type,
        v_shipper_name
    FROM public.freight_posts fp
    JOIN public.users u ON fp.shipper_id = u.id
    WHERE fp.id = p_shipment_id;
    
    -- Check if shipment exists
    IF v_description IS NULL THEN
        RETURN jsonb_build_object(
            'success', false,
            'error', 'Shipment not found'
        );
    END IF;
    
    -- Get driver from accepted bid
    SELECT v.driver_id
    INTO v_driver_id
    FROM public.bids b
    JOIN public.vehicles v ON b.vehicle_id = v.id
    WHERE b.freight_post_id = p_shipment_id
    AND b.status = 'Accepted'
    LIMIT 1;
    
    -- Check if driver exists
    IF v_driver_id IS NULL THEN
        RETURN jsonb_build_object(
            'success', false,
            'error', 'No accepted bid found for this shipment'
        );
    END IF;
    
    -- Determine new status based on freight_type
    IF v_freight_type = 'rubble' THEN
        v_new_status := 'Delivered';  -- Skip OnRoute for rubble
        RAISE NOTICE 'Rubble shipment %: Setting status to Delivered', p_shipment_id;
    ELSE
        v_new_status := 'Pickup';  -- Stay at Pickup for non-rubble
        RAISE NOTICE 'Non-rubble shipment %: Keeping status at Pickup', p_shipment_id;
    END IF;
    
    -- Update shipment status and record pickup confirmation
    UPDATE public.freight_posts
    SET 
        status = v_new_status,
        pickup_confirmed_at = NOW(),
        updated_at = NOW()
    WHERE id = p_shipment_id;
    
    -- Send notification to driver with pickup PIN
    PERFORM send_notification_with_preferences(
        v_driver_id,
        'pickup_confirmed',
        'Pickup confirmed for "' || v_description || '" by ' || v_shipper_name || 
        '. Pickup PIN: ' || v_pickup_pin || 
        '. Enter this PIN in "My Loads" when ready to start delivery.',
        p_shipment_id
    );
    
    -- Return success with details
    RETURN jsonb_build_object(
        'success', true,
        'shipment_id', p_shipment_id,
        'driver_id', v_driver_id,
        'pickup_pin', v_pickup_pin,
        'new_status', v_new_status::text,
        'is_rubble', (v_freight_type = 'rubble'),
        'message', 'Pickup confirmed and driver notified'
    );
    
EXCEPTION WHEN OTHERS THEN
    -- Log error
    RAISE WARNING 'Error in confirm_shipment_pickup: %', SQLERRM;
    
    -- Return error
    RETURN jsonb_build_object(
        'success', false,
        'error', SQLERRM
    );
END;
$$;


--
-- TOC entry 5999 (class 0 OID 0)
-- Dependencies: 1435
-- Name: FUNCTION confirm_shipment_pickup(p_shipment_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.confirm_shipment_pickup(p_shipment_id uuid) IS 'Confirms pickup and sends PIN notification to driver. Called when shipper clicks "Confirm Pickup" button.';


--
-- TOC entry 1483 (class 1255 OID 522130)
-- Name: create_default_admin_notification_preferences(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.create_default_admin_notification_preferences(p_user_id uuid) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
    INSERT INTO notification_type_preferences (user_id, notification_type, push_enabled, sms_enabled)
    VALUES
        -- Dispute events - push enabled by default
        (p_user_id, 'dispute_filed', true, false),
        (p_user_id, 'dispute_escalated', true, true),
        (p_user_id, 'dispute_resolved', true, false),
        -- Driver events - push enabled by default
        (p_user_id, 'driver_pending_approval', true, false),
        (p_user_id, 'driver_document_uploaded', true, false),
        (p_user_id, 'driver_suspended', true, true),
        -- Payment events - push enabled by default
        (p_user_id, 'payment_failed', true, true),
        (p_user_id, 'payment_refund_requested', true, false),
        -- System events
        (p_user_id, 'admin_system_alert', true, true)
    ON CONFLICT (user_id, notification_type) DO NOTHING;
END;
$$;


--
-- TOC entry 1442 (class 1255 OID 278654)
-- Name: create_default_notification_preferences(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.create_default_notification_preferences(p_user_id uuid) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$BEGIN
    INSERT INTO notification_type_preferences (user_id, notification_type, push_enabled, sms_enabled)
    VALUES 
        -- Critical notifications - SMS enabled by default
        (p_user_id, 'bid_accepted', true, false),
        (p_user_id, 'payment_received', true, false),
        (p_user_id, 'delivery_completed', true, false),
        
        -- Important notifications - Push only by default (user can opt-in to SMS)
        (p_user_id, 'bid_rejected', true, false),
        (p_user_id, 'delivery_started', true, false),
        (p_user_id, 'pickup_confirmed', true, false),
        (p_user_id, 'new_bid', true, false),
        (p_user_id, 'outbid', true, false),
        (p_user_id, 'bid_updated', true, false),
        
        -- Informational notifications - Push only
        (p_user_id, 'rated', true, false),
        (p_user_id, 'driver_registered', true, false),
        (p_user_id, 'new_shipment', true, false),
        (p_user_id, 'profile_updated', true, false),
        (p_user_id, 'vehicle_added', true, false),
        (p_user_id, 'upcoming_job', true, false),
        (p_user_id, 'shipment_cancelled', true, false),
        (p_user_id, 'bid_cancelled', true, false),
        (p_user_id, 'general', true, false)
    ON CONFLICT (user_id, notification_type) DO NOTHING;
END;$$;


--
-- TOC entry 1406 (class 1255 OID 259206)
-- Name: create_freight_post_with_geometry(uuid, text, text, double precision, double precision, double precision, double precision, text, text, text, text, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.create_freight_post_with_geometry(p_shipper_id uuid, p_description text, p_status text, p_pickup_lat double precision, p_pickup_lng double precision, p_dropoff_lat double precision, p_dropoff_lng double precision, p_delivery_time_window text, p_currency text, p_notes text, p_pickup_location_name text, p_dropoff_location_name text) RETURNS TABLE(id uuid)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
    RETURN QUERY
    INSERT INTO public.freight_posts (
        shipper_id, description, status,
        pickup_location, dropoff_location,
        delivery_time_window, rated, archived,
        currency, notes, pickup_location_name, dropoff_location_name
    ) VALUES (
        p_shipper_id, p_description, p_status::public.freight_status,
        ST_SetSRID(ST_MakePoint(p_pickup_lng, p_pickup_lat), 4326),
        ST_SetSRID(ST_MakePoint(p_dropoff_lng, p_dropoff_lat), 4326),
        p_delivery_time_window::tstzrange, false, false,
        p_currency, p_notes, p_pickup_location_name, p_dropoff_location_name
    )
    RETURNING freight_posts.id;
END;
$$;


--
-- TOC entry 1424 (class 1255 OID 420032)
-- Name: create_freight_post_with_items_atomic(uuid, text, text, double precision, double precision, double precision, double precision, text, text, text, text, text, jsonb); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.create_freight_post_with_items_atomic(p_shipper_id uuid, p_description text, p_status text, p_pickup_lat double precision, p_pickup_lng double precision, p_dropoff_lat double precision, p_dropoff_lng double precision, p_delivery_time_window text, p_currency text, p_notes text, p_pickup_location_name text, p_dropoff_location_name text, p_items jsonb DEFAULT '[]'::jsonb) RETURNS TABLE(id uuid)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
    v_freight_post_id UUID;
    v_item JSONB;
BEGIN
    -- Insert freight_post first
    INSERT INTO public.freight_posts (
        shipper_id,
        description,
        status,
        pickup_location,
        dropoff_location,
        delivery_time_window,
        rated,
        archived,
        currency,
        notes,
        pickup_location_name,
        dropoff_location_name
    ) VALUES (
        p_shipper_id,
        p_description,
        p_status::public.freight_status,
        ST_SetSRID(ST_MakePoint(p_pickup_lng, p_pickup_lat), 4326),
        ST_SetSRID(ST_MakePoint(p_dropoff_lng, p_dropoff_lat), 4326),
        p_delivery_time_window::tstzrange,
        false,
        false,
        p_currency,
        p_notes,
        p_pickup_location_name,
        p_dropoff_location_name
    )
    RETURNING freight_posts.id INTO v_freight_post_id;

    -- Insert all freight_items in the same transaction
    IF jsonb_array_length(p_items) > 0 THEN
        FOR v_item IN SELECT * FROM jsonb_array_elements(p_items)
        LOOP
            INSERT INTO public.freight_items (
                freight_post_id,
                weight_kg,
                length_cm,
                width_cm,
                height_cm,
                volume_cm3,
                photo_url
            ) VALUES (
                v_freight_post_id,
                (v_item->>'weight_kg')::DOUBLE PRECISION,
                (v_item->>'length_cm')::DOUBLE PRECISION,
                (v_item->>'width_cm')::DOUBLE PRECISION,
                (v_item->>'height_cm')::DOUBLE PRECISION,
                (v_item->>'volume_cm3')::DOUBLE PRECISION,
                v_item->>'photo_url'
            );
        END LOOP;
    END IF;

    -- Return the freight_post ID
    RETURN QUERY SELECT v_freight_post_id;
END;
$$;


--
-- TOC entry 6000 (class 0 OID 0)
-- Dependencies: 1424
-- Name: FUNCTION create_freight_post_with_items_atomic(p_shipper_id uuid, p_description text, p_status text, p_pickup_lat double precision, p_pickup_lng double precision, p_dropoff_lat double precision, p_dropoff_lng double precision, p_delivery_time_window text, p_currency text, p_notes text, p_pickup_location_name text, p_dropoff_location_name text, p_items jsonb); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.create_freight_post_with_items_atomic(p_shipper_id uuid, p_description text, p_status text, p_pickup_lat double precision, p_pickup_lng double precision, p_dropoff_lat double precision, p_dropoff_lng double precision, p_delivery_time_window text, p_currency text, p_notes text, p_pickup_location_name text, p_dropoff_location_name text, p_items jsonb) IS 'Atomically creates a freight_post with its items in a single transaction. Eliminates race condition where realtime fires before items are inserted.';


--
-- TOC entry 1486 (class 1255 OID 433474)
-- Name: create_freight_post_with_items_atomic(uuid, text, text, double precision, double precision, double precision, double precision, text, text, text, text, text, jsonb, uuid, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.create_freight_post_with_items_atomic(p_shipper_id uuid, p_description text, p_status text, p_pickup_lat double precision, p_pickup_lng double precision, p_dropoff_lat double precision, p_dropoff_lng double precision, p_delivery_time_window text, p_currency text, p_notes text, p_pickup_location_name text, p_dropoff_location_name text, p_items jsonb DEFAULT '[]'::jsonb, p_freight_post_id uuid DEFAULT NULL::uuid, p_freight_type text DEFAULT 'items'::text) RETURNS TABLE(id uuid)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
    v_freight_post_id UUID;
    v_item JSONB;
BEGIN
    -- Use provided ID or generate new one
    v_freight_post_id := COALESCE(p_freight_post_id, gen_random_uuid());

    -- Insert freight_post with specified or generated ID
    INSERT INTO public.freight_posts (
        id,
        shipper_id,
        description,
        status,
        pickup_location,
        dropoff_location,
        delivery_time_window,
        rated,
        archived,
        currency,
        notes,
        pickup_location_name,
        dropoff_location_name,
        freight_type  -- NEW: Include freight_type
    ) VALUES (
        v_freight_post_id,
        p_shipper_id,
        p_description,
        p_status::public.freight_status,
        ST_SetSRID(ST_MakePoint(p_pickup_lng, p_pickup_lat), 4326),
        ST_SetSRID(ST_MakePoint(p_dropoff_lng, p_dropoff_lat), 4326),
        p_delivery_time_window::tstzrange,
        false,
        false,
        p_currency,
        p_notes,
        p_pickup_location_name,
        p_dropoff_location_name,
        p_freight_type::public.freight_type  -- NEW: Cast to freight_type enum
    );

    -- Insert all freight_items in the same transaction
    IF jsonb_array_length(p_items) > 0 THEN
        FOR v_item IN SELECT * FROM jsonb_array_elements(p_items)
        LOOP
            INSERT INTO public.freight_items (
                freight_post_id,
                weight_kg,
                length_cm,
                width_cm,
                height_cm,
                photo_url
            ) VALUES (
                v_freight_post_id,
                (v_item->>'weight_kg')::DOUBLE PRECISION,
                (v_item->>'length_cm')::DOUBLE PRECISION,
                (v_item->>'width_cm')::DOUBLE PRECISION,
                (v_item->>'height_cm')::DOUBLE PRECISION,
                v_item->>'photo_url'
            );
        END LOOP;
    END IF;

    -- Return the freight_post ID
    RETURN QUERY SELECT v_freight_post_id;
END;
$$;


--
-- TOC entry 6001 (class 0 OID 0)
-- Dependencies: 1486
-- Name: FUNCTION create_freight_post_with_items_atomic(p_shipper_id uuid, p_description text, p_status text, p_pickup_lat double precision, p_pickup_lng double precision, p_dropoff_lat double precision, p_dropoff_lng double precision, p_delivery_time_window text, p_currency text, p_notes text, p_pickup_location_name text, p_dropoff_location_name text, p_items jsonb, p_freight_post_id uuid, p_freight_type text); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.create_freight_post_with_items_atomic(p_shipper_id uuid, p_description text, p_status text, p_pickup_lat double precision, p_pickup_lng double precision, p_dropoff_lat double precision, p_dropoff_lng double precision, p_delivery_time_window text, p_currency text, p_notes text, p_pickup_location_name text, p_dropoff_location_name text, p_items jsonb, p_freight_post_id uuid, p_freight_type text) IS 'Atomically creates a freight_post with its items and freight type in a single transaction.';


--
-- TOC entry 720 (class 1255 OID 94162)
-- Name: debug_get_bidding_shipments(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.debug_get_bidding_shipments(p_user_id uuid) RETURNS TABLE(shipment_count bigint, user_vehicles_count bigint, user_bids_count bigint, bidding_count bigint, non_user_shipments_count bigint, non_user_bid_count bigint, final_result_count bigint)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
    total_shipments bigint;
    user_vehicles_count bigint;
    user_bids_count bigint;
    bidding_shipments bigint;
    non_user_shipments bigint;
    non_bid_shipments bigint;
    final_shipments bigint;
BEGIN
    -- Count total shipments
    SELECT COUNT(*) INTO total_shipments FROM public.freight_posts;
    
    -- Count user vehicles
    SELECT COUNT(*) INTO user_vehicles_count 
    FROM public.vehicles 
    WHERE driver_id = p_user_id;
    
    -- Count user bids
    WITH user_vehicles AS (
        SELECT id FROM public.vehicles WHERE driver_id = p_user_id
    )
    SELECT COUNT(DISTINCT freight_post_id) INTO user_bids_count 
    FROM public.bids
    WHERE vehicle_id IN (SELECT id FROM user_vehicles);
    
    -- Count shipments with bidding status
    SELECT COUNT(*) INTO bidding_shipments 
    FROM public.freight_posts 
    WHERE status = 'Bidding' AND archived = false;
    
    -- Count shipments not created by user
    SELECT COUNT(*) INTO non_user_shipments 
    FROM public.freight_posts 
    WHERE shipper_id != p_user_id 
      AND status = 'Bidding' 
      AND archived = false;
    
    -- Count shipments the user hasn't bid on
    WITH user_vehicles AS (
        SELECT id FROM public.vehicles WHERE driver_id = p_user_id
    ),
    user_bids AS (
        SELECT DISTINCT freight_post_id 
        FROM public.bids
        WHERE vehicle_id IN (SELECT id FROM user_vehicles)
    )
    SELECT COUNT(*) INTO non_bid_shipments 
    FROM public.freight_posts fp
    WHERE fp.status = 'Bidding' 
      AND fp.archived = false
      AND fp.shipper_id != p_user_id
      AND fp.id NOT IN (SELECT freight_post_id FROM user_bids);
    
    -- Count final result
    WITH user_vehicles AS (
        SELECT id FROM public.vehicles WHERE driver_id = p_user_id
    ),
    user_bids AS (
        SELECT DISTINCT freight_post_id 
        FROM public.bids
        WHERE vehicle_id IN (SELECT id FROM user_vehicles)
    )
    SELECT COUNT(*) INTO final_shipments 
    FROM public.freight_posts fp
    WHERE fp.status = 'Bidding' 
      AND fp.archived = false
      AND fp.shipper_id != p_user_id
      AND fp.id NOT IN (SELECT freight_post_id FROM user_bids);
    
    -- Return results
    RETURN QUERY SELECT 
        total_shipments, 
        user_vehicles_count, 
        user_bids_count, 
        bidding_shipments, 
        non_user_shipments, 
        non_bid_shipments, 
        final_shipments;
END;
$$;


--
-- TOC entry 6002 (class 0 OID 0)
-- Dependencies: 720
-- Name: FUNCTION debug_get_bidding_shipments(p_user_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.debug_get_bidding_shipments(p_user_id uuid) IS 'Debug information for bidding shipments query';


--
-- TOC entry 709 (class 1255 OID 247536)
-- Name: diagnose_realtime_notifications(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.diagnose_realtime_notifications() RETURNS json
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  result JSON;
  user_id_val UUID;
BEGIN
  -- Get current user ID
  user_id_val := auth.uid();
  
  SELECT json_build_object(
    'current_user_id', user_id_val,
    'rls_enabled', (
      SELECT rowsecurity 
      FROM pg_tables 
      WHERE tablename = 'notifications' AND schemaname = 'public'
    ),
    'realtime_publication_enabled', (
      SELECT COUNT(*) > 0
      FROM pg_publication_tables 
      WHERE pubname = 'supabase_realtime' AND tablename = 'notifications'
    ),
    'total_policies', (
      SELECT COUNT(*)
      FROM pg_policies 
      WHERE tablename = 'notifications'
    ),
    'service_role_policies', (
      SELECT COUNT(*)
      FROM pg_policies 
      WHERE tablename = 'notifications' AND 'service_role' = ANY(roles)
    ),
    'user_notification_count', (
      SELECT COUNT(*)
      FROM public.notifications
      WHERE user_id = user_id_val
    ),
    'recent_notifications', (
      SELECT COALESCE(json_agg(
        json_build_object(
          'id', id,
          'message', message,
          'created_at', created_at,
          'is_read', is_read,
          'type', type
        ) ORDER BY created_at DESC
      ), '[]'::json)
      FROM (
        SELECT id, message, created_at, is_read, type
        FROM public.notifications
        WHERE user_id = user_id_val
        ORDER BY created_at DESC
        LIMIT 3
      ) recent
    ),
    'policy_details', (
      SELECT json_agg(
        json_build_object(
          'name', policyname,
          'command', cmd,
          'roles', roles,
          'using_expression', qual
        )
      )
      FROM pg_policies 
      WHERE tablename = 'notifications'
    )
  ) INTO result;
  
  RETURN result;
END;
$$;


--
-- TOC entry 1451 (class 1255 OID 373672)
-- Name: find_nearby_tracking_points(double precision, double precision, double precision, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.find_nearby_tracking_points(p_lat double precision, p_lng double precision, p_radius_meters double precision DEFAULT 1000.0, p_limit integer DEFAULT 20) RETURNS TABLE(point_id text, point_tracking_id text, point_latitude double precision, point_longitude double precision, point_type text, point_timestamp timestamp with time zone, distance_meters double precision)
    LANGUAGE plpgsql
    AS $$
BEGIN
    RETURN QUERY
    SELECT 
        tp.id::text AS point_id,
        tp.tracking_id::text AS point_tracking_id,
        tp.latitude AS point_latitude,
        tp.longitude AS point_longitude,
        tp.type::text AS point_type,
        tp."timestamp" AS point_timestamp,
        ST_Distance(
            ST_SetSRID(ST_MakePoint(p_lng, p_lat), 4326)::geography,
            tp.location::geography
        ) AS distance_meters
    FROM tracking_points tp
    WHERE ST_DWithin(
        ST_SetSRID(ST_MakePoint(p_lng, p_lat), 4326)::geography,
        tp.location::geography,
        p_radius_meters
    )
    ORDER BY distance_meters ASC
    LIMIT p_limit;
END;
$$;


--
-- TOC entry 6003 (class 0 OID 0)
-- Dependencies: 1451
-- Name: FUNCTION find_nearby_tracking_points(p_lat double precision, p_lng double precision, p_radius_meters double precision, p_limit integer); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.find_nearby_tracking_points(p_lat double precision, p_lng double precision, p_radius_meters double precision, p_limit integer) IS 'Find tracking points within radius using spatial index - ultra-fast proximity queries';


--
-- TOC entry 1444 (class 1255 OID 478523)
-- Name: get_accepted_bid_for_shipment(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_accepted_bid_for_shipment(p_freight_post_id uuid) RETURNS jsonb
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
  DECLARE
    result jsonb;
  BEGIN
    SELECT jsonb_build_object(
      'bid_id', b.id::text,
      'freight_post_id', b.freight_post_id::text,
      'vehicle_id', b.vehicle_id::text,
      'bid_amount', b.bid_amount,
      'delivery_date', b.delivery_date,
      'pickup_date', b.pickup_date,
      'status', b.status,
      'created_at', b.created_at,
      'modified_at', b.modified_at,
      'notes', b.notes,
      'driver_id', v.driver_id::text,
      'vehicle', jsonb_build_object(
        'id', v.id::text,
        'driver_id', v.driver_id::text,
        'type', v.type,
        'make', v.make,
        'model', v.model,
        'year', v.year,
        'license_plate', v.license_plate,
        'capacity_tons', v.capacity_tons,
        'photo_url', v.photo_url,
        'color', v.color,
        'created_at', v.created_at
      ),
      'driver', jsonb_build_object(
        'id', u.id::text,
        'first_name', u.first_name,
        'last_name', u.last_name,
        'phone_number', u.phone_number,
        'profile_photo_url', u.profile_photo_url,
        'average_rating', COALESCE(
          (SELECT AVG(score) FROM ratings WHERE rated_user_id = u.id),
          0.0
        ),
        'completed_deliveries', COALESCE(
          (SELECT COUNT(*)
           FROM payments p
           JOIN bids b2 ON p.bid_id = b2.id
           JOIN vehicles v2 ON b2.vehicle_id = v2.id
           WHERE v2.driver_id = u.id
           AND p.status = 'completed'),
          0
        )
      )
    )
    INTO result
    FROM bids b
    LEFT JOIN vehicles v ON b.vehicle_id = v.id
    LEFT JOIN users u ON v.driver_id = u.id
    WHERE b.freight_post_id = p_freight_post_id
      AND b.status = 'Accepted'
    LIMIT 1;

    RETURN result;
  END;
  $$;


--
-- TOC entry 6004 (class 0 OID 0)
-- Dependencies: 1444
-- Name: FUNCTION get_accepted_bid_for_shipment(p_freight_post_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_accepted_bid_for_shipment(p_freight_post_id uuid) IS 'Returns the accepted bid with complete vehicle and driver details for a shipment. Used by pickup screen.';


--
-- TOC entry 1449 (class 1255 OID 479872)
-- Name: get_active_driver_tracking(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_active_driver_tracking(p_driver_id uuid) RETURNS TABLE(id uuid, driver_id uuid, status text, started_at timestamp with time zone, completed_at timestamp with time zone, paused_at timestamp with time zone, current_latitude double precision, current_longitude double precision, current_speed double precision, current_heading double precision, last_location_update timestamp with time zone, total_points integer, distance_traveled double precision, update_interval_seconds integer, min_distance_filter double precision, active_shipment_ids uuid[])
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    dts.id,
    dts.driver_id,
    dts.status,
    dts.started_at,
    dts.completed_at,
    dts.paused_at,
    dts.current_latitude,
    dts.current_longitude,
    dts.current_speed,
    dts.current_heading,
    dts.last_location_update,
    dts.total_points,
    dts.distance_traveled,
    dts.update_interval_seconds,
    dts.min_distance_filter,
    COALESCE(
      ARRAY_AGG(ts.shipment_id ORDER BY ts.added_at) FILTER (WHERE ts.removed_at IS NULL),
      ARRAY[]::UUID[]
    ) as active_shipment_ids
  FROM driver_tracking_sessions dts
  LEFT JOIN driver_tracking_shipments ts ON ts.driver_tracking_id = dts.id
  WHERE dts.driver_id = p_driver_id
    AND dts.status = 'active'
  GROUP BY dts.id
  LIMIT 1;
END;
$$;


--
-- TOC entry 6005 (class 0 OID 0)
-- Dependencies: 1449
-- Name: FUNCTION get_active_driver_tracking(p_driver_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_active_driver_tracking(p_driver_id uuid) IS 'Returns active tracking session for a driver with active shipment IDs';


--
-- TOC entry 1415 (class 1255 OID 361980)
-- Name: get_active_tracking_by_shipment(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_active_tracking_by_shipment(p_shipment_id uuid) RETURNS TABLE(id uuid, driver_id uuid, driver_name text, status public.tracking_status, current_latitude double precision, current_longitude double precision, last_location_update timestamp with time zone)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
    RETURN QUERY
    SELECT 
        ts.id,
        ts.driver_id,
        ts.driver_name,
        ts.status,
        ts.current_latitude,
        ts.current_longitude,
        ts.last_location_update
    FROM public.tracking_sessions ts
    WHERE ts.shipment_id = p_shipment_id 
      AND ts.status = 'active'::public.tracking_status
    ORDER BY ts.started_at DESC
    LIMIT 1;
END;
$$;


--
-- TOC entry 448 (class 1255 OID 92838)
-- Name: get_bidding_shipments(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_bidding_shipments(p_user_id uuid) RETURNS SETOF json
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
    RETURN QUERY
    WITH user_bids AS (
        SELECT DISTINCT b.freight_post_id
        FROM public.bids b
        JOIN public.vehicles v ON b.vehicle_id = v.id
        WHERE v.driver_id = p_user_id
    ),
    eligible_shipments AS (
        SELECT 
            fp.id,
            fp.shipper_id,
            fp.description,
            fp.pickup_location,
            fp.dropoff_location,
            fp.pickup_location_name,
            fp.dropoff_location_name,
            fp.delivery_time_window,
            fp.status,
            fp.created_at,
            fp.updated_at,
            fp.rated,
            fp.archived,
            fp.archived_at,
            fp.currency,
            fp.notes
        FROM public.freight_posts fp
        WHERE fp.status = 'Bidding'
            AND fp.archived = false
            AND fp.id NOT IN (SELECT freight_post_id FROM user_bids WHERE freight_post_id IS NOT NULL)
    ),
    bid_info AS (
        SELECT 
            b.freight_post_id,
            COUNT(b.id) AS num_bids,
            MIN(b.bid_amount) AS low_bid
        FROM public.bids b
        WHERE b.freight_post_id IN (SELECT id FROM eligible_shipments)
        GROUP BY b.freight_post_id
    ),
    freight_items AS (
        SELECT 
            fi.freight_post_id,
            jsonb_agg(
                jsonb_build_object(
                    'id', fi.id,
                    'weight_kg', fi.weight_kg,
                    'length_cm', fi.length_cm,
                    'width_cm', fi.width_cm,
                    'height_cm', fi.height_cm,
                    'volume_cm3', fi.volume_cm3,
                    'photo_url', fi.photo_url
                )
            ) AS items
        FROM public.freight_items fi
        WHERE fi.freight_post_id IN (SELECT id FROM eligible_shipments)
        GROUP BY fi.freight_post_id
    )
    SELECT 
        json_build_object(
            'id', es.id,
            'shipper_id', es.shipper_id,
            'description', es.description,
            'pickup_location', ST_AsGeoJSON(es.pickup_location)::json,
            'dropoff_location', ST_AsGeoJSON(es.dropoff_location)::json,
            'pickup_location_name', es.pickup_location_name,
            'dropoff_location_name', es.dropoff_location_name,
            'delivery_time_window', es.delivery_time_window,
            'status', es.status,
            'created_at', es.created_at,
            'updated_at', es.updated_at,
            'rated', es.rated,
            'archived', es.archived,
            'archived_at', es.archived_at,
            'currency', es.currency,
            'notes', es.notes,
            'freight_items', COALESCE(fi.items, '[]'::jsonb),
            'bid_info', json_build_object(
                'num_bids', COALESCE(bi.num_bids, 0),
                'low_bid', bi.low_bid
            )
        )
    FROM eligible_shipments es
    LEFT JOIN bid_info bi ON es.id = bi.freight_post_id
    LEFT JOIN freight_items fi ON es.id = fi.freight_post_id;
END;
$$;


--
-- TOC entry 6006 (class 0 OID 0)
-- Dependencies: 448
-- Name: FUNCTION get_bidding_shipments(p_user_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_bidding_shipments(p_user_id uuid) IS 'Get all bidding shipments that the current user has not bid on and did not create, with correct bid information';


--
-- TOC entry 1427 (class 1255 OID 431088)
-- Name: get_bidding_shipments_v2(uuid, double precision, double precision, numeric, text, integer, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_bidding_shipments_v2(p_user_id uuid, p_center_lat double precision, p_center_lng double precision, p_radius_km numeric, p_sort_by text DEFAULT 'distance'::text, p_limit integer DEFAULT 25, p_offset integer DEFAULT 0) RETURNS jsonb
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_center_point geography;
  v_result jsonb;
BEGIN
  v_center_point := ST_SetSRID(ST_MakePoint(p_center_lng, p_center_lat), 4326)::geography;

  RETURN (
    WITH user_bids AS (
      SELECT DISTINCT b.freight_post_id
      FROM public.bids b
      JOIN public.vehicles v ON b.vehicle_id = v.id
      WHERE v.driver_id = p_user_id
        AND b.status IN ('Open', 'Accepted')  -- Already fixed
    ),
    available_shipments AS (
      SELECT
        fp.id,
        fp.description,
        fp.status,
        fp.delivery_time_window,
        fp.pickup_location,
        fp.dropoff_location,
        fp.pickup_location_name,
        fp.dropoff_location_name,
        fp.rated,
        fp.archived,
        fp.currency,
        fp.notes,
        fp.shipper_id,
        fp.created_at,
        fp.updated_at,
        fp.freight_type,
        NULL::integer AS rating_score,
        NULL::timestamp with time zone AS rated_at,
        ROUND(
          ST_Distance(
            fp.pickup_location::geography,
            v_center_point
          )::numeric / 1000,
          1
        ) AS distance_km,
        ROUND(
          EXTRACT(EPOCH FROM (lower(fp.delivery_time_window) - NOW()))::numeric / 3600,
          1
        ) AS urgency_hours,
        COUNT(*) OVER() AS total_count,
        (
          SELECT jsonb_agg(
            jsonb_build_object(
              'id', fi.id,
              'quantity', fi.quantity,
              'weight_kg', fi.weight_kg,
              'length_cm', fi.length_cm,
              'width_cm', fi.width_cm,
              'height_cm', fi.height_cm,
              'volume_cm3', fi.volume_cm3,
              'photo_url', fi.photo_url
            )
          )
          FROM freight_items fi
          WHERE fi.freight_post_id = fp.id
        ) AS freight_items,
        (
          SELECT jsonb_build_object(
            'id', fm.id,
            'property_type', fm.property_type,
            'has_store_room', fm.has_store_room,
            'has_outdoor_furniture', fm.has_outdoor_furniture,
            'truck_capacity_tons', fm.truck_capacity_tons,
            'additional_notes', fm.additional_notes,
            'created_at', fm.created_at
          )
          FROM freight_moving fm
          WHERE fm.freight_post_id = fp.id
        ) AS freight_moving,
        (
          SELECT jsonb_build_object(
            'id', fr.id,
            'waste_type', fr.waste_type,
            'estimated_volume_m3', fr.estimated_volume_m3,
            'photo_url', fr.photo_url,
            'additional_notes', fr.additional_notes,
            'created_at', fr.created_at
          )
          FROM freight_rubble fr
          WHERE fr.freight_post_id = fp.id
        ) AS freight_rubble,
        (
          SELECT jsonb_agg(
            jsonb_build_object(
              'id', fv.id,
              'vehicle_type', fv.vehicle_type,
              'running_condition', fv.running_condition,
              'photo_url', fv.photo_url,
              'additional_notes', fv.additional_notes,
              'created_at', fv.created_at
            )
          )
          FROM freight_vehicles fv
          WHERE fv.freight_post_id = fp.id
        ) AS freight_vehicles,
        --  FIX: Only count and calculate low_bid from Open bids
        jsonb_build_object(
          'num_bids', (SELECT COUNT(*) FROM bids WHERE freight_post_id = fp.id AND status = 'Open'),
          'low_bid', (SELECT MIN(bid_amount) FROM bids WHERE freight_post_id = fp.id AND status = 'Open')
        ) AS bid_info,
        (
          SELECT jsonb_build_object(
            'shipper_id', u.id,
            'shipper_first_name', u.first_name,
            'shipper_last_name', u.last_name,
            'shipper_phone', u.phone_number
          )
          FROM users u
          WHERE u.id = fp.shipper_id
        ) AS shipper_info
      FROM freight_posts fp
      WHERE
        fp.status = 'Bidding'
        AND fp.archived = false
        AND fp.shipper_id != p_user_id
        AND fp.id NOT IN (SELECT freight_post_id FROM user_bids WHERE freight_post_id IS NOT NULL)
        AND ST_DWithin(
          fp.pickup_location::geography,
          v_center_point,
          p_radius_km * 1000
        )
      ORDER BY
        CASE
          WHEN p_sort_by = 'distance' THEN
            ST_Distance(fp.pickup_location::geography, v_center_point)
        END ASC,
        CASE
          WHEN p_sort_by = 'urgency' THEN
            EXTRACT(EPOCH FROM (lower(fp.delivery_time_window) - NOW()))
        END ASC,
        CASE
          WHEN p_sort_by = 'date' THEN
            EXTRACT(EPOCH FROM fp.created_at)
        END DESC,
        fp.created_at DESC
      LIMIT p_limit
      OFFSET p_offset
    ),
    result_with_metadata AS (
      SELECT
        jsonb_build_object(
          'shipments', (
            SELECT jsonb_agg(
              row_to_json(available_shipments)::jsonb
              ORDER BY
                CASE
                  WHEN p_sort_by = 'distance' THEN distance_km
                END ASC,
                CASE
                  WHEN p_sort_by = 'urgency' THEN urgency_hours
                END ASC,
                created_at DESC
            )
            FROM available_shipments
          ),
          'total_count', COALESCE((SELECT total_count FROM available_shipments LIMIT 1), 0),
          'has_more', (
            COALESCE((SELECT total_count FROM available_shipments LIMIT 1), 0) > (p_offset + p_limit)
          ),
          'offset', p_offset,
          'limit', p_limit
        ) AS result
    )
    SELECT result FROM result_with_metadata
  );
END;
$$;


--
-- TOC entry 6007 (class 0 OID 0)
-- Dependencies: 1427
-- Name: FUNCTION get_bidding_shipments_v2(p_user_id uuid, p_center_lat double precision, p_center_lng double precision, p_radius_km numeric, p_sort_by text, p_limit integer, p_offset integer); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_bidding_shipments_v2(p_user_id uuid, p_center_lat double precision, p_center_lng double precision, p_radius_km numeric, p_sort_by text, p_limit integer, p_offset integer) IS 'Enhanced function to get bidding shipments with freight type support, PostGIS distance filtering, and type-specific data (items, moving, rubble, vehicles)';


--
-- TOC entry 1431 (class 1255 OID 445014)
-- Name: get_commission_balance(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_commission_balance() RETURNS numeric
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
    v_balance numeric;
BEGIN
    SELECT COALESCE(
        (SELECT running_balance 
         FROM public.commission_ledger 
         ORDER BY created_at DESC 
         LIMIT 1),
        0
    ) INTO v_balance;
    
    RETURN v_balance;
END;
$$;


--
-- TOC entry 6008 (class 0 OID 0)
-- Dependencies: 1431
-- Name: FUNCTION get_commission_balance(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_commission_balance() IS 'Returns the current platform commission balance';


--
-- TOC entry 548 (class 1255 OID 89270)
-- Name: get_completed_deliveries(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_completed_deliveries(p_driver_id uuid) RETURNS integer
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  delivery_count int;
BEGIN
  -- Get count of completed deliveries for the user
  SELECT COUNT(*)
  INTO delivery_count
  FROM payments p
  JOIN bids b ON p.bid_id = b.id
  JOIN vehicles v ON b.vehicle_id = v.id
  WHERE v.driver_id = p_driver_id
  AND p.status = 'completed';
  
  -- Return the count (or 0 if no records found)
  RETURN COALESCE(delivery_count, 0);
END;
$$;


--
-- TOC entry 1457 (class 1255 OID 485706)
-- Name: get_current_user_id(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_current_user_id() RETURNS uuid
    LANGUAGE plpgsql STABLE SECURITY DEFINER
    AS $$
DECLARE
  v_user_id uuid;
BEGIN
  -- Extract user_id from JWT claims (custom auth)
  -- Try 'user_id' claim first, then 'sub' claim, fallback to auth.uid()
  v_user_id := COALESCE(
    (current_setting('request.jwt.claims', true)::json->>'user_id')::uuid,
    (current_setting('request.jwt.claims', true)::json->>'sub')::uuid,
    auth.uid()
  );

  RETURN v_user_id;
EXCEPTION
  WHEN OTHERS THEN
    -- Fallback to auth.uid() if JWT extraction fails
    RETURN auth.uid();
END;
$$;


--
-- TOC entry 6009 (class 0 OID 0)
-- Dependencies: 1457
-- Name: FUNCTION get_current_user_id(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_current_user_id() IS 'Extract user_id from custom JWT claims (user_id or sub). SECURITY DEFINER to avoid RLS recursion.';


--
-- TOC entry 1446 (class 1255 OID 479869)
-- Name: get_driver_active_shipments(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_driver_active_shipments(p_driver_tracking_id uuid) RETURNS TABLE(shipment_id uuid, description text, status text, pickup_name text, pickup_latitude double precision, pickup_longitude double precision, dropoff_name text, dropoff_latitude double precision, dropoff_longitude double precision, added_at timestamp with time zone)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    fp.id,
    fp.description,
    fp.status,
    fp.pickup_name,
    fp.pickup_latitude,
    fp.pickup_longitude,
    fp.dropoff_name,
    fp.dropoff_latitude,
    fp.dropoff_longitude,
    dts.added_at
  FROM driver_tracking_shipments dts
  JOIN freight_posts fp ON fp.id = dts.shipment_id
  WHERE dts.driver_tracking_id = p_driver_tracking_id
    AND dts.removed_at IS NULL
  ORDER BY dts.added_at ASC;
END;
$$;


--
-- TOC entry 6010 (class 0 OID 0)
-- Dependencies: 1446
-- Name: FUNCTION get_driver_active_shipments(p_driver_tracking_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_driver_active_shipments(p_driver_tracking_id uuid) IS 'Returns all active shipments for a driver tracking session (ordered by pickup time)';


--
-- TOC entry 1436 (class 1255 OID 455602)
-- Name: get_driver_bids(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_driver_bids(p_driver_id uuid) RETURNS SETOF jsonb
    LANGUAGE plpgsql
    AS $$
BEGIN
    RETURN QUERY
    WITH bid_data AS (
        SELECT 
            b.id,
            b.freight_post_id,
            b.vehicle_id,
            b.bid_amount,
            b.delivery_date,
            b.pickup_date,
            b.status::TEXT,
            b.notes,
            b.created_at,
            b.modified_at,
            v.type AS vehicle_type,
            v.driver_id,
            fp.description AS shipment_description,
            ST_AsGeoJSON(fp.pickup_location)::json AS pickup_location,
            ST_AsGeoJSON(fp.dropoff_location)::json AS dropoff_location,
            fp.currency,
            fp.status as freight_status,
            fp.shipper_id,
            fp.pickup_location_name,
            fp.dropoff_location_name,
            fp.freight_type,
            (SELECT COUNT(*) FROM bids WHERE freight_post_id = b.freight_post_id) AS bid_count,
            fp.lowest_bid AS lowest_bid
        FROM 
            bids b
        JOIN 
            vehicles v ON b.vehicle_id = v.id
        JOIN 
            freight_posts fp ON b.freight_post_id = fp.id
        WHERE 
            v.driver_id = p_driver_id and b.status = 'Open'
    )
    SELECT 
        jsonb_build_object(
            'id', bd.id,
            'freight_post_id', bd.freight_post_id,
            'vehicle_id', bd.vehicle_id,
            'bid_amount', bd.bid_amount,  
            'delivery_date', bd.delivery_date,
            'pickup_date', bd.pickup_date,
            'status', bd.status,
            'notes', bd.notes,
            'created_at', bd.created_at,
            'updated_at', bd.modified_at,
            'vehicle_type', bd.vehicle_type,
            'driver_id', bd.driver_id,
            'driver_name', TRIM(CONCAT(u.first_name, ' ', u.last_name)),
            'driver_rating', COALESCE((SELECT AVG(score) FROM ratings WHERE rated_user_id = bd.driver_id), 0.0),
            'total_deliveries', COALESCE((
                SELECT COUNT(*)
                FROM payments p
                JOIN bids b ON p.bid_id = b.id
                JOIN vehicles v ON b.vehicle_id = v.id
                WHERE v.driver_id = bd.driver_id
                AND p.status = 'completed'
            ), 0),
            'shipment_description', bd.shipment_description,
            'pickup_location', bd.pickup_location,
            'dropoff_location', bd.dropoff_location,
            'pickup_location_name', bd.pickup_location_name,
            'dropoff_location_name', bd.dropoff_location_name,
            'bid_count', bd.bid_count,
            'lowest_bid', bd.lowest_bid,
            'currency', bd.currency,
            'freight_status', bd.freight_status,
            'shipper_id', bd.shipper_id,
            'freight_type', bd.freight_type
        ) AS result
    FROM 
        bid_data bd
    JOIN 
        users u ON bd.driver_id = u.id
    ORDER BY 
        bd.created_at DESC;
END;
$$;


--
-- TOC entry 674 (class 1255 OID 89186)
-- Name: get_driver_by_id(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_driver_by_id(p_driver_id uuid) RETURNS jsonb
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$BEGIN
    RETURN (
        WITH user_data AS (
            SELECT 
                u.*,
                (
                    SELECT COUNT(*)
                    FROM payments p
                    JOIN bids b ON p.bid_id = b.id
                    JOIN vehicles v ON b.vehicle_id = v.id
                    WHERE v.driver_id = u.id
                    AND p.status = 'completed'
                ) AS completed_deliveries,
                (
                    SELECT COALESCE(AVG(r.score), 0.0)
                    FROM ratings r
                    WHERE r.rated_user_id = u.id
                ) AS average_rating,
                (
                    SELECT jsonb_agg(
                        jsonb_build_object(
                            'id', v.id,
                            'type', v.type,
                            'make', v.make,
                            'model', v.model,
                            'year', v.year,
                            'license_plate', v.license_plate,
                            'capacity_tons', v.capacity_tons,
                            'photo_url', v.photo_url,
                            'created_at', v.created_at
                        )
                    )
                    FROM vehicles v
                    WHERE v.driver_id = u.id
                ) AS vehicles
            FROM users u
            WHERE u.id = p_driver_id
        )
        SELECT row_to_json(user_data)::jsonb
        FROM user_data
    );
END;$$;


--
-- TOC entry 1087 (class 1255 OID 107018)
-- Name: get_driver_for_shipment(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_driver_for_shipment(p_shipment_id uuid) RETURNS jsonb
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
    driver_id uuid;
BEGIN
    -- Get the driver_id for the accepted bid on this shipment
    SELECT v.driver_id INTO driver_id
    FROM bids b
    JOIN vehicles v ON b.vehicle_id = v.id
    WHERE b.freight_post_id = p_shipment_id
    AND b.status = 'Accepted'
    LIMIT 1;
    
    -- If no driver found, return null
    IF driver_id IS NULL THEN
        RETURN NULL;
    END IF;
    
    -- Return driver data using a WITH query to organize the response
    RETURN (
        WITH driver_data AS (
            SELECT 
                u.*,
                (
                    SELECT COUNT(*)
                    FROM payments p
                    JOIN bids b ON p.bid_id = b.id
                    JOIN vehicles v ON b.vehicle_id = v.id
                    WHERE v.driver_id = u.id
                    AND p.status = 'completed'
                ) AS completed_deliveries,
                (
                    SELECT COALESCE(AVG(r.score), 0.0)
                    FROM ratings r
                    WHERE r.rated_user_id = u.id
                ) AS average_rating,
                (
                    SELECT jsonb_build_object(
                        'id', v.id,
                        'type', v.type,
                        'make', v.make,
                        'model', v.model,
                        'year', v.year,
                        'license_plate', v.license_plate,
                        'capacity_tons', v.capacity_tons,
                        'photo_url', v.photo_url,
                        'created_at', v.created_at
                    )
                    FROM vehicles v
                    WHERE v.driver_id = u.id
                    ORDER BY v.created_at DESC
                    LIMIT 1
                ) AS vehicle,
                (
                    SELECT jsonb_build_object(
                        'id', b.id,
                        'bid_amount', b.bid_amount,
                        'delivery_date', b.delivery_date,
                        'pickup_date', b.pickup_date,
                        'created_at', b.created_at,
                        'notes', b.notes
                    )
                    FROM bids b
                    JOIN vehicles v ON b.vehicle_id = v.id
                    WHERE b.freight_post_id = p_shipment_id
                    AND v.driver_id = u.id
                    AND b.status = 'Accepted'
                    LIMIT 1
                ) AS accepted_bid
            FROM users u
            WHERE u.id = driver_id
        )
        SELECT row_to_json(driver_data)::jsonb
        FROM driver_data
    );
END;
$$;


--
-- TOC entry 1447 (class 1255 OID 479871)
-- Name: get_driver_tracking_by_id(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_driver_tracking_by_id(p_session_id uuid) RETURNS TABLE(id uuid, driver_id uuid, status text, started_at timestamp with time zone, completed_at timestamp with time zone, paused_at timestamp with time zone, current_latitude double precision, current_longitude double precision, current_speed double precision, current_heading double precision, last_location_update timestamp with time zone, total_points integer, distance_traveled double precision, update_interval_seconds integer, min_distance_filter double precision, active_shipment_ids uuid[])
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    dts.id,
    dts.driver_id,
    dts.status,
    dts.started_at,
    dts.completed_at,
    dts.paused_at,
    dts.current_latitude,
    dts.current_longitude,
    dts.current_speed,
    dts.current_heading,
    dts.last_location_update,
    dts.total_points,
    dts.distance_traveled,
    dts.update_interval_seconds,
    dts.min_distance_filter,
    COALESCE(
      ARRAY_AGG(ts.shipment_id ORDER BY ts.added_at) FILTER (WHERE ts.removed_at IS NULL),
      ARRAY[]::UUID[]
    ) as active_shipment_ids
  FROM driver_tracking_sessions dts
  LEFT JOIN driver_tracking_shipments ts ON ts.driver_tracking_id = dts.id
  WHERE dts.id = p_session_id
  GROUP BY dts.id;
END;
$$;


--
-- TOC entry 6011 (class 0 OID 0)
-- Dependencies: 1447
-- Name: FUNCTION get_driver_tracking_by_id(p_session_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_driver_tracking_by_id(p_session_id uuid) IS 'Returns driver tracking session with aggregated active shipment IDs';


--
-- TOC entry 1461 (class 1255 OID 486878)
-- Name: get_driver_tracking_for_shipment_with_metrics(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_driver_tracking_for_shipment_with_metrics(p_shipment_id uuid) RETURNS TABLE(session_id uuid, driver_id uuid, driver_name text, driver_photo_url text, current_latitude double precision, current_longitude double precision, current_speed double precision, current_heading double precision, last_location_update timestamp with time zone, started_at timestamp with time zone, total_points integer, distance_traveled double precision, distance_remaining double precision, eta_minutes integer)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    dts.id,
    dts.driver_id,
    dts.driver_name,
    dts.driver_photo_url,
    dts.current_latitude,
    dts.current_longitude,
    dts.current_speed,
    dts.current_heading,
    dts.last_location_update,
    dts.started_at,
    dts.total_points,
    dts.distance_traveled,
    stm.distance_remaining,
    stm.eta_minutes
  FROM driver_tracking_shipments ts
  JOIN driver_tracking_sessions dts ON ts.driver_tracking_id = dts.id
  LEFT JOIN shipment_tracking_metrics stm ON
    stm.driver_tracking_session_id = dts.id
    AND stm.shipment_id = p_shipment_id
  WHERE ts.shipment_id = p_shipment_id
    AND ts.removed_at IS NULL
    AND dts.status = 'active'
  LIMIT 1;
END;
$$;


--
-- TOC entry 541 (class 1255 OID 89228)
-- Name: get_drivers(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_drivers() RETURNS jsonb
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
    RETURN (
        WITH driver_data AS (
            SELECT 
                u.*,
                (
                    SELECT COUNT(*)
                    FROM payments p
                    JOIN bids b ON p.bid_id = b.id
                    JOIN vehicles v ON b.vehicle_id = v.id
                    WHERE v.driver_id = u.id
                    AND p.status = 'completed'
                ) AS completed_deliveries,
                (
                    SELECT COALESCE(AVG(r.score), 0.0)
                    FROM ratings r
                    WHERE r.rated_user_id = u.id
                ) AS average_rating,
                (
                    SELECT jsonb_build_object(
                        'id', v.id,
                        'type', v.type,
                        'make', v.make,
                        'model', v.model,
                        'year', v.year,
                        'photo_url', v.photo_url
                    )
                    FROM vehicles v
                    WHERE v.driver_id = u.id
                    ORDER BY v.created_at DESC
                    LIMIT 1
                ) AS vehicle
            FROM users u
            WHERE u.role = 'Driver'
        )
        SELECT jsonb_agg(row_to_json(driver_data)::jsonb)
        FROM driver_data
        ORDER BY driver_data.average_rating DESC, driver_data.completed_deliveries DESC
    );
END;
$$;


--
-- TOC entry 1082 (class 1255 OID 379478)
-- Name: get_latest_tracking_position(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_latest_tracking_position(p_tracking_id uuid) RETURNS TABLE(latitude double precision, longitude double precision, speed double precision, heading double precision, point_timestamp timestamp with time zone, seconds_ago integer)
    LANGUAGE plpgsql STABLE
    AS $$
BEGIN
  RETURN QUERY
  SELECT 
    tp.latitude,
    tp.longitude,
    tp.speed,
    tp.heading,
    tp."timestamp" AS point_timestamp,
    EXTRACT(EPOCH FROM (NOW() - tp."timestamp"))::integer AS seconds_ago
  FROM tracking_points tp
  WHERE tp.tracking_id = p_tracking_id
  ORDER BY tp."timestamp" DESC
  LIMIT 1;
END;
$$;


--
-- TOC entry 6012 (class 0 OID 0)
-- Dependencies: 1082
-- Name: FUNCTION get_latest_tracking_position(p_tracking_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_latest_tracking_position(p_tracking_id uuid) IS 'Returns the most recent position for a tracking session with time elapsed';


--
-- TOC entry 538 (class 1255 OID 270772)
-- Name: get_notification_preference(uuid, public.notification_type); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_notification_preference(p_user_id uuid, p_notification_type public.notification_type) RETURNS TABLE(push_enabled boolean, sms_enabled boolean)
    LANGUAGE sql SECURITY DEFINER
    AS $$
    SELECT 
        COALESCE(ntp.push_enabled, false) as push_enabled,
        COALESCE(ntp.sms_enabled, false) as sms_enabled
    FROM notification_type_preferences ntp
    WHERE ntp.user_id = p_user_id 
    AND ntp.notification_type = p_notification_type
    
    UNION ALL
    
    -- Return default (false, false) if no preference exists
    SELECT false, false
    WHERE NOT EXISTS (
        SELECT 1 FROM notification_type_preferences
        WHERE user_id = p_user_id AND notification_type = p_notification_type
    )
    LIMIT 1;
$$;


--
-- TOC entry 1426 (class 1255 OID 423791)
-- Name: get_route_cache_stats(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_route_cache_stats() RETURNS TABLE(total_entries bigint, total_hits bigint, cache_size_mb numeric, avg_hit_count numeric, oldest_entry timestamp with time zone, newest_entry timestamp with time zone, expired_entries bigint)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    COUNT(*)::BIGINT AS total_entries,
    COALESCE(SUM(hit_count), 0)::BIGINT AS total_hits,
    ROUND((pg_total_relation_size('route_cache')::NUMERIC / 1024 / 1024), 2) AS cache_size_mb,
    ROUND(AVG(hit_count), 2) AS avg_hit_count,
    MIN(created_at) AS oldest_entry,
    MAX(created_at) AS newest_entry,
    COUNT(*) FILTER (WHERE expires_at < NOW())::BIGINT AS expired_entries
  FROM route_cache;
END;
$$;


--
-- TOC entry 6013 (class 0 OID 0)
-- Dependencies: 1426
-- Name: FUNCTION get_route_cache_stats(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_route_cache_stats() IS 'Returns statistics about route cache usage and performance';


--
-- TOC entry 1432 (class 1255 OID 455601)
-- Name: get_shipment_bids(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_shipment_bids(p_freight_post_id uuid) RETURNS SETOF jsonb
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  new_bid_cutoff TIMESTAMP WITH TIME ZONE := NOW() - INTERVAL '24 hours';
BEGIN
  RETURN QUERY
  WITH bid_data AS (
    SELECT 
      b.id::text,
      b.freight_post_id::text,
      b.vehicle_id::text,
      b.bid_amount,
      b.delivery_date,
      b.pickup_date,
      b.status,
      b.created_at,
      b.modified_at,
      b.notes,
      v.driver_id::text,
      v.type AS vehicle_type,
      (b.created_at > new_bid_cutoff) AS is_new,
      fp.freight_type
    FROM bids b
    LEFT JOIN vehicles v ON b.vehicle_id = v.id
    LEFT JOIN freight_posts fp ON b.freight_post_id = fp.id
    WHERE b.freight_post_id = p_freight_post_id::uuid
    AND b.status = 'Open'
  ),
  driver_data AS (
    SELECT 
      bd.id,
      bd.freight_post_id,
      bd.vehicle_id,
      bd.bid_amount,
      bd.delivery_date,
      bd.pickup_date,
      bd.status,
      bd.created_at,
      bd.modified_at,
      bd.notes,
      bd.driver_id,
      bd.vehicle_type,
      bd.is_new,
      bd.freight_type,
      COALESCE(TRIM(CONCAT(u.first_name, ' ', u.last_name)), 'Unknown Driver') AS driver_name,
      COALESCE(
        (SELECT AVG(score) FROM ratings WHERE rated_user_id = bd.driver_id::uuid),
        0.0
      ) AS driver_rating,
      COALESCE(
        (SELECT COUNT(*)
         FROM payments p
         JOIN bids b ON p.bid_id = b.id
         JOIN vehicles v ON b.vehicle_id = v.id
         WHERE v.driver_id = bd.driver_id::uuid
         AND p.status = 'completed'),
        0
      ) AS total_deliveries
    FROM bid_data bd
    LEFT JOIN users u ON bd.driver_id::uuid = u.id
  )
  SELECT 
    jsonb_build_object(
      'id', id,
      'freight_post_id', freight_post_id,
      'vehicle_id', vehicle_id,
      'bid_amount', bid_amount,  
      'delivery_date', delivery_date,
      'pickup_date', pickup_date,
      'status', status,
      'created_at', created_at,
      'updated_at', modified_at, 
      'notes', notes,
      'driver_id', driver_id,
      'driver_name', driver_name,
      'driver_rating', driver_rating,
      'total_deliveries', total_deliveries,
      'vehicle_type', vehicle_type,
      'is_new', is_new,
      'freight_type', freight_type
    ) AS result
  FROM driver_data
  ORDER BY created_at DESC;
END;
$$;


--
-- TOC entry 1395 (class 1255 OID 423960)
-- Name: get_shipment_coordinates(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_shipment_coordinates(shipment_id_param uuid) RETURNS TABLE(pickup_lat double precision, pickup_lng double precision, dropoff_lat double precision, dropoff_lng double precision)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    ST_Y(pickup_location::geometry) AS pickup_lat,
    ST_X(pickup_location::geometry) AS pickup_lng,
    ST_Y(dropoff_location::geometry) AS dropoff_lat,
    ST_X(dropoff_location::geometry) AS dropoff_lng
  FROM freight_posts
  WHERE id = shipment_id_param
  LIMIT 1;
END;
$$;


--
-- TOC entry 6014 (class 0 OID 0)
-- Dependencies: 1395
-- Name: FUNCTION get_shipment_coordinates(shipment_id_param uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_shipment_coordinates(shipment_id_param uuid) IS 'Extracts latitude/longitude coordinates from PostGIS geometry columns (pickup_location, dropoff_location) for a given shipment. Used by tracking system to generate planned routes via Google Directions API.';


--
-- TOC entry 1454 (class 1255 OID 483376)
-- Name: get_shipment_dropoff_coords(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_shipment_dropoff_coords(shipment_id_param uuid) RETURNS TABLE(latitude double precision, longitude double precision)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
  BEGIN
    RETURN QUERY
    SELECT
      ST_Y(dropoff_location) as latitude,
      ST_X(dropoff_location) as longitude
    FROM freight_posts
    WHERE id = shipment_id_param
      AND dropoff_location IS NOT NULL;
  END;
  $$;


--
-- TOC entry 1489 (class 1255 OID 445016)
-- Name: get_shipment_payment_summary(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_shipment_payment_summary(p_freight_post_id uuid) RETURNS jsonb
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
    v_result jsonb;
BEGIN
    SELECT jsonb_build_object(
        'payment', (
            SELECT jsonb_build_object(
                'id', p.id,
                'status', p.status,
                'amount', p.amount,
                'bid_amount', p.bid_amount,
                'shipper_commission', p.shipper_commission,
                'total_commission', p.total_commission,
                'paystack_reference', p.paystack_reference,
                'paid_at', p.paid_at
            )
            FROM public.payments p
            WHERE p.freight_post_id = p_freight_post_id
            LIMIT 1
        ),
        'escrow', (
            SELECT jsonb_build_object(
                'id', e.id,
                'status', e.status,
                'held_amount', e.held_amount,
                'held_at', e.held_at,
                'released_at', e.released_at
            )
            FROM public.escrow_holdings e
            WHERE e.freight_post_id = p_freight_post_id
            LIMIT 1
        ),
        'payout', (
            SELECT jsonb_build_object(
                'id', dp.id,
                'status', dp.status,
                'net_amount', dp.net_amount,
                'completed_at', dp.completed_at
            )
            FROM public.driver_payouts dp
            WHERE dp.freight_post_id = p_freight_post_id
            LIMIT 1
        ),
        'refund', (
            SELECT jsonb_build_object(
                'id', r.id,
                'status', r.status,
                'refund_amount', r.refund_amount,
                'processed_at', r.processed_at
            )
            FROM public.payment_refunds r
            WHERE r.freight_post_id = p_freight_post_id
            LIMIT 1
        )
    ) INTO v_result;
    
    RETURN v_result;
END;
$$;


--
-- TOC entry 6015 (class 0 OID 0)
-- Dependencies: 1489
-- Name: FUNCTION get_shipment_payment_summary(p_freight_post_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_shipment_payment_summary(p_freight_post_id uuid) IS 'Returns complete payment summary for a shipment including escrow, payout and refund status';


--
-- TOC entry 1428 (class 1255 OID 433419)
-- Name: get_shipments_by_type(uuid, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_shipments_by_type(p_user_id uuid, p_freight_type text) RETURNS jsonb
    LANGUAGE plpgsql
    AS $$
BEGIN
  RETURN (
    SELECT jsonb_agg(
      jsonb_build_object(
        'id', fp.id,
        'description', fp.description,
        'status', fp.status,
        'delivery_time_window', fp.delivery_time_window,
        'pickup_location', fp.pickup_location,
        'dropoff_location', fp.dropoff_location,
        'pickup_location_name', fp.pickup_location_name,
        'dropoff_location_name', fp.dropoff_location_name,
        'rated', fp.rated,
        'archived', fp.archived,
        'currency', fp.currency,
        'notes', fp.notes,
        'shipper_id', fp.shipper_id,
        'freight_type', fp.freight_type,
        'created_at', fp.created_at,
        'updated_at', fp.updated_at,
        'rated_at', fp.rated_at,
        -- Include freight items (only for 'items' type)
        'freight_items', (
          SELECT jsonb_agg(
            jsonb_build_object(
              'id', fi.id,
              'quantity', fi.quantity,
              'weight_kg', fi.weight_kg,
              'length_cm', fi.length_cm,
              'width_cm', fi.width_cm,
              'height_cm', fi.height_cm,
              'volume_cm3', fi.volume_cm3,
              'photo_url', fi.photo_url
            )
          )
          FROM freight_items fi
          WHERE fi.freight_post_id = fp.id
        ),
        -- Include moving data
        'freight_moving', (
          SELECT jsonb_build_object(
            'id', fm.id,
            'property_type', fm.property_type,
            'has_store_room', fm.has_store_room,
            'has_outdoor_furniture', fm.has_outdoor_furniture,
            'has_appliances', fm.has_appliances,
            'has_fragile_items', fm.has_fragile_items,
            'truck_capacity_tons', fm.truck_capacity_tons,
            'additional_notes', fm.additional_notes,
            'created_at', fm.created_at
          )
          FROM freight_moving fm
          WHERE fm.freight_post_id = fp.id
        ),
        -- Include rubble data
        'freight_rubble', (
          SELECT jsonb_build_object(
            'id', fr.id,
            'waste_type', fr.waste_type,
            'estimated_volume_m3', fr.estimated_volume_m3,
            'photo_url', fr.photo_url,
            'additional_notes', fr.additional_notes,
            'created_at', fr.created_at
          )
          FROM freight_rubble fr
          WHERE fr.freight_post_id = fp.id
        ),
        -- Include vehicles data (can be multiple)
        'freight_vehicles', (
          SELECT jsonb_agg(
            jsonb_build_object(
              'id', fv.id,
              'vehicle_type', fv.vehicle_type,
              'running_condition', fv.running_condition,
              'photo_url', fv.photo_url,
              'additional_notes', fv.additional_notes,
              'created_at', fv.created_at
            )
          )
          FROM freight_vehicles fv
          WHERE fv.freight_post_id = fp.id
        ),
        -- Include bid information
        'bid_info', jsonb_build_object(
          'num_bids', (SELECT COUNT(*) FROM bids WHERE freight_post_id = fp.id),
          'low_bid', (SELECT MIN(bid_amount) FROM bids WHERE freight_post_id = fp.id),
          'accepted_bid', (
            SELECT jsonb_build_object(
              'id', b.id,
              'bid_amount', b.bid_amount,
              'vehicle_id', b.vehicle_id,
              'status', b.status
            )
            FROM bids b
            WHERE b.freight_post_id = fp.id AND b.status = 'Accepted'
            LIMIT 1
          )
        ),
        -- Include shipper information
        'shipper_info', (
          SELECT jsonb_build_object(
            'shipper_id', u.id,
            'shipper_first_name', u.first_name,
            'shipper_last_name', u.last_name,
            'shipper_phone', u.phone_number
          )
          FROM users u
          WHERE u.id = fp.shipper_id
        )
      )
      ORDER BY fp.created_at DESC
    )
    FROM freight_posts fp
    WHERE
      fp.shipper_id = p_user_id
      AND fp.freight_type = p_freight_type::freight_type
      AND fp.archived = false
  );
END;
$$;


--
-- TOC entry 6016 (class 0 OID 0)
-- Dependencies: 1428
-- Name: FUNCTION get_shipments_by_type(p_user_id uuid, p_freight_type text); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_shipments_by_type(p_user_id uuid, p_freight_type text) IS 'Get shipments filtered by user_id and freight_type with all type-specific data included';


--
-- TOC entry 1487 (class 1255 OID 103466)
-- Name: get_shipments_for_driver(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_shipments_for_driver(p_driver_id uuid) RETURNS SETOF json
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$BEGIN
  RETURN QUERY
  WITH driver_accepted_bids AS (
    SELECT b.*
    FROM public.bids b
    JOIN public.vehicles v ON b.vehicle_id = v.id
    WHERE v.driver_id = p_driver_id
    AND b.status = 'Accepted'
  ),
  shipment_data AS (
    SELECT
      fp.id,
      fp.shipper_id,
      fp.description,
      fp.pickup_location,
      fp.dropoff_location,
      fp.pickup_location_name,
      fp.dropoff_location_name,
      fp.status,
      fp.delivery_time_window,
      fp.currency,
      fp.notes,
      fp.pickup_pin,
      fp.delivery_pin,
      fp.rated,
      fp.archived,
      fp.created_at,
      fp.updated_at,
      fp.freight_type,  -- NEW: Add freight type
      dab.id AS bid_id,
      dab.bid_amount,
      dab.pickup_date,
      dab.delivery_date,
      dab.notes AS bid_notes,
      (
        SELECT json_build_object(
          'id', u.id,
          'first_name', u.first_name,
          'last_name', u.last_name,
          'phone_number', u.phone_number,
          'profile_photo_url', u.profile_photo_url
        )
        FROM public.users u
        WHERE u.id = fp.shipper_id
      ) AS shipper_info
    FROM public.freight_posts fp
    JOIN driver_accepted_bids dab ON fp.id = dab.freight_post_id
    WHERE fp.archived = false
  ),
  freight_items AS (
    SELECT
      fi.freight_post_id,
      jsonb_agg(
        jsonb_build_object(
          'id', fi.id,
          'weight_kg', fi.weight_kg,
          'length_cm', fi.length_cm,
          'width_cm', fi.width_cm,
          'height_cm', fi.height_cm,
          'volume_cm3', fi.volume_cm3,
          'photo_url', fi.photo_url
        )
      ) AS items
    FROM public.freight_items fi
    WHERE fi.freight_post_id IN (SELECT id FROM shipment_data)
    GROUP BY fi.freight_post_id
  )
  SELECT json_build_object(
    'id', sd.id,
    'shipper_id', sd.shipper_id,
    'description', sd.description,
    'pickup_location', ST_AsGeoJSON(sd.pickup_location)::json,
    'dropoff_location', ST_AsGeoJSON(sd.dropoff_location)::json,
    'pickup_location_name', sd.pickup_location_name,
    'dropoff_location_name', sd.dropoff_location_name,
    'status', sd.status,
    'delivery_time_window', sd.delivery_time_window,
    'currency', sd.currency,
    'notes', sd.notes,
    'pickup_pin', sd.pickup_pin,
    'delivery_pin', sd.delivery_pin,
    'rated', sd.rated,
    'archived', sd.archived,
    'created_at', sd.created_at,
    'updated_at', sd.updated_at,
    'freight_type', sd.freight_type,  -- NEW: Include in output
    'bid_id', sd.bid_id,
    'bid_amount', sd.bid_amount,
    'pickup_date', sd.pickup_date,
    'delivery_date', sd.delivery_date,
    'bid_notes', sd.bid_notes,
    'shipper_info', sd.shipper_info,
    'freight_items', COALESCE((SELECT fi.items FROM freight_items fi WHERE fi.freight_post_id = sd.id), '[]'::jsonb),
    -- NEW: Add freight_moving data
    'freight_moving', (
      SELECT jsonb_build_object(
        'id', fm.id,
        'property_type', fm.property_type,
        'has_store_room', fm.has_store_room,
        'has_outdoor_furniture', fm.has_outdoor_furniture,
        'truck_capacity_tons', fm.truck_capacity_tons,
        'additional_notes', fm.additional_notes,
        'created_at', fm.created_at
      )
      FROM freight_moving fm
      WHERE fm.freight_post_id = sd.id
    ),
    -- NEW: Add freight_rubble data
    'freight_rubble', (
      SELECT jsonb_build_object(
        'id', fr.id,
        'waste_type', fr.waste_type,
        'estimated_volume_m3', fr.estimated_volume_m3,
        'photo_url', fr.photo_url,
        'additional_notes', fr.additional_notes,
        'created_at', fr.created_at
      )
      FROM freight_rubble fr
      WHERE fr.freight_post_id = sd.id
    ),
    -- NEW: Add freight_vehicles data (array)
    'freight_vehicles', (
      SELECT jsonb_agg(
        jsonb_build_object(
          'id', fv.id,
          'vehicle_type', fv.vehicle_type,
          'running_condition', fv.running_condition,
          'photo_url', fv.photo_url,
          'additional_notes', fv.additional_notes,
          'created_at', fv.created_at
        )
      )
      FROM freight_vehicles fv
      WHERE fv.freight_post_id = sd.id
    )
  )
  FROM shipment_data sd
  ORDER BY
    CASE
      WHEN sd.status = 'OnRoute' THEN 1
      WHEN sd.status = 'Pickup' THEN 2
      WHEN sd.status = 'Delivered' THEN 3
      ELSE 4
    END,
    sd.pickup_date ASC NULLS LAST;
END;$$;


--
-- TOC entry 6017 (class 0 OID 0)
-- Dependencies: 1487
-- Name: FUNCTION get_shipments_for_driver(p_driver_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_shipments_for_driver(p_driver_id uuid) IS 'Get all shipments where the driver''s bid has been accepted';


--
-- TOC entry 1429 (class 1255 OID 436820)
-- Name: get_shipper_shipments(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_shipper_shipments(p_shipper_id uuid) RETURNS jsonb
    LANGUAGE plpgsql
    AS $$
BEGIN
  RETURN (
    WITH shipment_data AS (
      SELECT 
        fp.id,
        fp.description,
        fp.status,
        fp.freight_type,
        fp.delivery_time_window,
        fp.pickup_location,
        fp.dropoff_location,
        fp.pickup_location_name,
        fp.dropoff_location_name,
        fp.pickup_pin,
        fp.delivery_pin,
        fp.rated,
        fp.archived,
        fp.currency,
        fp.notes,
        fp.created_at,
        fp.updated_at,
        r.score as rating_score,
        (
          SELECT jsonb_agg(
            jsonb_build_object(
              'id', fi.id,
              'weight_kg', fi.weight_kg,
              'length_cm', fi.length_cm,
              'width_cm', fi.width_cm,
              'height_cm', fi.height_cm,
              'volume_cm3', fi.volume_cm3,
              'photo_url', fi.photo_url
            )
          )
          FROM freight_items fi
          WHERE fi.freight_post_id = fp.id
        ) AS freight_items,
        (
          SELECT row_to_json(fm.*)::jsonb
          FROM freight_moving fm
          WHERE fm.freight_post_id = fp.id
          LIMIT 1
        ) AS freight_moving,
        (
          SELECT row_to_json(fr.*)::jsonb
          FROM freight_rubble fr
          WHERE fr.freight_post_id = fp.id
          LIMIT 1
        ) AS freight_rubble,
        (
          SELECT jsonb_agg(row_to_json(fv.*)::jsonb)
          FROM freight_vehicles fv
          WHERE fv.freight_post_id = fp.id
        ) AS freight_vehicles,
        (
          CASE
            WHEN fp.status = 'Bidding' THEN
              jsonb_build_object(
                -- FIX: Only count Open bids (exclude Cancelled, Declined, Accepted)
                'num_bids', (SELECT COUNT(*) FROM bids WHERE freight_post_id = fp.id AND status = 'Open'),
                -- FIX: Only get MIN from Open bids
                'low_bid', (SELECT MIN(bid_amount) FROM bids WHERE freight_post_id = fp.id AND status = 'Open')
              )
            WHEN fp.status IN ('Pickup', 'OnRoute', 'Delivered') THEN
              (SELECT jsonb_build_object(
                'bid_amount', b.bid_amount,
                'bid_status', b.status,
                'pickup_date', b.pickup_date,
                'delivery_date', b.delivery_date,
                'driver_id', u.id,
                'driver_first_name', u.first_name,
                'driver_last_name', u.last_name,
                'driver_phone', u.phone_number
              )
              FROM bids b
              JOIN vehicles v ON b.vehicle_id = v.id
              JOIN users u ON v.driver_id = u.id
              WHERE b.freight_post_id = fp.id
              AND b.status = 'Accepted'
              LIMIT 1)
            ELSE NULL
          END
        ) AS bid_info,
        (SELECT b.pickup_date
         FROM bids b
         WHERE b.freight_post_id = fp.id
         AND b.status = 'Accepted'
         LIMIT 1) AS pickup_date
      FROM freight_posts fp
      LEFT JOIN ratings r ON r.freight_post_id = fp.id
      WHERE fp.shipper_id = p_shipper_id
      AND fp.archived = false
      AND fp.status != 'Cancelled'
    )
    SELECT jsonb_agg(row_to_json(shipment_data)::jsonb ORDER BY 
      CASE 
        WHEN status = 'Bidding' THEN 1
        WHEN status = 'Pickup' THEN 2
        WHEN status = 'OnRoute' THEN 3
        WHEN status = 'Delivered' THEN 4
        ELSE 5
      END,
      CASE 
        WHEN status IN ('Pickup', 'OnRoute', 'Delivered') THEN pickup_date
        ELSE NULL
      END ASC,
      CASE 
        WHEN status = 'Bidding' THEN delivery_time_window
        ELSE NULL
      END ASC
    )
    FROM shipment_data
  );
END;
$$;


--
-- TOC entry 1466 (class 1255 OID 489268)
-- Name: get_stale_session_count(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_stale_session_count() RETURNS integer
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  stale_count INTEGER;
BEGIN
  SELECT COUNT(*) INTO stale_count
  FROM driver_tracking_sessions
  WHERE status = 'active'
    AND last_location_update < (NOW() - INTERVAL '10 minutes');

  RETURN stale_count;
END;
$$;


--
-- TOC entry 6018 (class 0 OID 0)
-- Dependencies: 1466
-- Name: FUNCTION get_stale_session_count(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_stale_session_count() IS 'Returns the current number of stale tracking sessions (active but no update in 10+ minutes)';


--
-- TOC entry 1452 (class 1255 OID 482244)
-- Name: get_tracking_for_shipment(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_tracking_for_shipment(p_shipment_id uuid) RETURNS TABLE(session_id uuid, driver_id uuid, driver_name text, status text, current_latitude double precision, current_longitude double precision, current_speed double precision, current_heading double precision, last_location_update timestamp with time zone, started_at timestamp with time zone, total_points integer, distance_traveled double precision, distance_remaining double precision, eta_minutes integer)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    dts.id,
    dts.driver_id,
    COALESCE(u.first_name || ' ' || u.last_name, u.first_name, u.last_name, 'Unknown') as driver_name,
    dts.status,
    dts.current_latitude,
    dts.current_longitude,
    dts.current_speed,
    dts.current_heading,
    dts.last_location_update,
    dts.started_at,
    dts.total_points,
    dts.distance_traveled,
    dts.distance_remaining,
    dts.eta_minutes
  FROM driver_tracking_shipments ts
  JOIN driver_tracking_sessions dts ON ts.driver_tracking_id = dts.id
  JOIN users u ON u.id = dts.driver_id
  WHERE ts.shipment_id = p_shipment_id
    AND ts.removed_at IS NULL
    AND dts.status = 'active'
  LIMIT 1;
END;
$$;


--
-- TOC entry 6019 (class 0 OID 0)
-- Dependencies: 1452
-- Name: FUNCTION get_tracking_for_shipment(p_shipment_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_tracking_for_shipment(p_shipment_id uuid) IS 'Returns active driver tracking session for a specific shipment with metrics (used by shippers)';


--
-- TOC entry 1420 (class 1255 OID 379544)
-- Name: get_tracking_health_status(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_tracking_health_status(p_tracking_id uuid) RETURNS TABLE(tracking_id uuid, status text, last_update timestamp with time zone, seconds_since_update integer, is_stale boolean, health_status text)
    LANGUAGE plpgsql STABLE
    AS $$
DECLARE
  v_last_update timestamp with time zone;
  v_seconds_ago integer;
BEGIN
  -- Get last position update
  SELECT tp."timestamp" INTO v_last_update
  FROM tracking_points tp
  WHERE tp.tracking_id = p_tracking_id
  ORDER BY tp."timestamp" DESC
  LIMIT 1;
  
  -- Calculate time since last update
  v_seconds_ago := EXTRACT(EPOCH FROM (NOW() - v_last_update))::integer;
  
  RETURN QUERY
  SELECT 
    ts.id,
    ts.status::text,
    v_last_update,
    v_seconds_ago,
    v_seconds_ago > 300 AS is_stale, -- Stale if > 5 minutes
    CASE 
      WHEN v_seconds_ago < 30 THEN 'excellent'
      WHEN v_seconds_ago < 60 THEN 'good'
      WHEN v_seconds_ago < 180 THEN 'fair'
      WHEN v_seconds_ago < 300 THEN 'poor'
      ELSE 'stale'
    END AS health_status
  FROM tracking_sessions ts
  WHERE ts.id = p_tracking_id;
END;
$$;


--
-- TOC entry 6020 (class 0 OID 0)
-- Dependencies: 1420
-- Name: FUNCTION get_tracking_health_status(p_tracking_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_tracking_health_status(p_tracking_id uuid) IS 'Returns health status of a tracking session based on last position update';


--
-- TOC entry 1497 (class 1255 OID 482245)
-- Name: get_tracking_points(uuid, uuid, timestamp with time zone, text[], integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_tracking_points(tracking_id_param uuid DEFAULT NULL::uuid, driver_tracking_id_param uuid DEFAULT NULL::uuid, after_timestamp_param timestamp with time zone DEFAULT NULL::timestamp with time zone, types_param text[] DEFAULT NULL::text[], limit_param integer DEFAULT 100) RETURNS TABLE(id text, tracking_id text, driver_tracking_id text, sequence_number integer, latitude double precision, longitude double precision, accuracy double precision, altitude double precision, speed double precision, heading double precision, type text, point_timestamp timestamp with time zone, created_at timestamp with time zone, address text, distance_from_previous double precision, duration_from_previous integer, notes text, metadata jsonb)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    tp.id::text,
    tp.tracking_id::text,
    tp.driver_tracking_id::text,
    tp.sequence_number,
    tp.latitude,
    tp.longitude,
    tp.accuracy,
    tp.altitude,
    tp.speed,
    tp.heading,
    tp.type::text,
    tp.timestamp as point_timestamp,
    tp.created_at,
    tp.address,
    tp.distance_from_previous,
    tp.duration_from_previous,
    tp.notes,
    tp.metadata
  FROM tracking_points tp
  WHERE
    (tracking_id_param IS NULL OR tp.tracking_id = tracking_id_param)
    AND (driver_tracking_id_param IS NULL OR tp.driver_tracking_id = driver_tracking_id_param)
    AND (after_timestamp_param IS NULL OR tp.timestamp > after_timestamp_param)
    AND (types_param IS NULL OR tp.type::text = ANY(types_param))
  ORDER BY tp.timestamp ASC
  LIMIT COALESCE(limit_param, 1000);
END;
$$;


--
-- TOC entry 6021 (class 0 OID 0)
-- Dependencies: 1497
-- Name: FUNCTION get_tracking_points(tracking_id_param uuid, driver_tracking_id_param uuid, after_timestamp_param timestamp with time zone, types_param text[], limit_param integer); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_tracking_points(tracking_id_param uuid, driver_tracking_id_param uuid, after_timestamp_param timestamp with time zone, types_param text[], limit_param integer) IS 'Returns tracking points filtered by tracking_id OR driver_tracking_id, with optional filters';


--
-- TOC entry 1419 (class 1255 OID 379500)
-- Name: get_tracking_position_history(uuid, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_tracking_position_history(p_tracking_id uuid, p_limit integer DEFAULT 100) RETURNS TABLE(latitude double precision, longitude double precision, speed double precision, heading double precision, point_timestamp timestamp with time zone, distance_from_previous double precision, duration_from_previous integer)
    LANGUAGE plpgsql STABLE
    AS $$
BEGIN
  RETURN QUERY
  SELECT 
    tp.latitude,
    tp.longitude,
    tp.speed,
    tp.heading,
    tp."timestamp" AS point_timestamp,
    tp.distance_from_previous,
    tp.duration_from_previous
  FROM tracking_points tp
  WHERE tp.tracking_id = p_tracking_id
    AND tp.type IN ('tracking', 'pickup', 'dropoff')
  ORDER BY tp."timestamp" DESC
  LIMIT p_limit;
END;
$$;


--
-- TOC entry 6022 (class 0 OID 0)
-- Dependencies: 1419
-- Name: FUNCTION get_tracking_position_history(p_tracking_id uuid, p_limit integer); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_tracking_position_history(p_tracking_id uuid, p_limit integer) IS 'Returns position history for a tracking session, ordered by most recent first';


--
-- TOC entry 1450 (class 1255 OID 373647)
-- Name: get_tracking_statistics(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_tracking_statistics(p_tracking_id uuid) RETURNS TABLE(total_distance_km double precision, straight_line_distance_km double precision, route_efficiency_percent double precision, total_duration_hours double precision, average_speed_kmh double precision, max_speed_kmh double precision, points_count integer)
    LANGUAGE plpgsql
    AS $$
BEGIN
    RETURN QUERY
    WITH route_stats AS (
        SELECT 
            ts.traveled_route_geom,
            ts.started_at,
            fp.pickup_location,
            fp.dropoff_location
        FROM tracking_sessions ts
        JOIN freight_posts fp ON ts.shipment_id = fp.id
        WHERE ts.id = p_tracking_id
    ),
    point_stats AS (
        SELECT 
            COUNT(*) as point_count,
            MAX(speed) as max_speed,
            SUM(distance_from_previous) as total_traveled,
            EXTRACT(EPOCH FROM (MAX("timestamp") - MIN("timestamp"))) / 3600.0 as duration_hours
        FROM tracking_points
        WHERE tracking_id = p_tracking_id
    )
    SELECT 
        ps.total_traveled,
        ST_Distance(
            rs.pickup_location::geography,
            rs.dropoff_location::geography
        ) / 1000.0 as straight_distance,
        CASE 
            WHEN ps.total_traveled > 0 THEN
                (ST_Distance(rs.pickup_location::geography, rs.dropoff_location::geography) / 1000.0 / ps.total_traveled) * 100
            ELSE 0
        END as efficiency,
        ps.duration_hours,
        CASE 
            WHEN ps.duration_hours > 0 THEN ps.total_traveled / ps.duration_hours
            ELSE 0
        END as avg_speed,
        ps.max_speed,
        ps.point_count::integer
    FROM route_stats rs
    CROSS JOIN point_stats ps;
END;
$$;


--
-- TOC entry 6023 (class 0 OID 0)
-- Dependencies: 1450
-- Name: FUNCTION get_tracking_statistics(p_tracking_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_tracking_statistics(p_tracking_id uuid) IS 'Get comprehensive tracking statistics including distance, efficiency, and speed metrics';


--
-- TOC entry 675 (class 1255 OID 270875)
-- Name: get_user_notification_preferences(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_user_notification_preferences(p_user_id uuid) RETURNS TABLE(notification_type public.notification_type, push_enabled boolean, sms_enabled boolean)
    LANGUAGE sql SECURITY DEFINER
    AS $$
    WITH all_notification_types AS (
        SELECT unnest(enum_range(NULL::notification_type)) as type
    )
    SELECT 
        ant.type as notification_type,
        COALESCE(ntp.push_enabled, false) as push_enabled,
        COALESCE(ntp.sms_enabled, false) as sms_enabled
    FROM all_notification_types ant
    LEFT JOIN notification_type_preferences ntp ON 
        ntp.user_id = p_user_id AND ntp.notification_type = ant.type
    ORDER BY ant.type;
$$;


--
-- TOC entry 1453 (class 1255 OID 69202)
-- Name: handle_bid_status_change(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.handle_bid_status_change() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    AS $_$
DECLARE
    driver_id UUID;
    bid_amount NUMERIC;
    freight_description TEXT;
    freight_id UUID;
    currency TEXT;
    shipper_id UUID;
    pickup_pin TEXT;
    currency_symbol TEXT;
BEGIN
    -- Get the driver_id from vehicles table using vehicle_id
    SELECT v.driver_id INTO driver_id
    FROM public.vehicles v
    WHERE v.id = NEW.vehicle_id;
    
    -- Get bid amount for message content
    bid_amount := NEW.bid_amount;
    
    -- Get freight post information, including currency, shipper_id, and pickup_pin
    SELECT fp.id, fp.description, fp.currency, fp.shipper_id, fp.pickup_pin 
    INTO freight_id, freight_description, currency, shipper_id, pickup_pin
    FROM public.freight_posts fp
    WHERE fp.id = NEW.freight_post_id;
    
    -- Convert currency code to symbol
    currency_symbol := CASE currency
        -- North America & Europe
        WHEN 'USD' THEN '$'
        WHEN 'EUR' THEN ''
        WHEN 'GBP' THEN ''
        WHEN 'CAD' THEN 'C$'
        WHEN 'CHF' THEN 'CHF'
        WHEN 'SEK' THEN 'kr'
        WHEN 'NOK' THEN 'kr'
        WHEN 'DKK' THEN 'kr'
        WHEN 'PLN' THEN 'z'
        
        -- South America
        WHEN 'BRL' THEN 'R$'
        WHEN 'ARS' THEN 'AR$'
        WHEN 'CLP' THEN 'CLP$'
        WHEN 'COP' THEN 'COL$'
        WHEN 'PEN' THEN 'S/'
        WHEN 'UYU' THEN 'UYU$'
        WHEN 'BOB' THEN 'Bs.'
        WHEN 'PYG' THEN ''
        WHEN 'VES' THEN 'Bs.'

        -- Africa
        WHEN 'ZAR' THEN 'R'
        WHEN 'EGP' THEN 'E'
        WHEN 'NGN' THEN ''
        WHEN 'KES' THEN 'KSh'
        WHEN 'TZS' THEN 'TSh'
        WHEN 'GHS' THEN 'GH'
        WHEN 'XAF' THEN 'CFA'
        WHEN 'XOF' THEN 'CFA'
        WHEN 'MZN' THEN 'MT'
        WHEN 'BWP' THEN 'P'
        WHEN 'ETB' THEN 'Br'
        WHEN 'MAD' THEN '..'
        WHEN 'DZD' THEN ''
        WHEN 'SDG' THEN 'SDG'
        WHEN 'RWF' THEN 'FRw'
        WHEN 'CDF' THEN 'FC'
        WHEN 'MWK' THEN 'MK'
        WHEN 'ZMW' THEN 'ZK'
        WHEN 'SSP' THEN ''

        -- Middle East
        WHEN 'SAR' THEN '.'
        WHEN 'AED' THEN '.'
        WHEN 'QAR' THEN '.'
        WHEN 'KWD' THEN 'KD'
        WHEN 'BHD' THEN 'BD'
        WHEN 'OMR' THEN '.'
        WHEN 'IQD' THEN '.'
        WHEN 'IRR' THEN '.'

        -- Asia
        WHEN 'JPY' THEN ''
        WHEN 'CNY' THEN ''
        WHEN 'INR' THEN ''
        WHEN 'SGD' THEN 'S$'
        WHEN 'HKD' THEN 'HK$'
        WHEN 'MYR' THEN 'RM'
        WHEN 'IDR' THEN 'Rp'
        WHEN 'PHP' THEN ''
        WHEN 'VND' THEN ''
        WHEN 'KRW' THEN ''
        WHEN 'PKR' THEN ''
        WHEN 'BDT' THEN ''
        WHEN 'LKR' THEN 'Rs'
        WHEN 'MMK' THEN 'K'
        
        ELSE currency
    END;
    
    -- If driver_id was found and status changed
    IF driver_id IS NOT NULL AND OLD.status != NEW.status THEN
        -- ========================================================================
        --  REVERTED: Handle accepted bid - SEND PICKUP PIN TO SHIPPER
        -- ========================================================================
        IF NEW.status = 'Accepted' THEN
            -- Notification to driver - inform them to get PIN from shipper
            PERFORM send_notification_with_preferences(
                driver_id,
                'bid_accepted',
                'Congratulations! Your bid of ' || currency_symbol || ROUND(bid_amount::NUMERIC, 2) || 
                ' for shipment "' || COALESCE(freight_description, 'Unknown') || 
                '" has been accepted! Contact the shipper to arrange pickup. ' ||
                'You will need to obtain the pickup PIN from the shipper when they are satisfied with the pickup process.',
                freight_id
            );
            
            --  REVERTED: Send pickup PIN to shipper immediately
            PERFORM send_notification_with_preferences(
                shipper_id,
                'bid_accepted',
                'You have accepted the bid of ' || currency_symbol || ROUND(bid_amount::NUMERIC, 2) || 
                ' for your shipment "' || COALESCE(freight_description, 'Unknown') || 
                '". The pickup PIN is: ' || pickup_pin || 
                '. Please provide this PIN to the driver once you are satisfied with the pickup process and the shipment is ready.',
                freight_id
            );
            
            RAISE NOTICE 'Bid accepted for shipment %, driver %, pickup PIN sent to shipper', 
                freight_id, driver_id;
        
        -- Handle declined bid
        ELSIF NEW.status = 'Declined' THEN
            PERFORM send_notification_with_preferences(
                driver_id,
                'bid_rejected',
                'Your bid of ' || currency_symbol || ROUND(bid_amount::NUMERIC, 2) || 
                ' for shipment "' || COALESCE(freight_description, 'Unknown') || '" has been declined.',
                freight_id
            );
            
            RAISE NOTICE 'Bid declined for shipment %, driver %', freight_id, driver_id;
        END IF;
    END IF; 
    
    RETURN NEW;
END;
$_$;


--
-- TOC entry 6024 (class 0 OID 0)
-- Dependencies: 1453
-- Name: FUNCTION handle_bid_status_change(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.handle_bid_status_change() IS 'Handles bid status changes. Pickup PIN is sent to shipper when bid is accepted so they can give it to driver when satisfied with pickup.';


--
-- TOC entry 1496 (class 1255 OID 477416)
-- Name: handle_bid_update(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.handle_bid_update() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    AS $_$
DECLARE
    v_message TEXT;
    v_shipper_id UUID;
    v_freight_description TEXT;
    v_driver_name TEXT;
    v_currency TEXT;
    v_currency_symbol TEXT;
    v_notification_id UUID;
    v_old_amount TEXT;
    v_new_amount TEXT;
BEGIN
    -- Only notify if bid_amount actually changed and bid is still Open
    IF NEW.bid_amount IS DISTINCT FROM OLD.bid_amount AND NEW.status = 'Open' THEN
        
        -- Get freight post and shipper details
        SELECT fp.shipper_id, fp.description, fp.currency
        INTO v_shipper_id, v_freight_description, v_currency
        FROM public.freight_posts fp
        WHERE fp.id = NEW.freight_post_id;

        -- Get driver name
        SELECT TRIM(CONCAT(u.first_name, ' ', u.last_name))
        INTO v_driver_name
        FROM public.users u
        JOIN public.vehicles v ON v.driver_id = u.id
        WHERE v.id = NEW.vehicle_id;

        -- Convert currency to symbol
        v_currency_symbol := CASE v_currency
            -- North America & Europe
            WHEN 'USD' THEN '$' WHEN 'EUR' THEN '' WHEN 'GBP' THEN ''
            WHEN 'CAD' THEN 'C$' WHEN 'CHF' THEN 'CHF' WHEN 'SEK' THEN 'kr'
            WHEN 'NOK' THEN 'kr' WHEN 'DKK' THEN 'kr' WHEN 'PLN' THEN 'z'
            -- South America
            WHEN 'BRL' THEN 'R$' WHEN 'ARS' THEN 'AR$' WHEN 'CLP' THEN 'CLP$'
            WHEN 'COP' THEN 'COL$' WHEN 'PEN' THEN 'S/' WHEN 'UYU' THEN 'UYU$'
            WHEN 'BOB' THEN 'Bs.' WHEN 'PYG' THEN '' WHEN 'VES' THEN 'Bs.'
            -- Africa
            WHEN 'ZAR' THEN 'R' WHEN 'EGP' THEN 'E' WHEN 'NGN' THEN ''
            WHEN 'KES' THEN 'KSh' WHEN 'TZS' THEN 'TSh' WHEN 'GHS' THEN 'GH'
            WHEN 'XAF' THEN 'CFA' WHEN 'XOF' THEN 'CFA' WHEN 'MZN' THEN 'MT'
            WHEN 'BWP' THEN 'P' WHEN 'ETB' THEN 'Br' WHEN 'MAD' THEN '..'
            WHEN 'DZD' THEN '' WHEN 'SDG' THEN 'SDG' WHEN 'RWF' THEN 'FRw'
            WHEN 'CDF' THEN 'FC' WHEN 'MWK' THEN 'MK' WHEN 'ZMW' THEN 'ZK'
            WHEN 'SSP' THEN ''
            -- Middle East
            WHEN 'SAR' THEN '' WHEN 'AED' THEN '.' WHEN 'QAR' THEN ''
            WHEN 'KWD' THEN 'KD' WHEN 'BHD' THEN 'BD' WHEN 'OMR' THEN ''
            WHEN 'IQD' THEN '.' WHEN 'IRR' THEN ''
            -- Asia
            WHEN 'JPY' THEN '' WHEN 'CNY' THEN '' WHEN 'INR' THEN ''
            WHEN 'SGD' THEN 'S$' WHEN 'HKD' THEN 'HK$' WHEN 'MYR' THEN 'RM'
            WHEN 'IDR' THEN 'Rp' WHEN 'PHP' THEN '' WHEN 'VND' THEN ''
            WHEN 'KRW' THEN '' WHEN 'PKR' THEN '' WHEN 'BDT' THEN ''
            WHEN 'LKR' THEN 'Rs' WHEN 'MMK' THEN 'K'
            ELSE v_currency
        END;

        -- Format amounts
        v_old_amount := v_currency_symbol || ROUND(OLD.bid_amount::NUMERIC, 2);
        v_new_amount := v_currency_symbol || ROUND(NEW.bid_amount::NUMERIC, 2);

        -- Build message based on whether bid increased or decreased
        IF NEW.bid_amount < OLD.bid_amount THEN
            v_message := COALESCE(v_driver_name, 'A driver') || 
                         ' lowered their bid from ' || v_old_amount || ' to ' || v_new_amount ||
                         ' on your shipment "' || COALESCE(v_freight_description, 'Unknown') || '"';
        ELSE
            v_message := COALESCE(v_driver_name, 'A driver') || 
                         ' updated their bid from ' || v_old_amount || ' to ' || v_new_amount ||
                         ' on your shipment "' || COALESCE(v_freight_description, 'Unknown') || '"';
        END IF;

        -- Send notification via centralized function (handles FCM + in-app)
        SELECT send_notification_with_preferences(
            v_shipper_id,
            'bid_updated',
            v_message,
            NEW.freight_post_id
        ) INTO v_notification_id;

        RAISE LOG 'Bid update notification sent! Bid: %, Old: %, New: %, Notification: %', 
            NEW.id, OLD.bid_amount, NEW.bid_amount, v_notification_id;
    END IF;

    RETURN NEW;
END;
$_$;


--
-- TOC entry 6025 (class 0 OID 0)
-- Dependencies: 1496
-- Name: FUNCTION handle_bid_update(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.handle_bid_update() IS 'Handles bid amount updates. Notifies shipper when a driver changes their bid amount. Routes through send_notification_with_preferences for FCM/SMS support.';


--
-- TOC entry 1441 (class 1255 OID 258944)
-- Name: handle_driver_registration(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.handle_driver_registration() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
    v_message TEXT;
    v_shipper_record RECORD;
    v_nearby_shipper_message TEXT;
    v_driver_name TEXT;
BEGIN
    -- Get driver name for notifications
    v_driver_name := TRIM(CONCAT(NEW.first_name, ' ', NEW.last_name));
    
    -- Check if role changed from non-Driver to Driver OR driver was verified
    IF (OLD.role != 'Driver' AND NEW.role = 'Driver') OR
       (OLD.driver_verified_at IS NULL AND NEW.driver_verified_at IS NOT NULL) THEN
        
        v_message := 'Congratulations! You are now registered as a driver and can start bidding on shipments.';
        
        --  UPDATED: Notify the new driver via send_notification_with_preferences
        PERFORM send_notification_with_preferences(
            NEW.id,
            'driver_registered',
            v_message,
            NEW.id
        );
        
        -- Notify nearby shippers about new driver availability (if driver has address)
        IF NEW.address IS NOT NULL THEN
            v_nearby_shipper_message := 'A new driver has registered in your area: ' || COALESCE(v_driver_name, 'Driver');
            
            -- Find shippers within 100km radius
            FOR v_shipper_record IN
                SELECT DISTINCT u.id
                FROM public.users u
                WHERE u.role = 'Shipper'
                AND u.address IS NOT NULL
                AND u.id != NEW.id  -- Don't notify the driver themselves
                AND ST_DWithin(
                    ST_Transform(u.address, 3857),
                    ST_Transform(NEW.address, 3857),
                    100000  -- 100km in meters
                )
            LOOP
                --  UPDATED: Notify shippers via send_notification_with_preferences
                PERFORM send_notification_with_preferences(
                    v_shipper_record.id,
                    'driver_registered',
                    v_nearby_shipper_message,
                    NEW.id
                );
            END LOOP;
        END IF;
    END IF;
    
    RETURN NEW;
END;
$$;


--
-- TOC entry 6026 (class 0 OID 0)
-- Dependencies: 1441
-- Name: FUNCTION handle_driver_registration(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.handle_driver_registration() IS 'Handles driver registration notifications. Notifies the new driver and nearby shippers. Routes through send_notification_with_preferences for FCM/SMS support.';


--
-- TOC entry 1498 (class 1255 OID 112529)
-- Name: handle_freight_status_change(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.handle_freight_status_change() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
    v_driver_id uuid;
    v_shipper_id uuid;
    v_driver_name text;
    v_driver_phone text;
    v_shipper_name text;
    v_shipper_phone text;
    v_freight_description text;
BEGIN
    -- Get shipper_id from freight_post
    v_shipper_id := NEW.shipper_id;

    -- Get driver_id by joining bids and vehicle tables - only if needed
    IF NEW.status IN ('Pickup', 'OnRoute', 'Delivered', 'Cancelled') THEN
        SELECT v.driver_id
        INTO v_driver_id
        FROM public.bids b
        JOIN public.vehicles v ON b.vehicle_id = v.id
        WHERE b.freight_post_id = NEW.id
        AND b.status = 'Accepted'
        LIMIT 1;
    END IF;

    -- Get shipper details
    SELECT CONCAT(first_name, ' ', last_name), phone_number
    INTO v_shipper_name, v_shipper_phone
    FROM public.users
    WHERE id = v_shipper_id;

    -- Get freight description
    v_freight_description := COALESCE(NEW.description, 'Unknown');

    -- Only get driver details if we have a driver_id
    IF v_driver_id IS NOT NULL THEN
        SELECT CONCAT(first_name, ' ', last_name), phone_number
        INTO v_driver_name, v_driver_phone
        FROM public.users
        WHERE id = v_driver_id;
    END IF;

    -- ========================================================================
    -- Handle Pickup status change - REMINDER ONLY (PIN already sent)
    -- ========================================================================
    IF NEW.status = 'Pickup' AND OLD.status != 'Pickup' THEN
        IF v_driver_id IS NOT NULL THEN
            -- Notification to driver - reminder about PIN
            PERFORM send_notification_with_preferences(
                v_driver_id,
                'pickup_confirmed',
                'Shipment "' || v_freight_description || '" is ready for pickup! ' ||
                'Contact shipper: ' || v_shipper_name || ' (' || v_shipper_phone || ') to coordinate pickup. ' ||
                'Remember to get the pickup PIN from the shipper when they are satisfied with the pickup process.',
                NEW.id
            );

            -- Notification to shipper - reminder
            PERFORM send_notification_with_preferences(
                v_shipper_id,
                'pickup_confirmed',
                'Your shipment "' || v_freight_description || '" is now ready for pickup by driver ' ||
                v_driver_name || '. Remember to provide the pickup PIN to the driver once you are satisfied ' ||
                'with the pickup process. Driver contact: ' || v_driver_phone,
                NEW.id
            );

            RAISE NOTICE 'Pickup status set for shipment %, reminders sent', NEW.id;
        END IF;

    -- ========================================================================
    -- Handle OnRoute status change
    -- NOTE: Tracking is now managed by driver app, not auto-created
    -- ========================================================================
    ELSIF NEW.status = 'OnRoute' AND OLD.status != 'OnRoute' THEN
        IF v_driver_id IS NOT NULL THEN
            -- Notification to driver
            PERFORM send_notification_with_preferences(
                v_driver_id,
                'delivery_started',
                'You have entered the correct pickup pin for shipment "' || v_freight_description ||
                '" the shipment''s status has been updated to On Route. Make sure tracking is active in your app.',
                NEW.id
            );

            -- Notification to shipper with delivery PIN
            PERFORM send_notification_with_preferences(
                v_shipper_id,
                'delivery_started',
                'Driver ' || v_driver_name || ' has entered the correct pickup pin for shipment "' ||
                v_freight_description || '" and is now en route. Real-time tracking is available in the app. ' ||
                'The delivery PIN is: ' || NEW.delivery_pin ||
                '. Please provide this PIN to the driver upon satisfactory delivery completion. Driver contact: ' ||
                v_driver_phone,
                NEW.id
            );

            RAISE NOTICE 'Shipment % status changed to OnRoute, notifications sent', NEW.id;
        END IF;

    -- ========================================================================
    -- Handle Delivered status change
    -- NOTE: Tracking cleanup is now handled by update_driver_shipment_status function
    -- ========================================================================
    ELSIF NEW.status = 'Delivered' AND OLD.status != 'Delivered' THEN
        IF v_driver_id IS NOT NULL THEN
            -- Notification to driver - delivery completed
            PERFORM send_notification_with_preferences(
                v_driver_id,
                'delivery_completed',
                'Delivery confirmed for shipment "' || v_freight_description ||
                '". Payment will be processed shortly. Thank you!',
                NEW.id
            );

            -- Notification to shipper - delivery completed
            PERFORM send_notification_with_preferences(
                v_shipper_id,
                'delivery_completed',
                'Your shipment "' || v_freight_description || '" has been delivered successfully by driver ' ||
                v_driver_name || '. Payment to driver will be processed.',
                NEW.id
            );

            RAISE NOTICE 'Delivery confirmed for shipment %', NEW.id;
        END IF;

    -- ========================================================================
    -- Handle Cancelled status change
    -- ========================================================================
    ELSIF NEW.status = 'Cancelled' AND OLD.status != 'Cancelled' THEN
        IF v_driver_id IS NOT NULL THEN
            -- Notification to driver
            PERFORM send_notification_with_preferences(
                v_driver_id,
                'shipment_cancelled',
                'Shipment "' || v_freight_description || '" has been cancelled.',
                NEW.id
            );
        END IF;

        -- Always notify shipper
        PERFORM send_notification_with_preferences(
            v_shipper_id,
            'shipment_cancelled',
            'Your shipment "' || v_freight_description || '" has been cancelled.',
            NEW.id
        );
    END IF;

    RETURN NEW;
END;
$$;


--
-- TOC entry 6027 (class 0 OID 0)
-- Dependencies: 1498
-- Name: FUNCTION handle_freight_status_change(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.handle_freight_status_change() IS 'Handles freight_posts status changes. Pickup PIN is sent when bid is accepted, not when status changes to Pickup. All notifications routed through send_notification_with_preferences for FCM/SMS support.';


--
-- TOC entry 1493 (class 1255 OID 258951)
-- Name: handle_new_bid(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.handle_new_bid() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    AS $_$
DECLARE
    v_message TEXT;
    v_shipper_id UUID;
    v_freight_description TEXT;
    v_driver_name TEXT;
    v_currency TEXT;
    v_currency_symbol TEXT;
    v_notification_id UUID;
BEGIN
    -- Only for new open bids
    IF NEW.status = 'Open' THEN
        -- Get freight post and shipper details
        SELECT fp.shipper_id, fp.description, fp.currency
        INTO v_shipper_id, v_freight_description, v_currency
        FROM public.freight_posts fp
        WHERE fp.id = NEW.freight_post_id;

        -- Get driver name
        SELECT TRIM(CONCAT(u.first_name, ' ', u.last_name))
        INTO v_driver_name
        FROM public.users u
        JOIN public.vehicles v ON v.driver_id = u.id
        WHERE v.id = NEW.vehicle_id;

        -- Convert currency to symbol
        v_currency_symbol := CASE v_currency
            -- North America & Europe
            WHEN 'USD' THEN '$' WHEN 'EUR' THEN '' WHEN 'GBP' THEN ''
            WHEN 'CAD' THEN 'C$' WHEN 'CHF' THEN 'CHF' WHEN 'SEK' THEN 'kr'
            WHEN 'NOK' THEN 'kr' WHEN 'DKK' THEN 'kr' WHEN 'PLN' THEN 'z'
            -- South America
            WHEN 'BRL' THEN 'R$' WHEN 'ARS' THEN 'AR$' WHEN 'CLP' THEN 'CLP$'
            WHEN 'COP' THEN 'COL$' WHEN 'PEN' THEN 'S/' WHEN 'UYU' THEN 'UYU$'
            WHEN 'BOB' THEN 'Bs.' WHEN 'PYG' THEN '' WHEN 'VES' THEN 'Bs.'
            -- Africa
            WHEN 'ZAR' THEN 'R' WHEN 'EGP' THEN 'E' WHEN 'NGN' THEN ''
            WHEN 'KES' THEN 'KSh' WHEN 'TZS' THEN 'TSh' WHEN 'GHS' THEN 'GH'
            WHEN 'XAF' THEN 'CFA' WHEN 'XOF' THEN 'CFA' WHEN 'MZN' THEN 'MT'
            WHEN 'BWP' THEN 'P' WHEN 'ETB' THEN 'Br' WHEN 'MAD' THEN '..'
            WHEN 'DZD' THEN '' WHEN 'SDG' THEN 'SDG' WHEN 'RWF' THEN 'FRw'
            WHEN 'CDF' THEN 'FC' WHEN 'MWK' THEN 'MK' WHEN 'ZMW' THEN 'ZK'
            WHEN 'SSP' THEN ''
            -- Middle East
            WHEN 'SAR' THEN '' WHEN 'AED' THEN '.' WHEN 'QAR' THEN ''
            WHEN 'KWD' THEN 'KD' WHEN 'BHD' THEN 'BD' WHEN 'OMR' THEN ''
            WHEN 'IQD' THEN '.' WHEN 'IRR' THEN ''
            -- Asia
            WHEN 'JPY' THEN '' WHEN 'CNY' THEN '' WHEN 'INR' THEN ''
            WHEN 'SGD' THEN 'S$' WHEN 'HKD' THEN 'HK$' WHEN 'MYR' THEN 'RM'
            WHEN 'IDR' THEN 'Rp' WHEN 'PHP' THEN '' WHEN 'VND' THEN ''
            WHEN 'KRW' THEN '' WHEN 'PKR' THEN '' WHEN 'BDT' THEN ''
            WHEN 'LKR' THEN 'Rs' WHEN 'MMK' THEN 'K'
            ELSE v_currency
        END;

        v_message := 'New bid received from ' || COALESCE(v_driver_name, 'Unknown Driver') ||
                     ' for ' || v_currency_symbol || ROUND(NEW.bid_amount::NUMERIC, 2) ||
                     ' on your shipment "' || COALESCE(v_freight_description, 'Unknown') || '"';

        --  FIX: Use send_notification_with_preferences instead of direct INSERT
        -- This will handle both in-app notifications AND FCM
        SELECT send_notification_with_preferences(
            v_shipper_id,
            'new_bid',
            v_message,
            NEW.freight_post_id  -- related_id
        ) INTO v_notification_id;

        RAISE LOG 'Bid notification sent! Notification ID: %', v_notification_id;
    END IF;

    RETURN NEW;
END;
$_$;


--
-- TOC entry 411 (class 1255 OID 258949)
-- Name: handle_new_shipment(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.handle_new_shipment() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
    v_drivers_notified INTEGER;
BEGIN
    -- Only notify for new bidding shipments that aren't archived
    IF NEW.status = 'Bidding' AND NOT NEW.archived THEN
        -- Notify drivers in the region
        SELECT notify_drivers_in_region(
            NEW.id,
            NEW.pickup_location,
            50,  -- 50km radius
            NEW.description
        ) INTO v_drivers_notified;
        
        -- Log the notification count (optional)
        RAISE LOG 'Notified % drivers about new shipment %', v_drivers_notified, NEW.id;
    END IF;
    
    RETURN NEW;
END;
$$;


--
-- TOC entry 412 (class 1255 OID 278696)
-- Name: handle_new_user_preferences(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.handle_new_user_preferences() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
    -- Create default preferences for new user
    PERFORM create_default_notification_preferences(NEW.id);
    RETURN NEW;
END;
$$;


--
-- TOC entry 1494 (class 1255 OID 258942)
-- Name: handle_profile_update(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.handle_profile_update() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
    v_message TEXT;
    v_changes TEXT[] := ARRAY[]::TEXT[];
BEGIN
    -- Only trigger if significant fields changed
    IF OLD.first_name IS DISTINCT FROM NEW.first_name OR OLD.last_name IS DISTINCT FROM NEW.last_name THEN
        v_changes := array_append(v_changes, 'name');
    END IF;
    
    IF OLD.email IS DISTINCT FROM NEW.email THEN
        v_changes := array_append(v_changes, 'email');
    END IF;
    
    IF OLD.dob IS DISTINCT FROM NEW.dob THEN
        v_changes := array_append(v_changes, 'date of birth');
    END IF;

    IF OLD.phone_number IS DISTINCT FROM NEW.phone_number THEN
        v_changes := array_append(v_changes, 'phone number');
    END IF;
    
    IF OLD.address IS DISTINCT FROM NEW.address OR OLD.address_name IS DISTINCT FROM NEW.address_name THEN
        v_changes := array_append(v_changes, 'address');
    END IF;
    
    IF OLD.bank_name IS DISTINCT FROM NEW.bank_name OR OLD.account_number IS DISTINCT FROM NEW.account_number OR OLD.branch_code IS DISTINCT FROM NEW.branch_code THEN
        v_changes := array_append(v_changes, 'banking details');
    END IF;
    
    -- If any significant changes occurred
    IF array_length(v_changes, 1) > 0 THEN
        v_message := 'Your profile has been successfully updated (' || array_to_string(v_changes, ', ') || ').';
        
        --  UPDATED: Route through send_notification_with_preferences for FCM support
        PERFORM send_notification_with_preferences(
            NEW.id,
            'profile_updated',
            v_message,
            NEW.id
        );
    END IF;
    
    RETURN NEW;
END;
$$;


--
-- TOC entry 6028 (class 0 OID 0)
-- Dependencies: 1494
-- Name: FUNCTION handle_profile_update(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.handle_profile_update() IS 'Handles profile update notifications. Routes through send_notification_with_preferences for FCM/SMS support.';


--
-- TOC entry 1440 (class 1255 OID 258956)
-- Name: handle_rating_received(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.handle_rating_received() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
    v_message TEXT;
    v_rater_name TEXT;
BEGIN
    -- Get the name of the person who gave the rating
    SELECT TRIM(CONCAT(first_name, ' ', last_name))
    INTO v_rater_name
    FROM public.users
    WHERE id = NEW.rated_by_user_id;
    
    v_message := COALESCE(v_rater_name, 'Someone') || ' has rated you ' || 
                 NEW.score || ' out of 5 stars';
    
    -- Add comment if provided
    IF NEW.comment IS NOT NULL AND TRIM(NEW.comment) != '' THEN
        v_message := v_message || ' with comment: "' || NEW.comment || '"';
    END IF;
    
    --  UPDATED: Route through send_notification_with_preferences for FCM support
    PERFORM send_notification_with_preferences(
        NEW.rated_user_id,
        'rated',
        v_message,
        NEW.freight_post_id
    );
    
    RETURN NEW;
END;
$$;


--
-- TOC entry 6029 (class 0 OID 0)
-- Dependencies: 1440
-- Name: FUNCTION handle_rating_received(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.handle_rating_received() IS 'Handles new rating notifications. Routes through send_notification_with_preferences for FCM/SMS support.';


--
-- TOC entry 1438 (class 1255 OID 258946)
-- Name: handle_vehicle_added(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.handle_vehicle_added() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
    v_message TEXT;
    v_driver_name TEXT;
BEGIN
    -- Get driver name (optional, for logging)
    SELECT TRIM(CONCAT(first_name, ' ', last_name))
    INTO v_driver_name
    FROM public.users
    WHERE id = NEW.driver_id;
    
    v_message := 'Your new vehicle (' || NEW.make || ' ' || NEW.model || 
                 ') has been successfully added and you can now start bidding on shipments.';
    
    --  UPDATED: Route through send_notification_with_preferences for FCM support
    PERFORM send_notification_with_preferences(
        NEW.driver_id,
        'vehicle_added',
        v_message,
        NEW.id
    );
    
    RETURN NEW;
END;
$$;


--
-- TOC entry 6030 (class 0 OID 0)
-- Dependencies: 1438
-- Name: FUNCTION handle_vehicle_added(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.handle_vehicle_added() IS 'Handles vehicle added notifications. Routes through send_notification_with_preferences for FCM/SMS support.';


--
-- TOC entry 1417 (class 1255 OID 373643)
-- Name: is_driver_in_geofence(uuid, public.geometry, double precision); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.is_driver_in_geofence(p_tracking_id uuid, p_target_location public.geometry, p_radius_meters double precision DEFAULT 100.0) RETURNS boolean
    LANGUAGE plpgsql
    AS $$
DECLARE
    driver_location geometry;
    is_inside boolean;
BEGIN
    SELECT location INTO driver_location
    FROM tracking_points
    WHERE tracking_id = p_tracking_id
    ORDER BY "timestamp" DESC
    LIMIT 1;
    
    IF driver_location IS NULL THEN
        RETURN false;
    END IF;
    
    SELECT ST_DWithin(
        driver_location::geography,
        p_target_location::geography,
        p_radius_meters
    ) INTO is_inside;
    
    RETURN is_inside;
END;
$$;


--
-- TOC entry 6031 (class 0 OID 0)
-- Dependencies: 1417
-- Name: FUNCTION is_driver_in_geofence(p_tracking_id uuid, p_target_location public.geometry, p_radius_meters double precision); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.is_driver_in_geofence(p_tracking_id uuid, p_target_location public.geometry, p_radius_meters double precision) IS 'Check if driver is within specified radius of target location using geodesic distance';


--
-- TOC entry 1470 (class 1255 OID 511916)
-- Name: log_admin_action(uuid, text, text, uuid, jsonb, jsonb, inet, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.log_admin_action(p_admin_id uuid, p_action text, p_target_type text, p_target_id uuid DEFAULT NULL::uuid, p_old_values jsonb DEFAULT NULL::jsonb, p_new_values jsonb DEFAULT NULL::jsonb, p_ip_address inet DEFAULT NULL::inet, p_user_agent text DEFAULT NULL::text) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
    v_log_id UUID;
BEGIN
    INSERT INTO public.admin_audit_logs (
        admin_id, action, target_type, target_id, 
        old_values, new_values, ip_address, user_agent
    ) VALUES (
        p_admin_id, p_action, p_target_type, p_target_id,
        p_old_values, p_new_values, p_ip_address, p_user_agent
    ) RETURNING id INTO v_log_id;
    
    RETURN v_log_id;
END;
$$;


--
-- TOC entry 1495 (class 1255 OID 119876)
-- Name: lr_cancel_bid(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.lr_cancel_bid(p_bid_id uuid) RETURNS boolean
    LANGUAGE plpgsql SECURITY DEFINER
    AS $_$
DECLARE
  v_driver_id uuid;
  v_shipper_id uuid;
  v_vehicle_id uuid;
  v_freight_post_id uuid;
  v_bid_amount numeric;
  v_currency text;
  v_freight_description text;
  v_driver_name text;
  v_currency_symbol text;
BEGIN
  -- Get the bid details
  SELECT 
    b.vehicle_id, 
    b.freight_post_id, 
    b.bid_amount
  INTO 
    v_vehicle_id, 
    v_freight_post_id, 
    v_bid_amount
  FROM 
    public.bids b
  WHERE 
    b.id = p_bid_id;
    
  -- If bid not found, return false
  IF v_freight_post_id IS NULL THEN
    RETURN false;
  END IF;
  
  -- Get the driver ID from vehicles table
  SELECT 
    v.driver_id
  INTO 
    v_driver_id
  FROM 
    public.vehicles v
  WHERE 
    v.id = v_vehicle_id;
    
  -- Get the freight post details (shipper_id, description, currency)
  SELECT 
    fp.shipper_id,
    fp.description,
    fp.currency
  INTO 
    v_shipper_id,
    v_freight_description,
    v_currency
  FROM 
    public.freight_posts fp
  WHERE 
    fp.id = v_freight_post_id;
    
  -- Get the driver's name
  SELECT 
    TRIM(CONCAT(u.first_name, ' ', u.last_name))
  INTO 
    v_driver_name
  FROM 
    public.users u
  WHERE 
    u.id = v_driver_id;
    
  -- Convert currency code to symbol
  v_currency_symbol := CASE v_currency
      -- North America & Europe
      WHEN 'USD' THEN '$'
      WHEN 'EUR' THEN ''
      WHEN 'GBP' THEN ''
      WHEN 'CAD' THEN 'C$'
      WHEN 'CHF' THEN 'CHF'
      WHEN 'SEK' THEN 'kr'
      WHEN 'NOK' THEN 'kr'
      WHEN 'DKK' THEN 'kr'
      WHEN 'PLN' THEN 'z'
      
      -- South America
      WHEN 'BRL' THEN 'R$'
      WHEN 'ARS' THEN 'AR$'
      WHEN 'CLP' THEN 'CLP$'
      WHEN 'COP' THEN 'COL$'
      WHEN 'PEN' THEN 'S/'
      WHEN 'UYU' THEN 'UYU$'
      WHEN 'BOB' THEN 'Bs.'
      WHEN 'PYG' THEN ''
      WHEN 'VES' THEN 'Bs.'

      -- Africa
      WHEN 'ZAR' THEN 'R'
      WHEN 'EGP' THEN 'E'
      WHEN 'NGN' THEN ''
      WHEN 'KES' THEN 'KSh'
      WHEN 'TZS' THEN 'TSh'
      WHEN 'GHS' THEN 'GH'
      WHEN 'XAF' THEN 'CFA'
      WHEN 'XOF' THEN 'CFA'
      WHEN 'MZN' THEN 'MT'
      WHEN 'BWP' THEN 'P'
      WHEN 'ETB' THEN 'Br'
      WHEN 'MAD' THEN '..'
      WHEN 'DZD' THEN ''
      WHEN 'SDG' THEN 'SDG'
      WHEN 'RWF' THEN 'FRw'
      WHEN 'CDF' THEN 'FC'
      WHEN 'MWK' THEN 'MK'
      WHEN 'ZMW' THEN 'ZK'
      WHEN 'SSP' THEN ''

      -- Middle East
      WHEN 'SAR' THEN '.'
      WHEN 'AED' THEN '.'
      WHEN 'QAR' THEN '.'
      WHEN 'KWD' THEN 'KD'
      WHEN 'BHD' THEN 'BD'
      WHEN 'OMR' THEN '.'
      WHEN 'IQD' THEN '.'
      WHEN 'IRR' THEN '.'

      -- Asia
      WHEN 'JPY' THEN ''
      WHEN 'CNY' THEN ''
      WHEN 'INR' THEN ''
      WHEN 'SGD' THEN 'S$'
      WHEN 'HKD' THEN 'HK$'
      WHEN 'MYR' THEN 'RM'
      WHEN 'IDR' THEN 'Rp'
      WHEN 'PHP' THEN ''
      WHEN 'VND' THEN ''
      WHEN 'KRW' THEN ''
      WHEN 'PKR' THEN ''
      WHEN 'BDT' THEN ''
      WHEN 'LKR' THEN 'Rs'
      WHEN 'MMK' THEN 'K'
      WHEN 'THB' THEN ''
      WHEN 'TWD' THEN 'NT$'

      -- Oceania
      WHEN 'AUD' THEN 'A$'
      WHEN 'NZD' THEN 'NZ$'
      WHEN 'FJD' THEN 'FJ$'
      
      ELSE v_currency
  END;
  
  -- Update bid status to 'Cancelled'
  UPDATE public.bids
  SET 
    status = 'Cancelled',
    modified_at = NOW()
  WHERE id = p_bid_id;
  
  --  UPDATED: Notify driver via send_notification_with_preferences
  PERFORM send_notification_with_preferences(
    v_driver_id,
    'bid_cancelled',
    'You have cancelled your bid of ' || v_currency_symbol || ROUND(v_bid_amount::numeric, 2) || 
    ' for shipment "' || COALESCE(v_freight_description, 'Unknown') || '".',
    v_freight_post_id
  );
  
  --  UPDATED: Notify shipper via send_notification_with_preferences
  PERFORM send_notification_with_preferences(
    v_shipper_id,
    'bid_cancelled',
    'Driver ' || COALESCE(v_driver_name, 'Unknown') || ' has cancelled their bid of ' || 
    v_currency_symbol || ROUND(v_bid_amount::numeric, 2) || 
    ' for your shipment "' || COALESCE(v_freight_description, 'Unknown') || '".',
    v_freight_post_id
  );
  
  RETURN true;
END;
$_$;


--
-- TOC entry 6032 (class 0 OID 0)
-- Dependencies: 1495
-- Name: FUNCTION lr_cancel_bid(p_bid_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.lr_cancel_bid(p_bid_id uuid) IS 'Cancels a bid by updating its status to Cancelled and notifies both driver and shipper. Routes through send_notification_with_preferences for FCM/SMS support.';


--
-- TOC entry 1007 (class 1255 OID 164936)
-- Name: lr_debug_jwt_claims(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.lr_debug_jwt_claims() RETURNS jsonb
    LANGUAGE sql SECURITY DEFINER
    AS $$
  SELECT 
    jsonb_build_object(
      'jwt_claims', current_setting('request.jwt.claims', true)::jsonb,
      'auth_uid', auth.uid(),
      'request_headers', current_setting('request.headers', true)::jsonb
    );
$$;


--
-- TOC entry 576 (class 1255 OID 119998)
-- Name: lr_run_housekeeping_rules(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.lr_run_housekeeping_rules() RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $_$
DECLARE
  -- Configuration variables for expiration times
  v_post_delivery_expiry_period INTERVAL := INTERVAL '7 days';
  v_cancelled_bid_retention_period INTERVAL := INTERVAL '7 days';
  
  -- Variables for processing
  v_driver_id UUID;
  v_freight_id UUID;
  v_freight_description TEXT;
  v_currency TEXT;
  v_bid_amount NUMERIC;
  v_currency_symbol TEXT;
  v_notification_message TEXT;
  v_shipper_id UUID;
  v_count INT;
  v_deleted_count INT;
  
  -- Records for loop iterations
  bid_rec RECORD;
  freight_rec RECORD;
  bid_record RECORD;
  
  -- Cursor for expired bids based on delivery_time_window
  expired_bids CURSOR FOR
    SELECT 
      b.id AS bid_id, 
      b.freight_post_id, 
      b.bid_amount,
      fp.description AS freight_description,
      fp.currency,
      v.driver_id
    FROM 
      public.bids b
    JOIN 
      public.vehicles v ON b.vehicle_id = v.id
    JOIN 
      public.freight_posts fp ON b.freight_post_id = fp.id
    WHERE 
      b.status = 'Open' 
      AND fp.status = 'Bidding'
      -- Check if delivery window upper bound + 7 days is in the past
      AND (upper(fp.delivery_time_window) + v_post_delivery_expiry_period) < NOW();

  -- Cursor for expired freight posts based on delivery_time_window
  expired_freights CURSOR FOR
    SELECT 
      fp.id, 
      fp.description,
      fp.shipper_id,
      fp.currency
    FROM 
      public.freight_posts fp
    WHERE 
      fp.status = 'Bidding' 
      AND fp.archived = false
      -- Check if delivery window upper bound + 7 days is in the past
      AND (upper(fp.delivery_time_window) + v_post_delivery_expiry_period) < NOW();

BEGIN
  -- Part 1: Process expired bids
  FOR bid_rec IN expired_bids LOOP
    -- Convert currency code to symbol
    v_currency_symbol := CASE bid_rec.currency
        -- North America & Europe
        WHEN 'USD' THEN '$'
        WHEN 'EUR' THEN ''
        WHEN 'GBP' THEN ''
        WHEN 'CAD' THEN 'C$'
        WHEN 'CHF' THEN 'CHF'
        WHEN 'SEK' THEN 'kr'
        WHEN 'NOK' THEN 'kr'
        WHEN 'DKK' THEN 'kr'
        WHEN 'PLN' THEN 'z'
      
        -- South America
        WHEN 'BRL' THEN 'R$'
        WHEN 'ARS' THEN 'AR$'
        WHEN 'CLP' THEN 'CLP$'
        WHEN 'COP' THEN 'COL$'
        WHEN 'PEN' THEN 'S/'
        WHEN 'UYU' THEN 'UYU$'
        WHEN 'BOB' THEN 'Bs.'
        WHEN 'PYG' THEN ''
        WHEN 'VES' THEN 'Bs.'

        -- Africa
        WHEN 'ZAR' THEN 'R'
        WHEN 'EGP' THEN 'E'
        WHEN 'NGN' THEN ''
        WHEN 'KES' THEN 'KSh'
        WHEN 'TZS' THEN 'TSh'
        WHEN 'GHS' THEN 'GH'
        WHEN 'XAF' THEN 'CFA'
        WHEN 'XOF' THEN 'CFA'
        WHEN 'MZN' THEN 'MT'
        WHEN 'BWP' THEN 'P'
        WHEN 'ETB' THEN 'Br'
        WHEN 'MAD' THEN '..'
        WHEN 'DZD' THEN ''
        WHEN 'SDG' THEN 'SDG'
        WHEN 'RWF' THEN 'FRw'
        WHEN 'CDF' THEN 'FC'
        WHEN 'MWK' THEN 'MK'
        WHEN 'ZMW' THEN 'ZK'
        WHEN 'SSP' THEN ''

        -- Middle East
        WHEN 'SAR' THEN '.'
        WHEN 'AED' THEN '.'
        WHEN 'QAR' THEN '.'
        WHEN 'KWD' THEN 'KD'
        WHEN 'BHD' THEN 'BD'
        WHEN 'OMR' THEN '.'
        WHEN 'IQD' THEN '.'
        WHEN 'IRR' THEN '.'

        -- Asia
        WHEN 'JPY' THEN ''
        WHEN 'CNY' THEN ''
        WHEN 'INR' THEN ''
        WHEN 'SGD' THEN 'S$'
        WHEN 'HKD' THEN 'HK$'
        WHEN 'MYR' THEN 'RM'
        WHEN 'IDR' THEN 'Rp'
        WHEN 'PHP' THEN ''
        WHEN 'VND' THEN ''
        WHEN 'KRW' THEN ''
        WHEN 'PKR' THEN ''
        WHEN 'BDT' THEN ''
        WHEN 'LKR' THEN 'Rs'
        WHEN 'MMK' THEN 'K'
        WHEN 'THB' THEN ''
        WHEN 'TWD' THEN 'NT$'

        -- Oceania
        WHEN 'AUD' THEN 'A$'
        WHEN 'NZD' THEN 'NZ$'
        WHEN 'FJD' THEN 'FJ$'

        ELSE bid_rec.currency
    END;
    
    -- Update bid status to Expired
    UPDATE public.bids
    SET 
      status = 'Expired',
      modified_at = NOW()
    WHERE id = bid_rec.bid_id;
    
    --  UPDATED: Notify driver via send_notification_with_preferences
    PERFORM send_notification_with_preferences(
      bid_rec.driver_id,
      'bid_expired',
      'Your bid of ' || v_currency_symbol || ROUND(bid_rec.bid_amount::NUMERIC, 2) || 
      ' for shipment "' || COALESCE(bid_rec.freight_description, 'Unknown') || 
      '" has expired without a response.',
      bid_rec.freight_post_id
    );
  END LOOP;

  -- Part 2: Process expired freight posts
  FOR freight_rec IN expired_freights LOOP
    -- Update freight post status to Cancelled
    UPDATE public.freight_posts
    SET 
      status = 'Cancelled',
      updated_at = NOW()
    WHERE id = freight_rec.id;
    
    --  UPDATED: Notify shipper via send_notification_with_preferences
    PERFORM send_notification_with_preferences(
      freight_rec.shipper_id,
      'shipment_cancelled',
      'Your shipment "' || COALESCE(freight_rec.description, 'Unknown') || 
      '" has been automatically cancelled due to inactivity.',
      freight_rec.id
    );
    
    -- Get related bids and notify drivers
    FOR bid_record IN (
      SELECT 
        b.id,
        b.bid_amount,
        v.driver_id,
        freight_rec.currency,
        freight_rec.description
      FROM 
        public.bids b
      JOIN 
        public.vehicles v ON b.vehicle_id = v.id
      WHERE 
        b.freight_post_id = freight_rec.id
        AND b.status = 'Open'
    ) LOOP
      -- Convert currency code to symbol
      v_currency_symbol := CASE freight_rec.currency
          -- North America & Europe
          WHEN 'USD' THEN '$'
          WHEN 'EUR' THEN ''
          WHEN 'GBP' THEN ''
          WHEN 'CAD' THEN 'C$'
          WHEN 'CHF' THEN 'CHF'
          WHEN 'SEK' THEN 'kr'
          WHEN 'NOK' THEN 'kr'
          WHEN 'DKK' THEN 'kr'
          WHEN 'PLN' THEN 'z'
      
          -- South America
          WHEN 'BRL' THEN 'R$'
          WHEN 'ARS' THEN 'AR$'
          WHEN 'CLP' THEN 'CLP$'
          WHEN 'COP' THEN 'COL$'
          WHEN 'PEN' THEN 'S/'
          WHEN 'UYU' THEN 'UYU$'
          WHEN 'BOB' THEN 'Bs.'
          WHEN 'PYG' THEN ''
          WHEN 'VES' THEN 'Bs.'

          -- Africa
          WHEN 'ZAR' THEN 'R'
          WHEN 'EGP' THEN 'E'
          WHEN 'NGN' THEN ''
          WHEN 'KES' THEN 'KSh'
          WHEN 'TZS' THEN 'TSh'
          WHEN 'GHS' THEN 'GH'
          WHEN 'XAF' THEN 'CFA'
          WHEN 'XOF' THEN 'CFA'
          WHEN 'MZN' THEN 'MT'
          WHEN 'BWP' THEN 'P'
          WHEN 'ETB' THEN 'Br'
          WHEN 'MAD' THEN '..'
          WHEN 'DZD' THEN ''
          WHEN 'SDG' THEN 'SDG'
          WHEN 'RWF' THEN 'FRw'
          WHEN 'CDF' THEN 'FC'
          WHEN 'MWK' THEN 'MK'
          WHEN 'ZMW' THEN 'ZK'
          WHEN 'SSP' THEN ''

          -- Middle East
          WHEN 'SAR' THEN '.'
          WHEN 'AED' THEN '.'
          WHEN 'QAR' THEN '.'
          WHEN 'KWD' THEN 'KD'
          WHEN 'BHD' THEN 'BD'
          WHEN 'OMR' THEN '.'
          WHEN 'IQD' THEN '.'
          WHEN 'IRR' THEN '.'

          -- Asia
          WHEN 'JPY' THEN ''
          WHEN 'CNY' THEN ''
          WHEN 'INR' THEN ''
          WHEN 'SGD' THEN 'S$'
          WHEN 'HKD' THEN 'HK$'
          WHEN 'MYR' THEN 'RM'
          WHEN 'IDR' THEN 'Rp'
          WHEN 'PHP' THEN ''
          WHEN 'VND' THEN ''
          WHEN 'KRW' THEN ''
          WHEN 'PKR' THEN ''
          WHEN 'BDT' THEN ''
          WHEN 'LKR' THEN 'Rs'
          WHEN 'MMK' THEN 'K'
          WHEN 'THB' THEN ''
          WHEN 'TWD' THEN 'NT$'

          -- Oceania
          WHEN 'AUD' THEN 'A$'
          WHEN 'NZD' THEN 'NZ$'
          WHEN 'FJD' THEN 'FJ$'
 
          ELSE freight_rec.currency
      END;
      
      -- Update bid status to Expired
      UPDATE public.bids
      SET 
        status = 'Expired',
        modified_at = NOW()
      WHERE id = bid_record.id;
      
      --  UPDATED: Notify driver via send_notification_with_preferences
      PERFORM send_notification_with_preferences(
        bid_record.driver_id,
        'shipment_cancelled',
        'The shipment "' || COALESCE(freight_rec.description, 'Unknown') || 
        '" that you bid ' || v_currency_symbol || ROUND(bid_record.bid_amount::NUMERIC, 2) || 
        ' on has been cancelled.',
        freight_rec.id
      );
    END LOOP;
  END LOOP;

  -- Part 3: Delete cancelled bids that are older than 7 days
  DELETE FROM public.bids
  WHERE 
    status = 'Cancelled' 
    AND modified_at < NOW() - v_cancelled_bid_retention_period;
    
  GET DIAGNOSTICS v_deleted_count = ROW_COUNT;
  RAISE NOTICE 'Deleted % cancelled bids older than % days', v_deleted_count, EXTRACT(DAY FROM v_cancelled_bid_retention_period);
  
  -- Log housekeeping run
  GET DIAGNOSTICS v_count = ROW_COUNT;
  RAISE NOTICE 'Housekeeping completed: % records processed', v_count;
END;
$_$;


--
-- TOC entry 6033 (class 0 OID 0)
-- Dependencies: 576
-- Name: FUNCTION lr_run_housekeeping_rules(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.lr_run_housekeeping_rules() IS 'Runs housekeeping tasks: expires old bids, cancels stale shipments, cleans up cancelled bids. Routes notifications through send_notification_with_preferences for FCM/SMS support.';


--
-- TOC entry 495 (class 1255 OID 125794)
-- Name: lr_set_confirmation(text, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.lr_set_confirmation(phone_number text, code text) RETURNS text
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  IF current_setting('request.jwt.claims', true)::jsonb->>'role' = 'service_role' THEN
    UPDATE auth.users
    SET confirmation_sent_at = now(),
        confirmation_token = encode(sha224(concat(phone_number, code)::bytea), 'hex')
    WHERE auth.users.phone = phone_number;
    RETURN 'done!';
  ELSE
    RAISE EXCEPTION 'Not Allowed';
  END IF;
END;
$$;


--
-- TOC entry 1476 (class 1255 OID 522119)
-- Name: notify_all_admins(public.notification_type, text, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.notify_all_admins(p_notification_type public.notification_type, p_message text, p_related_id uuid DEFAULT NULL::uuid) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
    v_admin RECORD;
BEGIN
    FOR v_admin IN
        SELECT id FROM public.users WHERE role = 'Admin'
    LOOP
        PERFORM send_notification_with_preferences(
            v_admin.id,
            p_notification_type,
            p_message,
            p_related_id
        );
    END LOOP;
END;
$$;


--
-- TOC entry 1492 (class 1255 OID 466109)
-- Name: notify_drivers_in_region(uuid, public.geometry); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.notify_drivers_in_region(p_freight_post_id uuid, p_pickup_location public.geometry) RETURNS integer
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
    v_driver_count INTEGER := 0;
    v_driver_record RECORD;
    v_message TEXT;
    v_shipper_id UUID;
    v_notification_id UUID;
BEGIN
    -- Get shipper_id to exclude from notifications
    SELECT shipper_id INTO v_shipper_id
    FROM public.freight_posts
    WHERE id = p_freight_post_id;

    v_message := 'New shipment available in your area';

    -- Find drivers within their custom radius
    FOR v_driver_record IN
        SELECT DISTINCT u.id as driver_id,
               COALESCE(u.notification_radius_km, 100) as radius_km
        FROM public.users u
        JOIN public.vehicles v ON v.driver_id = u.id
        WHERE u.role = 'Driver'
        AND u.address IS NOT NULL
        AND u.id != COALESCE(v_shipper_id, '00000000-0000-0000-0000-000000000000'::uuid)
        AND ST_DWithin(
            ST_Transform(u.address, 3857),
            ST_Transform(p_pickup_location, 3857),
            COALESCE(u.notification_radius_km, 100) * 1000  -- Convert km to meters
        )
    LOOP
        -- Use send_notification_with_preferences instead of direct INSERT
        BEGIN
            SELECT send_notification_with_preferences(
                v_driver_record.driver_id,
                'new_shipment',
                v_message,
                p_freight_post_id
            ) INTO v_notification_id;

            -- Only count if notification was actually created
            IF v_notification_id IS NOT NULL THEN
                v_driver_count := v_driver_count + 1;
            END IF;

        EXCEPTION WHEN OTHERS THEN
            RAISE LOG 'Error notifying driver %: %', v_driver_record.driver_id, SQLERRM;
        END;
    END LOOP;

    RETURN v_driver_count;
END;
$$;


--
-- TOC entry 1491 (class 1255 OID 466108)
-- Name: notify_drivers_in_region(uuid, public.geometry, numeric, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.notify_drivers_in_region(p_freight_post_id uuid, p_pickup_location public.geometry, p_radius_km numeric DEFAULT 50, p_description text DEFAULT NULL::text) RETURNS integer
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
    v_driver_count INTEGER := 0;
    v_driver_record RECORD;
    v_message TEXT;
    v_shipper_id UUID;
    v_notification_id UUID;
BEGIN
    -- Get shipper_id to exclude from notifications
    SELECT shipper_id INTO v_shipper_id
    FROM public.freight_posts
    WHERE id = p_freight_post_id;

    v_message := 'New shipment available in your area: "' || COALESCE(p_description, 'Unknown') || '"';

    -- Find drivers within radius who have vehicles and aren't the shipper
    FOR v_driver_record IN
        SELECT DISTINCT u.id as driver_id
        FROM public.users u
        JOIN public.vehicles v ON v.driver_id = u.id
        WHERE u.role = 'Driver'
        AND u.address IS NOT NULL
        AND u.id != COALESCE(v_shipper_id, '00000000-0000-0000-0000-000000000000'::uuid)
        AND ST_DWithin(
            ST_Transform(u.address, 3857),
            ST_Transform(p_pickup_location, 3857),
            p_radius_km * 1000  -- Convert km to meters
        )
    LOOP
        -- Use send_notification_with_preferences instead of direct INSERT
        -- This will check user preferences and send FCM/SMS accordingly
        BEGIN
            SELECT send_notification_with_preferences(
                v_driver_record.driver_id,
                'new_shipment',
                v_message,
                p_freight_post_id
            ) INTO v_notification_id;

            -- Only count if notification was actually created (user didn't disable both)
            IF v_notification_id IS NOT NULL THEN
                v_driver_count := v_driver_count + 1;
            END IF;

        EXCEPTION WHEN OTHERS THEN
            -- Log error but continue processing other drivers
            RAISE LOG 'Error notifying driver %: %', v_driver_record.driver_id, SQLERRM;
        END;
    END LOOP;

    RETURN v_driver_count;
END;
$$;


--
-- TOC entry 1443 (class 1255 OID 270976)
-- Name: process_sms_notification(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.process_sms_notification() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
    v_user_phone text;
    v_request_id bigint;
    v_request_body jsonb;
    v_request_url text;
    v_service_key text;
BEGIN
    -- Only process new notifications that include SMS delivery
    IF TG_OP = 'INSERT' AND (NEW.delivery_method = 'sms' OR NEW.delivery_method = 'both') THEN
        
        RAISE LOG 'SMS: Processing notification % for user %', NEW.id, NEW.user_id;
        
        -- Get user's phone number
        SELECT phone_number INTO v_user_phone
        FROM public.users
        WHERE id = NEW.user_id;
        
        RAISE LOG 'SMS: User phone number: %', v_user_phone;
        
        -- Only proceed if user has a phone number
        IF v_user_phone IS NOT NULL AND v_user_phone != '' THEN
            
            -- Prepare request details
            v_request_url := 'https://wruqnuaycbghftbipfqk.supabase.co/functions/v1/sms-notifications';
            v_request_body := jsonb_build_object(
                'notification_id', NEW.id,
                'user_id', NEW.user_id,
                'phone_number', v_user_phone,
                'message', NEW.message,
                'notification_type', NEW.type
            );
            
            -- REPLACE THIS WITH YOUR ACTUAL SERVICE ROLE KEY
            v_service_key := 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndydXFudWF5Y2JnaGZ0YmlwZnFrIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTczNjUyMjAyMCwiZXhwIjoyMDUyMDk4MDIwfQ.1TD67SJEyyFbz8WvpcjOdSpfWKlefgmnGZpbmNVBVBY';
            
            RAISE LOG 'SMS: Request URL: %', v_request_url;
            RAISE LOG 'SMS: Request body: %', v_request_body::text;
            RAISE LOG 'SMS: Using service key: %', LEFT(v_service_key, 20) || '...';
            
            BEGIN
                -- Call the edge function
                SELECT net.http_post(
                    url := v_request_url,
                    headers := jsonb_build_object(
                        'Content-Type', 'application/json',
                        'Authorization', 'Bearer ' || v_service_key
                    ),
                    body := v_request_body,
                    timeout_milliseconds := 5000
                ) INTO v_request_id;
                
                RAISE LOG 'SMS: HTTP request submitted successfully with ID: %', v_request_id;
                RAISE LOG 'SMS:  SMS request sent to edge function (response will be processed asynchronously)';
                
                -- Mark the notification as sent
                UPDATE public.notifications 
                SET sent_at = NOW()
                WHERE id = NEW.id;
                
            EXCEPTION WHEN OTHERS THEN
                RAISE LOG 'SMS:  Exception calling edge function: %', SQLERRM;
                RAISE LOG 'SMS: Error detail: %', SQLSTATE;
                
                -- Mark as push only on error
                UPDATE public.notifications 
                SET delivery_method = 'push', sent_at = NOW()
                WHERE id = NEW.id;
            END;
            
        ELSE
            RAISE LOG 'SMS:  No phone number found for user %, marking as push only', NEW.user_id;
            -- No phone number, update to push only
            UPDATE public.notifications 
            SET delivery_method = 'push', sent_at = NOW()
            WHERE id = NEW.id;
        END IF;
    ELSE
        RAISE LOG 'SMS: Skipping notification % (not SMS delivery)', NEW.id;
    END IF;
    
    RETURN NEW;
END;
$$;


--
-- TOC entry 1488 (class 1255 OID 445015)
-- Name: record_commission_entry(public.transaction_type, numeric, text, uuid, uuid, uuid, uuid, uuid, jsonb); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.record_commission_entry(p_transaction_type public.transaction_type, p_amount numeric, p_description text, p_freight_post_id uuid DEFAULT NULL::uuid, p_payment_id uuid DEFAULT NULL::uuid, p_escrow_id uuid DEFAULT NULL::uuid, p_payout_id uuid DEFAULT NULL::uuid, p_refund_id uuid DEFAULT NULL::uuid, p_metadata jsonb DEFAULT '{}'::jsonb) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
    v_current_balance numeric;
    v_new_balance numeric;
    v_entry_id uuid;
BEGIN
    -- Get current balance
    v_current_balance := public.get_commission_balance();
    
    -- Calculate new balance
    v_new_balance := v_current_balance + p_amount;
    
    -- Insert entry
    INSERT INTO public.commission_ledger (
        transaction_type,
        amount,
        running_balance,
        description,
        freight_post_id,
        payment_id,
        escrow_id,
        payout_id,
        refund_id,
        metadata
    ) VALUES (
        p_transaction_type,
        p_amount,
        v_new_balance,
        p_description,
        p_freight_post_id,
        p_payment_id,
        p_escrow_id,
        p_payout_id,
        p_refund_id,
        p_metadata
    )
    RETURNING id INTO v_entry_id;
    
    RETURN v_entry_id;
END;
$$;


--
-- TOC entry 6034 (class 0 OID 0)
-- Dependencies: 1488
-- Name: FUNCTION record_commission_entry(p_transaction_type public.transaction_type, p_amount numeric, p_description text, p_freight_post_id uuid, p_payment_id uuid, p_escrow_id uuid, p_payout_id uuid, p_refund_id uuid, p_metadata jsonb); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.record_commission_entry(p_transaction_type public.transaction_type, p_amount numeric, p_description text, p_freight_post_id uuid, p_payment_id uuid, p_escrow_id uuid, p_payout_id uuid, p_refund_id uuid, p_metadata jsonb) IS 'Records a commission ledger entry and updates running balance';


--
-- TOC entry 1408 (class 1255 OID 259455)
-- Name: register_user_as_driver(uuid, double precision, double precision, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.register_user_as_driver(p_user_id uuid, p_address_lat double precision, p_address_lng double precision, p_address_name text) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
    UPDATE public.users 
    SET 
        role = 'Driver',
        address = CASE 
            WHEN p_address_lat IS NOT NULL AND p_address_lng IS NOT NULL 
            THEN ST_SetSRID(ST_MakePoint(p_address_lng, p_address_lat), 4326)
            ELSE address
        END,
        address_name = CASE 
            WHEN p_address_name IS NOT NULL 
            THEN p_address_name
            ELSE address_name
        END,
        updated_at = NOW()
    WHERE id = p_user_id;
END;
$$;


--
-- TOC entry 1482 (class 1255 OID 270773)
-- Name: send_notification_with_preferences(uuid, public.notification_type, text, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.send_notification_with_preferences(p_user_id uuid, p_notification_type public.notification_type, p_message text, p_related_id uuid DEFAULT NULL::uuid) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
    v_push_enabled boolean;
    v_sms_enabled boolean;
    v_delivery_method text;
    v_notification_id uuid;
    v_user_phone text;
    v_device RECORD;
    v_request_id bigint;
BEGIN
    -- Get user preferences for this notification type
    SELECT push_enabled, sms_enabled
    INTO v_push_enabled, v_sms_enabled
    FROM get_notification_preference(p_user_id, p_notification_type);

    -- Skip if user disabled both methods
    IF NOT v_push_enabled AND NOT v_sms_enabled THEN
        RETURN NULL;
    END IF;

    -- Determine delivery method
    IF v_push_enabled AND v_sms_enabled THEN
        v_delivery_method := 'both';
    ELSIF v_push_enabled THEN
        v_delivery_method := 'push';
    ELSE
        v_delivery_method := 'sms';
    END IF;

    -- Create notification record
    INSERT INTO notifications (user_id, type, message, related_id, delivery_method, sent_at)
    VALUES (p_user_id, p_notification_type, p_message, p_related_id, v_delivery_method, NOW())
    RETURNING id INTO v_notification_id;

    -- Send FCM notification to ALL registered devices if push enabled
    IF v_push_enabled THEN
        FOR v_device IN
            SELECT fcm_token FROM public.device_tokens WHERE user_id = p_user_id
        LOOP
            SELECT net.http_post(
                url := current_setting('app.settings.supabase_url', true) || '/functions/v1/send-push',
                headers := jsonb_build_object(
                    'Content-Type', 'application/json',
                    'Authorization', 'Bearer ' || current_setting('app.settings.service_role_key', true)
                ),
                body := jsonb_build_object(
                    'fcm_token', v_device.fcm_token,
                    'title', 'LoadRunner Admin',
                    'body', p_message,
                    'notification_type', p_notification_type,
                    'related_id', p_related_id
                )
            ) INTO v_request_id;
        END LOOP;

        -- Also try legacy single-token field on users table
        SELECT fcm_token INTO v_user_phone FROM public.users WHERE id = p_user_id;
        IF v_user_phone IS NOT NULL AND NOT EXISTS (
            SELECT 1 FROM public.device_tokens WHERE user_id = p_user_id AND fcm_token = v_user_phone
        ) THEN
            SELECT net.http_post(
                url := current_setting('app.settings.supabase_url', true) || '/functions/v1/send-push',
                headers := jsonb_build_object(
                    'Content-Type', 'application/json',
                    'Authorization', 'Bearer ' || current_setting('app.settings.service_role_key', true)
                ),
                body := jsonb_build_object(
                    'fcm_token', v_user_phone,
                    'title', 'LoadRunner Admin',
                    'body', p_message,
                    'notification_type', p_notification_type,
                    'related_id', p_related_id
                )
            ) INTO v_request_id;
        END IF;
    END IF;

    -- Send SMS if sms enabled
    IF v_sms_enabled THEN
        SELECT phone_number INTO v_user_phone FROM public.users WHERE id = p_user_id;
        IF v_user_phone IS NOT NULL THEN
            SELECT net.http_post(
                url := current_setting('app.settings.supabase_url', true) || '/functions/v1/send-sms',
                headers := jsonb_build_object(
                    'Content-Type', 'application/json',
                    'Authorization', 'Bearer ' || current_setting('app.settings.service_role_key', true)
                ),
                body := jsonb_build_object(
                    'user_id', p_user_id,
                    'phone_number', v_user_phone,
                    'message', p_message,
                    'notification_type', p_notification_type
                )
            ) INTO v_request_id;
        END IF;
    END IF;

    RETURN v_notification_id;
END;
$$;


--
-- TOC entry 544 (class 1255 OID 270874)
-- Name: set_notification_preference(uuid, public.notification_type, boolean, boolean); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.set_notification_preference(p_user_id uuid, p_notification_type public.notification_type, p_push_enabled boolean DEFAULT false, p_sms_enabled boolean DEFAULT false) RETURNS void
    LANGUAGE sql SECURITY DEFINER
    AS $$
    INSERT INTO notification_type_preferences (user_id, notification_type, push_enabled, sms_enabled)
    VALUES (p_user_id, p_notification_type, p_push_enabled, p_sms_enabled)
    ON CONFLICT (user_id, notification_type)
    DO UPDATE SET 
        push_enabled = p_push_enabled,
        sms_enabled = p_sms_enabled,
        updated_at = NOW();
$$;


--
-- TOC entry 1471 (class 1255 OID 511918)
-- Name: set_user_suspension(uuid, uuid, boolean, text, timestamp with time zone); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.set_user_suspension(p_user_id uuid, p_admin_id uuid, p_is_suspended boolean, p_reason text DEFAULT NULL::text, p_ends_at timestamp with time zone DEFAULT NULL::timestamp with time zone) RETURNS boolean
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
    UPDATE public.users
    SET is_suspended = p_is_suspended,
        suspended_at = CASE WHEN p_is_suspended THEN NOW() ELSE NULL END,
        suspended_reason = CASE WHEN p_is_suspended THEN p_reason ELSE NULL END,
        suspended_by = CASE WHEN p_is_suspended THEN p_admin_id ELSE NULL END,
        suspension_ends_at = CASE WHEN p_is_suspended THEN p_ends_at ELSE NULL END,
        updated_at = NOW()
    WHERE id = p_user_id;
    
    IF NOT FOUND THEN
        RAISE EXCEPTION 'User not found: %', p_user_id;
    END IF;
    
    -- Log admin action
    PERFORM public.log_admin_action(
        p_admin_id,
        CASE WHEN p_is_suspended THEN 'suspend_user' ELSE 'unsuspend_user' END,
        'user',
        p_user_id,
        NULL,
        jsonb_build_object('reason', p_reason, 'ends_at', p_ends_at)
    );
    
    RETURN TRUE;
END;
$$;


--
-- TOC entry 1474 (class 1255 OID 520933)
-- Name: stamp_user_login(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.stamp_user_login(p_user_id uuid) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public'
    AS $$
BEGIN
    UPDATE public.users
    SET last_login_at = NOW()
    WHERE id = p_user_id;
END;
$$;


--
-- TOC entry 1437 (class 1255 OID 116422)
-- Name: submit_bid_with_notifications(uuid, uuid, numeric, timestamp with time zone, timestamp with time zone, text, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.submit_bid_with_notifications(p_freight_post_id uuid, p_vehicle_id uuid, p_bid_amount numeric, p_delivery_date timestamp with time zone, p_pickup_date timestamp with time zone, p_notes text, p_status text DEFAULT 'Open'::text) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $_$
DECLARE
  v_new_bid_id uuid;
  v_driver_id uuid;
  v_lowest_bid_vehicle_id uuid;
  v_lowest_bid_driver_id uuid;
  v_lowest_bid_amount numeric;
  v_freight_description text;
  v_currency text;
  v_currency_symbol text;
BEGIN
  -- Get driver ID from vehicle
  SELECT driver_id INTO v_driver_id 
  FROM vehicles
  WHERE id = p_vehicle_id;
  
  -- Get current lowest bid for this shipment
  SELECT 
    b.vehicle_id, 
    b.bid_amount,
    v.driver_id
  INTO 
    v_lowest_bid_vehicle_id, 
    v_lowest_bid_amount,
    v_lowest_bid_driver_id
  FROM bids b
  JOIN vehicles v ON b.vehicle_id = v.id
  WHERE b.freight_post_id = p_freight_post_id
    AND b.status = 'Open'
  ORDER BY b.bid_amount ASC
  LIMIT 1;
  
  -- Get freight post details
  SELECT description, currency
  INTO v_freight_description, v_currency
  FROM freight_posts
  WHERE id = p_freight_post_id;
  
  -- Convert currency code to symbol
  v_currency_symbol := CASE v_currency
      -- North America & Europe
      WHEN 'USD' THEN '$'
      WHEN 'EUR' THEN ''
      WHEN 'GBP' THEN ''
      WHEN 'CAD' THEN 'C$'
      WHEN 'CHF' THEN 'CHF'
      WHEN 'SEK' THEN 'kr'
      WHEN 'NOK' THEN 'kr'
      WHEN 'DKK' THEN 'kr'
      WHEN 'PLN' THEN 'z'
      
      -- South America
      WHEN 'BRL' THEN 'R$'
      WHEN 'ARS' THEN 'AR$'
      WHEN 'CLP' THEN 'CLP$'
      WHEN 'COP' THEN 'COL$'
      WHEN 'PEN' THEN 'S/'
      WHEN 'UYU' THEN 'UYU$'
      WHEN 'BOB' THEN 'Bs.'
      WHEN 'PYG' THEN ''
      WHEN 'VES' THEN 'Bs.'

      -- Africa
      WHEN 'ZAR' THEN 'R'
      WHEN 'EGP' THEN 'E'
      WHEN 'NGN' THEN ''
      WHEN 'KES' THEN 'KSh'
      WHEN 'TZS' THEN 'TSh'
      WHEN 'GHS' THEN 'GH'
      WHEN 'XAF' THEN 'CFA'
      WHEN 'XOF' THEN 'CFA'
      WHEN 'MZN' THEN 'MT'
      WHEN 'BWP' THEN 'P'
      WHEN 'ETB' THEN 'Br'
      WHEN 'MAD' THEN '..'
      WHEN 'DZD' THEN ''
      WHEN 'SDG' THEN 'SDG'
      WHEN 'RWF' THEN 'FRw'
      WHEN 'CDF' THEN 'FC'
      WHEN 'MWK' THEN 'MK'
      WHEN 'ZMW' THEN 'ZK'
      WHEN 'SSP' THEN ''

      -- Middle East
      WHEN 'SAR' THEN '.'
      WHEN 'AED' THEN '.'
      WHEN 'QAR' THEN '.'
      WHEN 'KWD' THEN 'KD'
      WHEN 'BHD' THEN 'BD'
      WHEN 'OMR' THEN '.'
      WHEN 'IQD' THEN '.'
      WHEN 'IRR' THEN '.'

      -- Asia
      WHEN 'JPY' THEN ''
      WHEN 'CNY' THEN ''
      WHEN 'INR' THEN ''
      WHEN 'SGD' THEN 'S$'
      WHEN 'HKD' THEN 'HK$'
      WHEN 'MYR' THEN 'RM'
      WHEN 'IDR' THEN 'Rp'
      WHEN 'PHP' THEN ''
      WHEN 'VND' THEN ''
      WHEN 'KRW' THEN ''
      WHEN 'PKR' THEN ''
      WHEN 'BDT' THEN ''
      WHEN 'LKR' THEN 'Rs'
      WHEN 'MMK' THEN 'K'
      WHEN 'THB' THEN ''
      WHEN 'TWD' THEN 'NT$'

      -- Oceania
      WHEN 'AUD' THEN 'A$'
      WHEN 'NZD' THEN 'NZ$'
      WHEN 'FJD' THEN 'FJ$'
      
      ELSE v_currency
  END;
  
  -- Insert the new bid
  INSERT INTO bids (
    freight_post_id,
    vehicle_id,
    bid_amount,
    delivery_date,
    pickup_date,
    notes,
    status
  ) VALUES (
    p_freight_post_id,
    p_vehicle_id,
    p_bid_amount,
    p_delivery_date,
    p_pickup_date,
    p_notes,
    p_status::bid_status
  ) RETURNING id INTO v_new_bid_id;
  
  -- If there was a previous lowest bid and our new bid is lower
  IF v_lowest_bid_amount IS NOT NULL 
     AND p_bid_amount < v_lowest_bid_amount 
     AND v_lowest_bid_driver_id != v_driver_id THEN
    
    --  UPDATED: Route through send_notification_with_preferences for FCM support
    PERFORM send_notification_with_preferences(
      v_lowest_bid_driver_id,
      'outbid',
      'Your bid for "' || COALESCE(v_freight_description, 'Unknown shipment') || '" was outbid. New lowest bid: ' || 
      v_currency_symbol || ROUND(p_bid_amount::numeric, 2),
      p_freight_post_id
    );
  END IF;
  
  RETURN v_new_bid_id;
END;
$_$;


--
-- TOC entry 6035 (class 0 OID 0)
-- Dependencies: 1437
-- Name: FUNCTION submit_bid_with_notifications(p_freight_post_id uuid, p_vehicle_id uuid, p_bid_amount numeric, p_delivery_date timestamp with time zone, p_pickup_date timestamp with time zone, p_notes text, p_status text); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.submit_bid_with_notifications(p_freight_post_id uuid, p_vehicle_id uuid, p_bid_amount numeric, p_delivery_date timestamp with time zone, p_pickup_date timestamp with time zone, p_notes text, p_status text) IS 'Submits a bid and creates notifications if another driver is outbid. Routes through send_notification_with_preferences for FCM/SMS support.';


--
-- TOC entry 1179 (class 1255 OID 421428)
-- Name: sync_freight_post_lowest_bid(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.sync_freight_post_lowest_bid() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public'
    AS $$
DECLARE
  v_freight_post_id UUID;
  v_lowest_bid NUMERIC;
BEGIN
  -- Get the freight_post_id from the affected bid
  v_freight_post_id := COALESCE(NEW.freight_post_id, OLD.freight_post_id);
  
  -- Calculate the new lowest bid for this shipment
  -- Only consider Open bids
  SELECT COALESCE(MIN(bid_amount), 0.0) INTO v_lowest_bid
  FROM bids
  WHERE freight_post_id = v_freight_post_id
    AND status = 'Open';
  
  -- Update the freight_posts table (ONLY 1 ROW)
  -- SECURITY DEFINER allows this to bypass RLS
  UPDATE freight_posts
  SET lowest_bid = v_lowest_bid
  WHERE id = v_freight_post_id;
  
  RETURN NEW;
END;
$$;


--
-- TOC entry 6036 (class 0 OID 0)
-- Dependencies: 1179
-- Name: FUNCTION sync_freight_post_lowest_bid(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.sync_freight_post_lowest_bid() IS 'Trigger function to automatically update freight_posts.lowest_bid when bids change. 
Uses SECURITY DEFINER to bypass RLS (drivers cannot normally update shipper freight_posts).';


--
-- TOC entry 1477 (class 1255 OID 522120)
-- Name: trigger_notify_dispute_filed(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trigger_notify_dispute_filed() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
    v_raiser_name text;
BEGIN
    SELECT COALESCE(first_name || ' ' || last_name, phone_number, 'A user')
    INTO v_raiser_name
    FROM public.users WHERE id = NEW.raised_by;

    PERFORM notify_all_admins(
        'dispute_filed',
        'New dispute filed by ' || v_raiser_name || ': ' || COALESCE(NEW.title, 'Untitled'),
        NEW.id
    );
    RETURN NEW;
END;
$$;


--
-- TOC entry 1478 (class 1255 OID 522122)
-- Name: trigger_notify_dispute_updated(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trigger_notify_dispute_updated() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
    -- Only fire if status actually changed
    IF OLD.status IS DISTINCT FROM NEW.status THEN
        IF NEW.status = 'escalated' THEN
            PERFORM notify_all_admins(
                'dispute_escalated',
                'Dispute escalated: ' || COALESCE(NEW.title, 'Untitled') || ' (Priority: ' || COALESCE(NEW.priority, 'unknown') || ')',
                NEW.id
            );
        ELSIF NEW.status = 'resolved' THEN
            PERFORM notify_all_admins(
                'dispute_resolved',
                'Dispute resolved: ' || COALESCE(NEW.title, 'Untitled'),
                NEW.id
            );
        END IF;
    END IF;
    RETURN NEW;
END;
$$;


--
-- TOC entry 1480 (class 1255 OID 522128)
-- Name: trigger_notify_document_uploaded(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trigger_notify_document_uploaded() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
    v_driver_name text;
BEGIN
    SELECT COALESCE(first_name || ' ' || last_name, phone_number, 'Unknown')
    INTO v_driver_name
    FROM public.users WHERE id = NEW.driver_id;

    PERFORM notify_all_admins(
        'driver_document_uploaded',
        'New document uploaded by ' || v_driver_name || ': ' || COALESCE(NEW.doc_type, 'Document'),
        NEW.driver_id
    );
    RETURN NEW;
END;
$$;


--
-- TOC entry 1479 (class 1255 OID 522124)
-- Name: trigger_notify_driver_registered(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trigger_notify_driver_registered() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
    IF NEW.role = 'Driver' THEN
        PERFORM notify_all_admins(
            'driver_pending_approval',
            'New driver registered: ' || COALESCE(NEW.first_name || ' ' || NEW.last_name, NEW.phone_number, 'Unknown'),
            NEW.id
        );
    END IF;
    RETURN NEW;
END;
$$;


--
-- TOC entry 1481 (class 1255 OID 522126)
-- Name: trigger_notify_driver_status_changed(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trigger_notify_driver_status_changed() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
    v_driver_name text;
BEGIN
    IF NEW.role = 'Driver' THEN
        v_driver_name := COALESCE(NEW.first_name || ' ' || NEW.last_name, NEW.phone_number, 'Unknown');

        -- Driver suspended (column is is_suspended, not is_active)
        IF OLD.is_suspended IS DISTINCT FROM NEW.is_suspended AND NEW.is_suspended = true THEN
            PERFORM notify_all_admins(
                'driver_suspended',
                'Driver suspended: ' || v_driver_name,
                NEW.id
            );
        END IF;

        -- Verification status changed to pending (re-submitted docs)
        IF OLD.driver_verification_status IS DISTINCT FROM NEW.driver_verification_status
           AND NEW.driver_verification_status = 'pending' THEN
            PERFORM notify_all_admins(
                'driver_pending_approval',
                'Driver pending approval: ' || v_driver_name,
                NEW.id
            );
        END IF;
    END IF;
    RETURN NEW;
END;
$$;


--
-- TOC entry 1472 (class 1255 OID 511919)
-- Name: update_disputes_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_disputes_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$;


--
-- TOC entry 1463 (class 1255 OID 486950)
-- Name: update_driver_shipment_status(uuid, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_driver_shipment_status(p_shipment_id uuid, p_new_status text) RETURNS jsonb
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_shipment_record RECORD;
  v_driver_id UUID;
  v_result jsonb;
BEGIN
  -- Verify the current user is the assigned driver
  -- Note: driver_id is in vehicles table, not bids table
  SELECT
    fp.id,
    fp.status,
    v.driver_id,
    b.status as bid_status
  INTO v_shipment_record
  FROM freight_posts fp
  LEFT JOIN bids b ON b.freight_post_id = fp.id AND b.status = 'Accepted'
  LEFT JOIN vehicles v ON b.vehicle_id = v.id
  WHERE fp.id = p_shipment_id;

  IF NOT FOUND THEN
    RAISE EXCEPTION 'Shipment not found: %', p_shipment_id;
  END IF;

  v_driver_id := v_shipment_record.driver_id;

  IF v_driver_id IS NULL THEN
    RAISE EXCEPTION 'No accepted bid found for shipment %', p_shipment_id;
  END IF;

  IF v_driver_id != auth.uid() THEN
    RAISE EXCEPTION 'Unauthorized: Only the assigned driver can update shipment status';
  END IF;

  -- Validate status transition
  -- Valid transitions: Bidding -> Pickup -> OnRoute -> Delivered
  IF v_shipment_record.status = 'Bidding' AND p_new_status NOT IN ('Pickup', 'Cancelled') THEN
    RAISE EXCEPTION 'Invalid status transition from % to %', v_shipment_record.status, p_new_status;
  END IF;

  IF v_shipment_record.status = 'Pickup' AND p_new_status NOT IN ('OnRoute', 'Cancelled') THEN
    RAISE EXCEPTION 'Invalid status transition from % to %', v_shipment_record.status, p_new_status;
  END IF;

  IF v_shipment_record.status = 'OnRoute' AND p_new_status NOT IN ('Delivered', 'Cancelled') THEN
    RAISE EXCEPTION 'Invalid status transition from % to %', v_shipment_record.status, p_new_status;
  END IF;

  -- Update shipment status
  UPDATE freight_posts
  SET
    status = p_new_status::freight_status,
    updated_at = NOW(),
    delivery_confirmed_at = CASE WHEN p_new_status = 'Delivered' THEN NOW() ELSE delivery_confirmed_at END
  WHERE id = p_shipment_id
  RETURNING
    jsonb_build_object(
      'id', id,
      'status', status,
      'updated_at', updated_at,
      'delivery_confirmed_at', delivery_confirmed_at
    ) INTO v_result;

  -- If delivered, remove from tracking
  IF p_new_status = 'Delivered' THEN
    UPDATE driver_tracking_shipments
    SET removed_at = NOW()
    WHERE shipment_id = p_shipment_id AND removed_at IS NULL;

    PERFORM complete_driver_tracking_if_no_shipments(v_driver_id);
  END IF;

  RETURN v_result;
END;
$$;


--
-- TOC entry 1456 (class 1255 OID 483410)
-- Name: update_driver_tracking_session_on_new_point(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_driver_tracking_session_on_new_point() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_total_points INTEGER;
  v_distance_traveled DOUBLE PRECISION;
BEGIN
  -- Only process if this point has a driver_tracking_id
  IF NEW.driver_tracking_id IS NULL THEN
    RETURN NEW;
  END IF;

  -- Count total points for this driver tracking session
  SELECT COUNT(*) INTO v_total_points
  FROM tracking_points
  WHERE driver_tracking_id = NEW.driver_tracking_id;

  -- Sum total distance traveled
  SELECT COALESCE(SUM(distance_from_previous), 0) INTO v_distance_traveled
  FROM tracking_points
  WHERE driver_tracking_id = NEW.driver_tracking_id
    AND distance_from_previous IS NOT NULL;

  -- Update driver_tracking_sessions with calculated metrics
  UPDATE driver_tracking_sessions
  SET
    total_points = v_total_points,
    distance_traveled = v_distance_traveled,
    updated_at = NOW()
  WHERE id = NEW.driver_tracking_id;

  RETURN NEW;

EXCEPTION
  WHEN OTHERS THEN
    -- Log error but don't fail the insert
    RAISE WARNING 'Error updating driver tracking session %: %', NEW.driver_tracking_id, SQLERRM;
    RETURN NEW;
END;
$$;


--
-- TOC entry 6037 (class 0 OID 0)
-- Dependencies: 1456
-- Name: FUNCTION update_driver_tracking_session_on_new_point(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.update_driver_tracking_session_on_new_point() IS 'Automatically updates total_points and distance_traveled in driver_tracking_sessions when new tracking point is inserted';


--
-- TOC entry 1499 (class 1255 OID 511917)
-- Name: update_driver_verification(uuid, uuid, public.verification_status, text, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_driver_verification(p_driver_id uuid, p_admin_id uuid, p_new_status public.verification_status, p_reason text DEFAULT NULL::text, p_notes text DEFAULT NULL::text) RETURNS boolean
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
    v_old_status public.verification_status;
BEGIN
    -- Get current status
    SELECT driver_verification_status INTO v_old_status
    FROM public.users
    WHERE id = p_driver_id AND role = 'Driver';
    
    IF NOT FOUND THEN
        RAISE EXCEPTION 'Driver not found: %', p_driver_id;
    END IF;
    
    -- Update user record
    UPDATE public.users
    SET driver_verification_status = p_new_status,
        driver_verified_by = CASE WHEN p_new_status = 'approved' THEN p_admin_id ELSE driver_verified_by END,
        driver_verified_at = CASE WHEN p_new_status = 'approved' THEN NOW() ELSE driver_verified_at END,
        verification_notes = COALESCE(p_notes, verification_notes),
        updated_at = NOW()
    WHERE id = p_driver_id;
    
    -- Log the change
    INSERT INTO public.driver_approval_history (
        driver_id, admin_id, previous_status, new_status, reason, notes
    ) VALUES (
        p_driver_id, p_admin_id, v_old_status, p_new_status, p_reason, p_notes
    );
    
    -- Log admin action
    PERFORM public.log_admin_action(
        p_admin_id,
        'update_driver_verification',
        'user',
        p_driver_id,
        jsonb_build_object('status', v_old_status),
        jsonb_build_object('status', p_new_status, 'reason', p_reason)
    );
    
    RETURN TRUE;
END;
$$;


--
-- TOC entry 1042 (class 1255 OID 259288)
-- Name: update_freight_post_with_geometry(uuid, text, text, double precision, double precision, double precision, double precision, text, text, text, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_freight_post_with_geometry(p_id uuid, p_description text, p_status text, p_pickup_lat double precision, p_pickup_lng double precision, p_dropoff_lat double precision, p_dropoff_lng double precision, p_currency text, p_notes text, p_pickup_location_name text, p_dropoff_location_name text) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
    UPDATE public.freight_posts 
    SET 
        description = p_description,
        status = p_status::public.freight_status,
        pickup_location = ST_SetSRID(ST_MakePoint(p_pickup_lng, p_pickup_lat), 4326),
        dropoff_location = ST_SetSRID(ST_MakePoint(p_dropoff_lng, p_dropoff_lat), 4326),
        currency = p_currency,
        notes = p_notes,
        pickup_location_name = p_pickup_location_name,
        dropoff_location_name = p_dropoff_location_name,
        updated_at = NOW()
    WHERE id = p_id;
END;
$$;


--
-- TOC entry 1490 (class 1255 OID 445017)
-- Name: update_payment_modified_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_payment_modified_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$;


--
-- TOC entry 1422 (class 1255 OID 407110)
-- Name: update_tracking_session_on_new_point(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_tracking_session_on_new_point() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_shipment_id uuid;
  v_dropoff_location geometry;
  v_latest_point geometry;
  v_current_speed double precision;
  v_distance_remaining double precision;
  v_eta_minutes integer;
  v_total_points integer;
  v_distance_traveled double precision;
BEGIN
  -- Get shipment_id
  SELECT shipment_id INTO v_shipment_id
  FROM tracking_sessions WHERE id = NEW.tracking_id;
  
  IF v_shipment_id IS NULL THEN
    RAISE WARNING 'No shipment found for tracking_id: %', NEW.tracking_id;
    RETURN NEW;
  END IF;
  
  -- Get dropoff location from geometry column
  SELECT dropoff_location INTO v_dropoff_location
  FROM freight_posts WHERE id = v_shipment_id;
  
  IF v_dropoff_location IS NULL THEN
    RAISE WARNING 'No dropoff location found for shipment: %', v_shipment_id;
    RETURN NEW;
  END IF;
  
  -- Create point from new tracking data
  v_latest_point := ST_SetSRID(ST_MakePoint(NEW.longitude, NEW.latitude), 4326);
  
  -- Calculate distance remaining (in kilometers)
  v_distance_remaining := ST_Distance(
    v_latest_point::geography, 
    v_dropoff_location::geography
  ) / 1000.0;
  
  -- Calculate speed and ETA
  v_current_speed := COALESCE(NULLIF(NEW.speed, 0), 40.0);
  v_eta_minutes := CEIL((v_distance_remaining / v_current_speed) * 60);
  
  -- Count total points for this tracking session
  SELECT COUNT(*) INTO v_total_points
  FROM tracking_points WHERE tracking_id = NEW.tracking_id;
  
  -- Sum total distance traveled
  SELECT COALESCE(SUM(distance_from_previous), 0) INTO v_distance_traveled
  FROM tracking_points 
  WHERE tracking_id = NEW.tracking_id 
    AND distance_from_previous IS NOT NULL;
  
  -- Update tracking_sessions with all calculated values
  UPDATE tracking_sessions
  SET
    current_latitude = NEW.latitude,
    current_longitude = NEW.longitude,
    current_speed = NEW.speed,
    current_heading = NEW.heading,
    last_location_update = NEW.timestamp,
    distance_remaining = v_distance_remaining,
    eta_minutes = v_eta_minutes,
    total_points = v_total_points,
    distance_traveled = v_distance_traveled,
    updated_at = NOW()
  WHERE id = NEW.tracking_id;
  
  RETURN NEW;
  
EXCEPTION
  WHEN OTHERS THEN
    -- Log error but don't fail the insert
    RAISE WARNING 'Error updating tracking session %: %', NEW.tracking_id, SQLERRM;
    RETURN NEW;
END;
$$;


--
-- TOC entry 6038 (class 0 OID 0)
-- Dependencies: 1422
-- Name: FUNCTION update_tracking_session_on_new_point(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.update_tracking_session_on_new_point() IS 'Combined function that updates tracking_sessions with position, ETA calculation, and statistics on each new tracking point. Replaces multiple separate triggers for better performance.';


--
-- TOC entry 1407 (class 1255 OID 259454)
-- Name: update_user_with_geometry(uuid, text, text, text, date, text, text, text, text, text, double precision, double precision, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_user_with_geometry(p_user_id uuid, p_first_name text, p_last_name text, p_email text, p_dob date, p_profile_photo_url text, p_id_no text, p_bank_name text, p_account_number text, p_branch_code text, p_address_lat double precision, p_address_lng double precision, p_address_name text) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
    UPDATE public.users 
    SET 
        first_name = p_first_name,
        last_name = p_last_name,
        email = p_email,
        dob = p_dob,
        profile_photo_url = p_profile_photo_url,
        id_no = p_id_no,
        bank_name = p_bank_name,
        account_number = p_account_number,
        branch_code = p_branch_code,
        address = CASE 
            WHEN p_address_lat IS NOT NULL AND p_address_lng IS NOT NULL 
            THEN ST_SetSRID(ST_MakePoint(p_address_lng, p_address_lat), 4326)
            ELSE address
        END,
        address_name = p_address_name,
        updated_at = NOW()
    WHERE id = p_user_id;
END;
$$;


--
-- TOC entry 1460 (class 1255 OID 485724)
-- Name: user_has_accepted_bid(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.user_has_accepted_bid(p_freight_post_id uuid) RETURNS boolean
    LANGUAGE plpgsql STABLE SECURITY DEFINER
    AS $$
DECLARE
  v_user_id uuid;
  v_has_bid boolean;
BEGIN
  -- Get current user ID
  v_user_id := public.get_current_user_id();

  -- Check if user has accepted bid (bypass RLS with SECURITY DEFINER)
  SELECT EXISTS (
    SELECT 1 FROM bids b
    JOIN vehicles v ON b.vehicle_id = v.id
    WHERE b.freight_post_id = p_freight_post_id
      AND b.status = 'Accepted'
      AND v.driver_id = v_user_id
  ) INTO v_has_bid;

  RETURN v_has_bid;
END;
$$;


--
-- TOC entry 6039 (class 0 OID 0)
-- Dependencies: 1460
-- Name: FUNCTION user_has_accepted_bid(p_freight_post_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.user_has_accepted_bid(p_freight_post_id uuid) IS 'Check if current user has an accepted bid for the freight post. SECURITY DEFINER to avoid RLS recursion.';


--
-- TOC entry 1459 (class 1255 OID 485723)
-- Name: user_owns_freight_post(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.user_owns_freight_post(p_freight_post_id uuid) RETURNS boolean
    LANGUAGE plpgsql STABLE SECURITY DEFINER
    AS $$
DECLARE
  v_user_id uuid;
  v_is_owner boolean;
BEGIN
  -- Get current user ID
  v_user_id := public.get_current_user_id();

  -- Check if user owns the freight post (bypass RLS with SECURITY DEFINER)
  SELECT EXISTS (
    SELECT 1 FROM freight_posts
    WHERE id = p_freight_post_id AND shipper_id = v_user_id
  ) INTO v_is_owner;

  RETURN v_is_owner;
END;
$$;


--
-- TOC entry 6040 (class 0 OID 0)
-- Dependencies: 1459
-- Name: FUNCTION user_owns_freight_post(p_freight_post_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.user_owns_freight_post(p_freight_post_id uuid) IS 'Check if current user owns the specified freight post. SECURITY DEFINER to avoid RLS recursion.';


--
-- TOC entry 1458 (class 1255 OID 485722)
-- Name: user_owns_vehicle(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.user_owns_vehicle(p_vehicle_id uuid) RETURNS boolean
    LANGUAGE plpgsql STABLE SECURITY DEFINER
    AS $$
DECLARE
  v_user_id uuid;
  v_is_owner boolean;
BEGIN
  -- Get current user ID
  v_user_id := public.get_current_user_id();

  -- Check if user owns the vehicle (bypass RLS with SECURITY DEFINER)
  SELECT EXISTS (
    SELECT 1 FROM vehicles
    WHERE id = p_vehicle_id AND driver_id = v_user_id
  ) INTO v_is_owner;

  RETURN v_is_owner;
END;
$$;


--
-- TOC entry 6041 (class 0 OID 0)
-- Dependencies: 1458
-- Name: FUNCTION user_owns_vehicle(p_vehicle_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.user_owns_vehicle(p_vehicle_id uuid) IS 'Check if current user owns the specified vehicle. SECURITY DEFINER to avoid RLS recursion.';


--
-- TOC entry 1421 (class 1255 OID 379612)
-- Name: verify_realtime_setup(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.verify_realtime_setup() RETURNS TABLE(check_name text, status text, details text)
    LANGUAGE plpgsql
    AS $$
BEGIN
    RETURN QUERY
    
    -- Check 1: Realtime publication
    SELECT 
        'Realtime Publication'::text,
        CASE WHEN COUNT(*) > 0 THEN ' PASS' ELSE ' FAIL' END::text,
        CASE WHEN COUNT(*) > 0 
             THEN 'tracking_points is in supabase_realtime publication'
             ELSE 'Run: ALTER PUBLICATION supabase_realtime ADD TABLE tracking_points;'
        END::text
    FROM pg_publication_tables 
    WHERE pubname = 'supabase_realtime' 
      AND tablename = 'tracking_points'
    
    UNION ALL
    
    -- Check 2: Realtime indexes
    SELECT 
        'Realtime Indexes'::text,
        CASE WHEN COUNT(*) >= 2 THEN ' PASS' ELSE ' FAIL' END::text,
        FORMAT('%s realtime-optimized indexes found', COUNT(*))::text
    FROM pg_indexes 
    WHERE tablename = 'tracking_points' 
      AND indexname LIKE '%realtime%'
    
    UNION ALL
    
    -- Check 3: Trigger exists
    SELECT 
        'Position Update Trigger'::text,
        CASE WHEN COUNT(*) > 0 THEN ' PASS' ELSE ' FAIL' END::text,
        CASE WHEN COUNT(*) > 0 
             THEN 'Trigger exists and is active'
             ELSE 'Trigger not found'
        END::text
    FROM pg_trigger
    WHERE tgname = 'trg_update_session_position'
    
    UNION ALL
    
    -- Check 4: Helper functions
    SELECT 
        'Helper Functions'::text,
        CASE WHEN COUNT(*) >= 3 THEN ' PASS' ELSE ' FAIL' END::text,
        FORMAT('%s helper functions created', COUNT(*))::text
    FROM pg_proc
    WHERE proname IN (
        'get_latest_tracking_position',
        'get_tracking_position_history',
        'get_tracking_health_status'
    );
END;
$$;


SET default_tablespace = '';

SET default_table_access_method = heap;

--
-- TOC entry 322 (class 1259 OID 30732)
-- Name: audit_log_entries; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.audit_log_entries (
    instance_id uuid,
    id uuid NOT NULL,
    payload json,
    created_at timestamp with time zone,
    ip_address character varying(64) DEFAULT ''::character varying NOT NULL
);


--
-- TOC entry 6042 (class 0 OID 0)
-- Dependencies: 322
-- Name: TABLE audit_log_entries; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON TABLE auth.audit_log_entries IS 'Auth: Audit trail for user actions.';


--
-- TOC entry 323 (class 1259 OID 30738)
-- Name: flow_state; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.flow_state (
    id uuid NOT NULL,
    user_id uuid,
    auth_code text,
    code_challenge_method auth.code_challenge_method,
    code_challenge text,
    provider_type text NOT NULL,
    provider_access_token text,
    provider_refresh_token text,
    created_at timestamp with time zone,
    updated_at timestamp with time zone,
    authentication_method text NOT NULL,
    auth_code_issued_at timestamp with time zone,
    invite_token text,
    referrer text,
    oauth_client_state_id uuid,
    linking_target_id uuid,
    email_optional boolean DEFAULT false NOT NULL
);


--
-- TOC entry 6043 (class 0 OID 0)
-- Dependencies: 323
-- Name: TABLE flow_state; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON TABLE auth.flow_state IS 'Stores metadata for all OAuth/SSO login flows';


--
-- TOC entry 324 (class 1259 OID 30743)
-- Name: identities; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.identities (
    provider_id text NOT NULL,
    user_id uuid NOT NULL,
    identity_data jsonb NOT NULL,
    provider text NOT NULL,
    last_sign_in_at timestamp with time zone,
    created_at timestamp with time zone,
    updated_at timestamp with time zone,
    email text GENERATED ALWAYS AS (lower((identity_data ->> 'email'::text))) STORED,
    id uuid DEFAULT gen_random_uuid() NOT NULL
);


--
-- TOC entry 6044 (class 0 OID 0)
-- Dependencies: 324
-- Name: TABLE identities; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON TABLE auth.identities IS 'Auth: Stores identities associated to a user.';


--
-- TOC entry 6045 (class 0 OID 0)
-- Dependencies: 324
-- Name: COLUMN identities.email; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON COLUMN auth.identities.email IS 'Auth: Email is a generated column that references the optional email property in the identity_data';


--
-- TOC entry 325 (class 1259 OID 30750)
-- Name: instances; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.instances (
    id uuid NOT NULL,
    uuid uuid,
    raw_base_config text,
    created_at timestamp with time zone,
    updated_at timestamp with time zone
);


--
-- TOC entry 6046 (class 0 OID 0)
-- Dependencies: 325
-- Name: TABLE instances; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON TABLE auth.instances IS 'Auth: Manages users across multiple sites.';


--
-- TOC entry 326 (class 1259 OID 30755)
-- Name: mfa_amr_claims; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.mfa_amr_claims (
    session_id uuid NOT NULL,
    created_at timestamp with time zone NOT NULL,
    updated_at timestamp with time zone NOT NULL,
    authentication_method text NOT NULL,
    id uuid NOT NULL
);


--
-- TOC entry 6047 (class 0 OID 0)
-- Dependencies: 326
-- Name: TABLE mfa_amr_claims; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON TABLE auth.mfa_amr_claims IS 'auth: stores authenticator method reference claims for multi factor authentication';


--
-- TOC entry 327 (class 1259 OID 30760)
-- Name: mfa_challenges; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.mfa_challenges (
    id uuid NOT NULL,
    factor_id uuid NOT NULL,
    created_at timestamp with time zone NOT NULL,
    verified_at timestamp with time zone,
    ip_address inet NOT NULL,
    otp_code text,
    web_authn_session_data jsonb
);


--
-- TOC entry 6048 (class 0 OID 0)
-- Dependencies: 327
-- Name: TABLE mfa_challenges; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON TABLE auth.mfa_challenges IS 'auth: stores metadata about challenge requests made';


--
-- TOC entry 328 (class 1259 OID 30765)
-- Name: mfa_factors; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.mfa_factors (
    id uuid NOT NULL,
    user_id uuid NOT NULL,
    friendly_name text,
    factor_type auth.factor_type NOT NULL,
    status auth.factor_status NOT NULL,
    created_at timestamp with time zone NOT NULL,
    updated_at timestamp with time zone NOT NULL,
    secret text,
    phone text,
    last_challenged_at timestamp with time zone,
    web_authn_credential jsonb,
    web_authn_aaguid uuid,
    last_webauthn_challenge_data jsonb
);


--
-- TOC entry 6049 (class 0 OID 0)
-- Dependencies: 328
-- Name: TABLE mfa_factors; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON TABLE auth.mfa_factors IS 'auth: stores metadata about factors';


--
-- TOC entry 6050 (class 0 OID 0)
-- Dependencies: 328
-- Name: COLUMN mfa_factors.last_webauthn_challenge_data; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON COLUMN auth.mfa_factors.last_webauthn_challenge_data IS 'Stores the latest WebAuthn challenge data including attestation/assertion for customer verification';


--
-- TOC entry 376 (class 1259 OID 393221)
-- Name: oauth_authorizations; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.oauth_authorizations (
    id uuid NOT NULL,
    authorization_id text NOT NULL,
    client_id uuid NOT NULL,
    user_id uuid,
    redirect_uri text NOT NULL,
    scope text NOT NULL,
    state text,
    resource text,
    code_challenge text,
    code_challenge_method auth.code_challenge_method,
    response_type auth.oauth_response_type DEFAULT 'code'::auth.oauth_response_type NOT NULL,
    status auth.oauth_authorization_status DEFAULT 'pending'::auth.oauth_authorization_status NOT NULL,
    authorization_code text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    expires_at timestamp with time zone DEFAULT (now() + '00:03:00'::interval) NOT NULL,
    approved_at timestamp with time zone,
    nonce text,
    CONSTRAINT oauth_authorizations_authorization_code_length CHECK ((char_length(authorization_code) <= 255)),
    CONSTRAINT oauth_authorizations_code_challenge_length CHECK ((char_length(code_challenge) <= 128)),
    CONSTRAINT oauth_authorizations_expires_at_future CHECK ((expires_at > created_at)),
    CONSTRAINT oauth_authorizations_nonce_length CHECK ((char_length(nonce) <= 255)),
    CONSTRAINT oauth_authorizations_redirect_uri_length CHECK ((char_length(redirect_uri) <= 2048)),
    CONSTRAINT oauth_authorizations_resource_length CHECK ((char_length(resource) <= 2048)),
    CONSTRAINT oauth_authorizations_scope_length CHECK ((char_length(scope) <= 4096)),
    CONSTRAINT oauth_authorizations_state_length CHECK ((char_length(state) <= 4096))
);


--
-- TOC entry 390 (class 1259 OID 457860)
-- Name: oauth_client_states; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.oauth_client_states (
    id uuid NOT NULL,
    provider_type text NOT NULL,
    code_verifier text,
    created_at timestamp with time zone NOT NULL
);


--
-- TOC entry 6051 (class 0 OID 0)
-- Dependencies: 390
-- Name: TABLE oauth_client_states; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON TABLE auth.oauth_client_states IS 'Stores OAuth states for third-party provider authentication flows where Supabase acts as the OAuth client.';


--
-- TOC entry 374 (class 1259 OID 338525)
-- Name: oauth_clients; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.oauth_clients (
    id uuid NOT NULL,
    client_secret_hash text,
    registration_type auth.oauth_registration_type NOT NULL,
    redirect_uris text NOT NULL,
    grant_types text NOT NULL,
    client_name text,
    client_uri text,
    logo_uri text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone,
    client_type auth.oauth_client_type DEFAULT 'confidential'::auth.oauth_client_type NOT NULL,
    token_endpoint_auth_method text NOT NULL,
    CONSTRAINT oauth_clients_client_name_length CHECK ((char_length(client_name) <= 1024)),
    CONSTRAINT oauth_clients_client_uri_length CHECK ((char_length(client_uri) <= 2048)),
    CONSTRAINT oauth_clients_logo_uri_length CHECK ((char_length(logo_uri) <= 2048)),
    CONSTRAINT oauth_clients_token_endpoint_auth_method_check CHECK ((token_endpoint_auth_method = ANY (ARRAY['client_secret_basic'::text, 'client_secret_post'::text, 'none'::text])))
);


--
-- TOC entry 377 (class 1259 OID 393254)
-- Name: oauth_consents; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.oauth_consents (
    id uuid NOT NULL,
    user_id uuid NOT NULL,
    client_id uuid NOT NULL,
    scopes text NOT NULL,
    granted_at timestamp with time zone DEFAULT now() NOT NULL,
    revoked_at timestamp with time zone,
    CONSTRAINT oauth_consents_revoked_after_granted CHECK (((revoked_at IS NULL) OR (revoked_at >= granted_at))),
    CONSTRAINT oauth_consents_scopes_length CHECK ((char_length(scopes) <= 2048)),
    CONSTRAINT oauth_consents_scopes_not_empty CHECK ((char_length(TRIM(BOTH FROM scopes)) > 0))
);


--
-- TOC entry 329 (class 1259 OID 30770)
-- Name: one_time_tokens; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.one_time_tokens (
    id uuid NOT NULL,
    user_id uuid NOT NULL,
    token_type auth.one_time_token_type NOT NULL,
    token_hash text NOT NULL,
    relates_to text NOT NULL,
    created_at timestamp without time zone DEFAULT now() NOT NULL,
    updated_at timestamp without time zone DEFAULT now() NOT NULL,
    CONSTRAINT one_time_tokens_token_hash_check CHECK ((char_length(token_hash) > 0))
);


--
-- TOC entry 330 (class 1259 OID 30778)
-- Name: refresh_tokens; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.refresh_tokens (
    instance_id uuid,
    id bigint NOT NULL,
    token character varying(255),
    user_id character varying(255),
    revoked boolean,
    created_at timestamp with time zone,
    updated_at timestamp with time zone,
    parent character varying(255),
    session_id uuid
);


--
-- TOC entry 6052 (class 0 OID 0)
-- Dependencies: 330
-- Name: TABLE refresh_tokens; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON TABLE auth.refresh_tokens IS 'Auth: Store of tokens used to refresh JWT tokens once they expire.';


--
-- TOC entry 331 (class 1259 OID 30783)
-- Name: refresh_tokens_id_seq; Type: SEQUENCE; Schema: auth; Owner: -
--

CREATE SEQUENCE auth.refresh_tokens_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- TOC entry 6053 (class 0 OID 0)
-- Dependencies: 331
-- Name: refresh_tokens_id_seq; Type: SEQUENCE OWNED BY; Schema: auth; Owner: -
--

ALTER SEQUENCE auth.refresh_tokens_id_seq OWNED BY auth.refresh_tokens.id;


--
-- TOC entry 332 (class 1259 OID 30784)
-- Name: saml_providers; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.saml_providers (
    id uuid NOT NULL,
    sso_provider_id uuid NOT NULL,
    entity_id text NOT NULL,
    metadata_xml text NOT NULL,
    metadata_url text,
    attribute_mapping jsonb,
    created_at timestamp with time zone,
    updated_at timestamp with time zone,
    name_id_format text,
    CONSTRAINT "entity_id not empty" CHECK ((char_length(entity_id) > 0)),
    CONSTRAINT "metadata_url not empty" CHECK (((metadata_url = NULL::text) OR (char_length(metadata_url) > 0))),
    CONSTRAINT "metadata_xml not empty" CHECK ((char_length(metadata_xml) > 0))
);


--
-- TOC entry 6054 (class 0 OID 0)
-- Dependencies: 332
-- Name: TABLE saml_providers; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON TABLE auth.saml_providers IS 'Auth: Manages SAML Identity Provider connections.';


--
-- TOC entry 333 (class 1259 OID 30792)
-- Name: saml_relay_states; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.saml_relay_states (
    id uuid NOT NULL,
    sso_provider_id uuid NOT NULL,
    request_id text NOT NULL,
    for_email text,
    redirect_to text,
    created_at timestamp with time zone,
    updated_at timestamp with time zone,
    flow_state_id uuid,
    CONSTRAINT "request_id not empty" CHECK ((char_length(request_id) > 0))
);


--
-- TOC entry 6055 (class 0 OID 0)
-- Dependencies: 333
-- Name: TABLE saml_relay_states; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON TABLE auth.saml_relay_states IS 'Auth: Contains SAML Relay State information for each Service Provider initiated login.';


--
-- TOC entry 334 (class 1259 OID 30798)
-- Name: schema_migrations; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.schema_migrations (
    version character varying(255) NOT NULL
);


--
-- TOC entry 6056 (class 0 OID 0)
-- Dependencies: 334
-- Name: TABLE schema_migrations; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON TABLE auth.schema_migrations IS 'Auth: Manages updates to the auth system.';


--
-- TOC entry 335 (class 1259 OID 30801)
-- Name: sessions; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.sessions (
    id uuid NOT NULL,
    user_id uuid NOT NULL,
    created_at timestamp with time zone,
    updated_at timestamp with time zone,
    factor_id uuid,
    aal auth.aal_level,
    not_after timestamp with time zone,
    refreshed_at timestamp without time zone,
    user_agent text,
    ip inet,
    tag text,
    oauth_client_id uuid,
    refresh_token_hmac_key text,
    refresh_token_counter bigint,
    scopes text,
    CONSTRAINT sessions_scopes_length CHECK ((char_length(scopes) <= 4096))
);


--
-- TOC entry 6057 (class 0 OID 0)
-- Dependencies: 335
-- Name: TABLE sessions; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON TABLE auth.sessions IS 'Auth: Stores session data associated to a user.';


--
-- TOC entry 6058 (class 0 OID 0)
-- Dependencies: 335
-- Name: COLUMN sessions.not_after; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON COLUMN auth.sessions.not_after IS 'Auth: Not after is a nullable column that contains a timestamp after which the session should be regarded as expired.';


--
-- TOC entry 6059 (class 0 OID 0)
-- Dependencies: 335
-- Name: COLUMN sessions.refresh_token_hmac_key; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON COLUMN auth.sessions.refresh_token_hmac_key IS 'Holds a HMAC-SHA256 key used to sign refresh tokens for this session.';


--
-- TOC entry 6060 (class 0 OID 0)
-- Dependencies: 335
-- Name: COLUMN sessions.refresh_token_counter; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON COLUMN auth.sessions.refresh_token_counter IS 'Holds the ID (counter) of the last issued refresh token.';


--
-- TOC entry 336 (class 1259 OID 30806)
-- Name: sso_domains; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.sso_domains (
    id uuid NOT NULL,
    sso_provider_id uuid NOT NULL,
    domain text NOT NULL,
    created_at timestamp with time zone,
    updated_at timestamp with time zone,
    CONSTRAINT "domain not empty" CHECK ((char_length(domain) > 0))
);


--
-- TOC entry 6061 (class 0 OID 0)
-- Dependencies: 336
-- Name: TABLE sso_domains; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON TABLE auth.sso_domains IS 'Auth: Manages SSO email address domain mapping to an SSO Identity Provider.';


--
-- TOC entry 337 (class 1259 OID 30812)
-- Name: sso_providers; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.sso_providers (
    id uuid NOT NULL,
    resource_id text,
    created_at timestamp with time zone,
    updated_at timestamp with time zone,
    disabled boolean,
    CONSTRAINT "resource_id not empty" CHECK (((resource_id = NULL::text) OR (char_length(resource_id) > 0)))
);


--
-- TOC entry 6062 (class 0 OID 0)
-- Dependencies: 337
-- Name: TABLE sso_providers; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON TABLE auth.sso_providers IS 'Auth: Manages SSO identity provider information; see saml_providers for SAML.';


--
-- TOC entry 6063 (class 0 OID 0)
-- Dependencies: 337
-- Name: COLUMN sso_providers.resource_id; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON COLUMN auth.sso_providers.resource_id IS 'Auth: Uniquely identifies a SSO provider according to a user-chosen resource ID (case insensitive), useful in infrastructure as code.';


--
-- TOC entry 338 (class 1259 OID 30818)
-- Name: users; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.users (
    instance_id uuid,
    id uuid NOT NULL,
    aud character varying(255),
    role character varying(255),
    email character varying(255),
    encrypted_password character varying(255),
    email_confirmed_at timestamp with time zone,
    invited_at timestamp with time zone,
    confirmation_token character varying(255),
    confirmation_sent_at timestamp with time zone,
    recovery_token character varying(255),
    recovery_sent_at timestamp with time zone,
    email_change_token_new character varying(255),
    email_change character varying(255),
    email_change_sent_at timestamp with time zone,
    last_sign_in_at timestamp with time zone,
    raw_app_meta_data jsonb,
    raw_user_meta_data jsonb,
    is_super_admin boolean,
    created_at timestamp with time zone,
    updated_at timestamp with time zone,
    phone text DEFAULT NULL::character varying,
    phone_confirmed_at timestamp with time zone,
    phone_change text DEFAULT ''::character varying,
    phone_change_token character varying(255) DEFAULT ''::character varying,
    phone_change_sent_at timestamp with time zone,
    confirmed_at timestamp with time zone GENERATED ALWAYS AS (LEAST(email_confirmed_at, phone_confirmed_at)) STORED,
    email_change_token_current character varying(255) DEFAULT ''::character varying,
    email_change_confirm_status smallint DEFAULT 0,
    banned_until timestamp with time zone,
    reauthentication_token character varying(255) DEFAULT ''::character varying,
    reauthentication_sent_at timestamp with time zone,
    is_sso_user boolean DEFAULT false NOT NULL,
    deleted_at timestamp with time zone,
    is_anonymous boolean DEFAULT false NOT NULL,
    CONSTRAINT users_email_change_confirm_status_check CHECK (((email_change_confirm_status >= 0) AND (email_change_confirm_status <= 2)))
);


--
-- TOC entry 6064 (class 0 OID 0)
-- Dependencies: 338
-- Name: TABLE users; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON TABLE auth.users IS 'Auth: Stores user login data within a secure schema.';


--
-- TOC entry 6065 (class 0 OID 0)
-- Dependencies: 338
-- Name: COLUMN users.is_sso_user; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON COLUMN auth.users.is_sso_user IS 'Auth: Set this column to true when the account comes from SSO. These accounts can have duplicate emails.';


--
-- TOC entry 397 (class 1259 OID 511783)
-- Name: admin_audit_logs; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.admin_audit_logs (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    admin_id uuid NOT NULL,
    action text NOT NULL,
    target_type text NOT NULL,
    target_id uuid,
    old_values jsonb,
    new_values jsonb,
    ip_address inet,
    user_agent text,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- TOC entry 6066 (class 0 OID 0)
-- Dependencies: 397
-- Name: TABLE admin_audit_logs; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.admin_audit_logs IS 'Tracks all administrative actions for compliance and debugging';


--
-- TOC entry 401 (class 1259 OID 511890)
-- Name: admin_messages; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.admin_messages (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    sent_by uuid NOT NULL,
    recipient_id uuid,
    message_type text DEFAULT 'direct'::text NOT NULL,
    recipient_role public.user_role,
    subject text,
    body text NOT NULL,
    sent_at timestamp with time zone DEFAULT now() NOT NULL,
    read_at timestamp with time zone,
    push_notification_sent boolean DEFAULT false,
    metadata jsonb DEFAULT '{}'::jsonb
);


--
-- TOC entry 6067 (class 0 OID 0)
-- Dependencies: 401
-- Name: TABLE admin_messages; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.admin_messages IS 'Admin-to-user messaging system';


--
-- TOC entry 6068 (class 0 OID 0)
-- Dependencies: 401
-- Name: COLUMN admin_messages.message_type; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.admin_messages.message_type IS 'direct = single user, broadcast = multiple users, system = automated';


--
-- TOC entry 6069 (class 0 OID 0)
-- Dependencies: 401
-- Name: COLUMN admin_messages.recipient_role; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.admin_messages.recipient_role IS 'For broadcasts: target role (Driver, Shipper, or NULL for all)';


--
-- TOC entry 339 (class 1259 OID 30833)
-- Name: bids; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.bids (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    freight_post_id uuid NOT NULL,
    vehicle_id uuid,
    bid_amount numeric NOT NULL,
    delivery_date timestamp with time zone NOT NULL,
    created_at timestamp with time zone DEFAULT now(),
    modified_at timestamp with time zone DEFAULT now(),
    status public.bid_status DEFAULT 'Open'::public.bid_status NOT NULL,
    pickup_date timestamp with time zone,
    notes text,
    CONSTRAINT bids_bid_amount_check CHECK ((bid_amount >= (0)::numeric))
);

ALTER TABLE ONLY public.bids REPLICA IDENTITY FULL;


--
-- TOC entry 388 (class 1259 OID 444943)
-- Name: commission_ledger; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.commission_ledger (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    freight_post_id uuid,
    payment_id uuid,
    escrow_id uuid,
    payout_id uuid,
    refund_id uuid,
    transaction_type public.transaction_type NOT NULL,
    description text NOT NULL,
    amount numeric NOT NULL,
    running_balance numeric NOT NULL,
    currency text DEFAULT 'ZAR'::text NOT NULL,
    transaction_date timestamp with time zone DEFAULT now() NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    metadata jsonb DEFAULT '{}'::jsonb
);


--
-- TOC entry 6070 (class 0 OID 0)
-- Dependencies: 388
-- Name: TABLE commission_ledger; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.commission_ledger IS 'Tracks all commission entries for platform revenue accounting';


--
-- TOC entry 6071 (class 0 OID 0)
-- Dependencies: 388
-- Name: COLUMN commission_ledger.running_balance; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.commission_ledger.running_balance IS 'Running total of platform commission balance';


--
-- TOC entry 402 (class 1259 OID 522080)
-- Name: device_tokens; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.device_tokens (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    fcm_token text NOT NULL,
    device_name text,
    platform text DEFAULT 'android'::text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- TOC entry 400 (class 1259 OID 511868)
-- Name: dispute_evidence; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.dispute_evidence (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    dispute_id uuid NOT NULL,
    submitted_by uuid NOT NULL,
    evidence_type text NOT NULL,
    file_url text,
    description text,
    metadata jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- TOC entry 6072 (class 0 OID 0)
-- Dependencies: 400
-- Name: TABLE dispute_evidence; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.dispute_evidence IS 'Stores evidence files and notes for disputes';


--
-- TOC entry 6073 (class 0 OID 0)
-- Dependencies: 400
-- Name: COLUMN dispute_evidence.metadata; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.dispute_evidence.metadata IS 'Additional data like GPS coordinates, timestamps, etc.';


--
-- TOC entry 399 (class 1259 OID 511824)
-- Name: disputes; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.disputes (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    freight_post_id uuid NOT NULL,
    raised_by uuid NOT NULL,
    raised_against uuid NOT NULL,
    dispute_type public.dispute_type NOT NULL,
    priority public.dispute_priority DEFAULT 'medium'::public.dispute_priority NOT NULL,
    status public.dispute_status DEFAULT 'open'::public.dispute_status NOT NULL,
    title text NOT NULL,
    description text NOT NULL,
    admin_assigned uuid,
    resolution text,
    resolved_by uuid,
    resolved_at timestamp with time zone,
    refund_amount numeric(10,2),
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- TOC entry 6074 (class 0 OID 0)
-- Dependencies: 399
-- Name: TABLE disputes; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.disputes IS 'Tracks disputes between shippers and drivers';


--
-- TOC entry 6075 (class 0 OID 0)
-- Dependencies: 399
-- Name: COLUMN disputes.raised_by; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.disputes.raised_by IS 'User who raised the dispute (shipper or driver)';


--
-- TOC entry 6076 (class 0 OID 0)
-- Dependencies: 399
-- Name: COLUMN disputes.raised_against; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.disputes.raised_against IS 'User the dispute is against (shipper or driver)';


--
-- TOC entry 6077 (class 0 OID 0)
-- Dependencies: 399
-- Name: COLUMN disputes.admin_assigned; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.disputes.admin_assigned IS 'Admin user assigned to handle this dispute';


--
-- TOC entry 398 (class 1259 OID 511801)
-- Name: driver_approval_history; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.driver_approval_history (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    driver_id uuid NOT NULL,
    admin_id uuid NOT NULL,
    previous_status public.verification_status,
    new_status public.verification_status NOT NULL,
    reason text,
    notes text,
    documents_reviewed jsonb DEFAULT '[]'::jsonb,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- TOC entry 6078 (class 0 OID 0)
-- Dependencies: 398
-- Name: TABLE driver_approval_history; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.driver_approval_history IS 'Tracks the history of driver verification status changes';


--
-- TOC entry 385 (class 1259 OID 444829)
-- Name: driver_bank_accounts; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.driver_bank_accounts (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    driver_id uuid NOT NULL,
    bank_code text NOT NULL,
    bank_name text NOT NULL,
    account_number text NOT NULL,
    account_name text NOT NULL,
    paystack_recipient_code text,
    paystack_recipient_id text,
    is_verified boolean DEFAULT false NOT NULL,
    verified_at timestamp with time zone,
    verification_details jsonb DEFAULT '{}'::jsonb,
    is_primary boolean DEFAULT true NOT NULL,
    is_active boolean DEFAULT true NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    currency text DEFAULT 'ZAR'::text NOT NULL,
    verified_by uuid,
    verification_method text DEFAULT 'api'::text,
    verification_notes text,
    rejected_at timestamp with time zone,
    rejection_reason text
);


--
-- TOC entry 6079 (class 0 OID 0)
-- Dependencies: 385
-- Name: TABLE driver_bank_accounts; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.driver_bank_accounts IS 'Stores driver bank account details and Paystack transfer recipient codes';


--
-- TOC entry 6080 (class 0 OID 0)
-- Dependencies: 385
-- Name: COLUMN driver_bank_accounts.paystack_recipient_code; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.driver_bank_accounts.paystack_recipient_code IS 'Paystack transfer recipient code (RCP_xxx) for initiating transfers';


--
-- TOC entry 6081 (class 0 OID 0)
-- Dependencies: 385
-- Name: COLUMN driver_bank_accounts.verification_method; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.driver_bank_accounts.verification_method IS 'Method used: api (Paystack), manual, override';


--
-- TOC entry 367 (class 1259 OID 146962)
-- Name: driver_docs; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.driver_docs (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    created_at timestamp with time zone NOT NULL,
    doc_type text NOT NULL,
    doc_url text NOT NULL,
    modified_at timestamp with time zone NOT NULL,
    driver_id uuid NOT NULL,
    verification_status public.verification_status DEFAULT 'pending'::public.verification_status,
    verified_by uuid,
    verified_at timestamp with time zone,
    rejection_reason text,
    admin_notes text,
    expiry_date date
);


--
-- TOC entry 386 (class 1259 OID 444852)
-- Name: driver_payouts; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.driver_payouts (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    escrow_id uuid NOT NULL,
    freight_post_id uuid NOT NULL,
    bid_id uuid NOT NULL,
    driver_id uuid NOT NULL,
    bank_account_id uuid,
    gross_amount numeric NOT NULL,
    driver_commission numeric NOT NULL,
    net_amount numeric NOT NULL,
    transfer_fee numeric DEFAULT 0,
    paystack_transfer_code text,
    paystack_transfer_reference text,
    paystack_recipient_code text,
    status public.transfer_status DEFAULT 'pending'::public.transfer_status NOT NULL,
    failure_reason text,
    initiated_at timestamp with time zone DEFAULT now(),
    completed_at timestamp with time zone,
    failed_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT payout_gross_amount_positive CHECK ((gross_amount > (0)::numeric)),
    CONSTRAINT payout_net_amount_positive CHECK ((net_amount > (0)::numeric))
);


--
-- TOC entry 6082 (class 0 OID 0)
-- Dependencies: 386
-- Name: TABLE driver_payouts; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.driver_payouts IS 'Tracks all payouts to drivers after successful delivery confirmation';


--
-- TOC entry 6083 (class 0 OID 0)
-- Dependencies: 386
-- Name: COLUMN driver_payouts.net_amount; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.driver_payouts.net_amount IS 'Final amount transferred to driver (bid_amount - 5% commission)';


--
-- TOC entry 392 (class 1259 OID 479822)
-- Name: driver_tracking_sessions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.driver_tracking_sessions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    driver_id uuid NOT NULL,
    status text DEFAULT 'active'::text NOT NULL,
    started_at timestamp with time zone DEFAULT now() NOT NULL,
    completed_at timestamp with time zone,
    paused_at timestamp with time zone,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    current_latitude double precision,
    current_longitude double precision,
    current_speed double precision,
    current_heading double precision,
    last_location_update timestamp with time zone,
    total_points integer DEFAULT 0 NOT NULL,
    distance_traveled double precision DEFAULT 0.0 NOT NULL,
    update_interval_seconds integer DEFAULT 30 NOT NULL,
    min_distance_filter double precision DEFAULT 10.0 NOT NULL,
    distance_remaining double precision,
    eta_minutes integer,
    driver_photo_url text,
    CONSTRAINT driver_tracking_sessions_status_check CHECK ((status = ANY (ARRAY['active'::text, 'paused'::text, 'completed'::text])))
);

ALTER TABLE ONLY public.driver_tracking_sessions REPLICA IDENTITY FULL;


--
-- TOC entry 6084 (class 0 OID 0)
-- Dependencies: 392
-- Name: TABLE driver_tracking_sessions; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.driver_tracking_sessions IS 'Driver-level GPS tracking sessions supporting multiple concurrent shipments';


--
-- TOC entry 6085 (class 0 OID 0)
-- Dependencies: 392
-- Name: COLUMN driver_tracking_sessions.distance_remaining; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.driver_tracking_sessions.distance_remaining IS 'Remaining distance to destination in kilometers (calculated for primary active shipment)';


--
-- TOC entry 6086 (class 0 OID 0)
-- Dependencies: 392
-- Name: COLUMN driver_tracking_sessions.eta_minutes; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.driver_tracking_sessions.eta_minutes IS 'Estimated time of arrival in minutes (calculated for primary active shipment based on current speed and distance)';


--
-- TOC entry 6087 (class 0 OID 0)
-- Dependencies: 392
-- Name: COLUMN driver_tracking_sessions.driver_photo_url; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.driver_tracking_sessions.driver_photo_url IS 'Cached driver profile photo URL for UI display';


--
-- TOC entry 393 (class 1259 OID 479847)
-- Name: driver_tracking_shipments; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.driver_tracking_shipments (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    driver_tracking_id uuid NOT NULL,
    shipment_id uuid NOT NULL,
    added_at timestamp with time zone DEFAULT now() NOT NULL,
    removed_at timestamp with time zone
);


--
-- TOC entry 6088 (class 0 OID 0)
-- Dependencies: 393
-- Name: TABLE driver_tracking_shipments; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.driver_tracking_shipments IS 'Junction table linking shipments to driver tracking sessions';


--
-- TOC entry 384 (class 1259 OID 444789)
-- Name: escrow_holdings; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.escrow_holdings (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    payment_id uuid NOT NULL,
    freight_post_id uuid NOT NULL,
    bid_id uuid NOT NULL,
    shipper_id uuid NOT NULL,
    held_amount numeric NOT NULL,
    bid_amount numeric NOT NULL,
    shipper_commission numeric NOT NULL,
    driver_commission numeric NOT NULL,
    platform_commission numeric NOT NULL,
    status public.escrow_status DEFAULT 'pending'::public.escrow_status NOT NULL,
    released_amount numeric DEFAULT 0,
    refunded_amount numeric DEFAULT 0,
    held_at timestamp with time zone,
    released_at timestamp with time zone,
    refunded_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT escrow_bid_amount_positive CHECK ((bid_amount > (0)::numeric)),
    CONSTRAINT escrow_held_amount_positive CHECK ((held_amount > (0)::numeric))
);


--
-- TOC entry 6089 (class 0 OID 0)
-- Dependencies: 384
-- Name: TABLE escrow_holdings; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.escrow_holdings IS 'Tracks funds held by platform between shipper payment and driver payout';


--
-- TOC entry 6090 (class 0 OID 0)
-- Dependencies: 384
-- Name: COLUMN escrow_holdings.held_amount; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.escrow_holdings.held_amount IS 'Total amount charged to shipper (bid + shipper commission)';


--
-- TOC entry 6091 (class 0 OID 0)
-- Dependencies: 384
-- Name: COLUMN escrow_holdings.platform_commission; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.escrow_holdings.platform_commission IS 'Total platform commission (shipper_commission + driver_commission = 10%)';


--
-- TOC entry 391 (class 1259 OID 479761)
-- Name: flagged_documents; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.flagged_documents (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    document_id uuid NOT NULL,
    driver_id uuid NOT NULL,
    flagged_by_user_id uuid NOT NULL,
    shipment_id uuid,
    reason text NOT NULL,
    notes text,
    status text DEFAULT 'pending'::text NOT NULL,
    admin_notes text,
    reviewed_by_admin_id uuid,
    reviewed_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- TOC entry 340 (class 1259 OID 30842)
-- Name: freight_items; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.freight_items (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    freight_post_id uuid NOT NULL,
    weight_kg numeric NOT NULL,
    length_cm numeric NOT NULL,
    width_cm numeric NOT NULL,
    height_cm numeric NOT NULL,
    volume_cm3 numeric GENERATED ALWAYS AS (((length_cm * width_cm) * height_cm)) STORED,
    photo_url text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    quantity integer DEFAULT 1 NOT NULL,
    CONSTRAINT freight_items_height_cm_check CHECK ((height_cm > (0)::numeric)),
    CONSTRAINT freight_items_length_cm_check CHECK ((length_cm > (0)::numeric)),
    CONSTRAINT freight_items_weight_kg_check CHECK ((weight_kg > (0)::numeric)),
    CONSTRAINT freight_items_width_cm_check CHECK ((width_cm > (0)::numeric))
);


--
-- TOC entry 6092 (class 0 OID 0)
-- Dependencies: 340
-- Name: COLUMN freight_items.quantity; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.freight_items.quantity IS 'Number of items of this type (e.g., 5 pallets, 3 boxes)';


--
-- TOC entry 381 (class 1259 OID 433353)
-- Name: freight_moving; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.freight_moving (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    freight_post_id uuid NOT NULL,
    property_type text NOT NULL,
    has_store_room boolean DEFAULT false,
    has_outdoor_furniture boolean DEFAULT false,
    truck_capacity_tons integer,
    additional_notes text,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- TOC entry 341 (class 1259 OID 30856)
-- Name: freight_posts; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.freight_posts (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    shipper_id uuid NOT NULL,
    notes text,
    description text NOT NULL,
    pickup_location public.geometry(Point) NOT NULL,
    dropoff_location public.geometry(Point),
    delivery_time_window tstzrange,
    status public.freight_status DEFAULT 'Bidding'::public.freight_status NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    rated boolean DEFAULT false NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    archived boolean DEFAULT false NOT NULL,
    archived_at timestamp with time zone,
    pickup_pin text,
    delivery_pin text,
    pickup_confirmed_at timestamp with time zone,
    delivery_confirmed_at timestamp with time zone,
    rated_at timestamp with time zone,
    currency text DEFAULT '''ZAR''::text'::text NOT NULL,
    pickup_location_name text,
    dropoff_location_name text,
    lowest_bid numeric DEFAULT 0.0,
    freight_type public.freight_type DEFAULT 'items'::public.freight_type NOT NULL,
    CONSTRAINT check_rubble_delivery_fields CHECK ((((freight_type = 'rubble'::public.freight_type) AND (dropoff_location IS NULL) AND (delivery_time_window IS NULL)) OR ((freight_type <> 'rubble'::public.freight_type) AND (dropoff_location IS NOT NULL) AND (delivery_time_window IS NOT NULL))))
);

ALTER TABLE ONLY public.freight_posts REPLICA IDENTITY FULL;


--
-- TOC entry 6093 (class 0 OID 0)
-- Dependencies: 341
-- Name: COLUMN freight_posts.currency; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.freight_posts.currency IS 'ISO 4217 currency code (e.g., USD, EUR, GBP, ZAR) for this freight posting';


--
-- TOC entry 6094 (class 0 OID 0)
-- Dependencies: 341
-- Name: CONSTRAINT check_rubble_delivery_fields ON freight_posts; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON CONSTRAINT check_rubble_delivery_fields ON public.freight_posts IS 'Rubble shipments do not require delivery location or time window. Non-rubble shipments must have both.';


--
-- TOC entry 382 (class 1259 OID 433378)
-- Name: freight_rubble; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.freight_rubble (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    freight_post_id uuid NOT NULL,
    waste_type text NOT NULL,
    estimated_volume_m3 numeric,
    photo_url text,
    additional_notes text,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- TOC entry 383 (class 1259 OID 433399)
-- Name: freight_vehicles; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.freight_vehicles (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    freight_post_id uuid NOT NULL,
    vehicle_type text NOT NULL,
    running_condition text NOT NULL,
    photo_url text,
    additional_notes text,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- TOC entry 368 (class 1259 OID 270552)
-- Name: notification_type_preferences; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.notification_type_preferences (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    notification_type public.notification_type NOT NULL,
    push_enabled boolean DEFAULT false NOT NULL,
    sms_enabled boolean DEFAULT false NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- TOC entry 342 (class 1259 OID 30865)
-- Name: notifications; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.notifications (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    message text NOT NULL,
    is_read boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now(),
    archived boolean DEFAULT false NOT NULL,
    archived_at timestamp with time zone,
    type public.notification_type,
    related_id uuid,
    delivery_method text,
    sent_at timestamp with time zone,
    CONSTRAINT notifications_delivery_method_check CHECK ((delivery_method = ANY (ARRAY['push'::text, 'sms'::text, 'both'::text])))
);


--
-- TOC entry 387 (class 1259 OID 444900)
-- Name: payment_refunds; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.payment_refunds (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    payment_id uuid NOT NULL,
    escrow_id uuid NOT NULL,
    freight_post_id uuid NOT NULL,
    shipper_id uuid NOT NULL,
    original_amount numeric NOT NULL,
    refund_amount numeric NOT NULL,
    cancellation_fee numeric NOT NULL,
    paystack_refund_reference text,
    paystack_transaction_reference text,
    status public.transfer_status DEFAULT 'pending'::public.transfer_status NOT NULL,
    failure_reason text,
    cancellation_reason text,
    cancelled_by uuid,
    initiated_at timestamp with time zone DEFAULT now(),
    processed_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT refund_amount_positive CHECK ((refund_amount > (0)::numeric)),
    CONSTRAINT refund_fee_non_negative CHECK ((cancellation_fee >= (0)::numeric))
);


--
-- TOC entry 6095 (class 0 OID 0)
-- Dependencies: 387
-- Name: TABLE payment_refunds; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.payment_refunds IS 'Tracks refunds issued to shippers for cancelled shipments';


--
-- TOC entry 6096 (class 0 OID 0)
-- Dependencies: 387
-- Name: COLUMN payment_refunds.cancellation_fee; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.payment_refunds.cancellation_fee IS '5% fee retained by platform on cancellation';


--
-- TOC entry 343 (class 1259 OID 30874)
-- Name: payments; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.payments (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    freight_post_id uuid NOT NULL,
    bid_id uuid NOT NULL,
    amount numeric NOT NULL,
    transaction_id text NOT NULL,
    status public.payment_status NOT NULL,
    created_at timestamp with time zone DEFAULT now(),
    modified_at timestamp with time zone DEFAULT now(),
    shipper_id uuid,
    bid_amount numeric DEFAULT 0 NOT NULL,
    shipper_commission numeric DEFAULT 0 NOT NULL,
    driver_commission numeric DEFAULT 0 NOT NULL,
    total_commission numeric DEFAULT 0 NOT NULL,
    paystack_reference text,
    paystack_access_code text,
    paystack_authorization_url text,
    payment_channel text,
    payment_method text,
    currency text DEFAULT 'ZAR'::text,
    paid_at timestamp with time zone,
    metadata jsonb DEFAULT '{}'::jsonb
);


--
-- TOC entry 389 (class 1259 OID 444983)
-- Name: paystack_webhook_events; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.paystack_webhook_events (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    event_type text NOT NULL,
    event_id text,
    paystack_reference text,
    payload jsonb NOT NULL,
    processed boolean DEFAULT false NOT NULL,
    processed_at timestamp with time zone,
    processing_error text,
    received_at timestamp with time zone DEFAULT now() NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- TOC entry 6097 (class 0 OID 0)
-- Dependencies: 389
-- Name: TABLE paystack_webhook_events; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.paystack_webhook_events IS 'Stores all Paystack webhook events for audit and debugging';


--
-- TOC entry 344 (class 1259 OID 30882)
-- Name: ratings; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.ratings (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    freight_post_id uuid NOT NULL,
    rated_by_user_id uuid NOT NULL,
    rated_user_id uuid NOT NULL,
    score integer NOT NULL,
    comment text,
    created_at timestamp with time zone DEFAULT now(),
    CONSTRAINT ratings_score_check CHECK (((score >= 1) AND (score <= 5)))
);


--
-- TOC entry 378 (class 1259 OID 423762)
-- Name: route_cache; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.route_cache (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    origin_lat numeric NOT NULL,
    origin_lng numeric NOT NULL,
    destination_lat numeric NOT NULL,
    destination_lng numeric NOT NULL,
    origin_place_id character varying(255) DEFAULT NULL::character varying,
    destination_place_id character varying(255) DEFAULT NULL::character varying,
    cache_key character varying(255) NOT NULL,
    route_data jsonb NOT NULL,
    total_distance_meters integer NOT NULL,
    total_duration_seconds integer NOT NULL,
    polyline_encoded text NOT NULL,
    hit_count integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now(),
    last_accessed_at timestamp with time zone DEFAULT now(),
    expires_at timestamp with time zone DEFAULT (now() + '7 days'::interval),
    created_by uuid,
    updated_at timestamp with time zone DEFAULT now()
);


--
-- TOC entry 6098 (class 0 OID 0)
-- Dependencies: 378
-- Name: TABLE route_cache; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.route_cache IS 'Server-side cache for Google Directions API responses to reduce mobile data usage';


--
-- TOC entry 6099 (class 0 OID 0)
-- Dependencies: 378
-- Name: COLUMN route_cache.cache_key; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.route_cache.cache_key IS 'MD5 hash of origin/destination coordinates for fast lookups';


--
-- TOC entry 6100 (class 0 OID 0)
-- Dependencies: 378
-- Name: COLUMN route_cache.route_data; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.route_cache.route_data IS 'Full Google Directions API JSON response';


--
-- TOC entry 6101 (class 0 OID 0)
-- Dependencies: 378
-- Name: COLUMN route_cache.polyline_encoded; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.route_cache.polyline_encoded IS 'Google encoded polyline (compressed route geometry)';


--
-- TOC entry 6102 (class 0 OID 0)
-- Dependencies: 378
-- Name: COLUMN route_cache.hit_count; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.route_cache.hit_count IS 'Number of times this cached route has been reused';


--
-- TOC entry 6103 (class 0 OID 0)
-- Dependencies: 378
-- Name: COLUMN route_cache.expires_at; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.route_cache.expires_at IS 'Cache expiration timestamp (default: 7 days from creation)';


--
-- TOC entry 394 (class 1259 OID 486856)
-- Name: shipment_tracking_metrics; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.shipment_tracking_metrics (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    driver_tracking_session_id uuid NOT NULL,
    shipment_id uuid NOT NULL,
    distance_remaining double precision,
    eta_minutes integer,
    last_calculated_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY public.shipment_tracking_metrics REPLICA IDENTITY FULL;


--
-- TOC entry 6104 (class 0 OID 0)
-- Dependencies: 394
-- Name: TABLE shipment_tracking_metrics; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.shipment_tracking_metrics IS 'Per-shipment ETA and distance metrics for multi-shipment tracking';


--
-- TOC entry 369 (class 1259 OID 270644)
-- Name: sms_billing; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.sms_billing (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    notification_id uuid,
    phone_number text NOT NULL,
    message_content text NOT NULL,
    sent_at timestamp with time zone DEFAULT now() NOT NULL,
    cost_cents integer DEFAULT 5 NOT NULL,
    is_paid boolean DEFAULT false NOT NULL,
    paid_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- TOC entry 345 (class 1259 OID 30890)
-- Name: users; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.users (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    phone_number text NOT NULL,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    first_name text,
    last_name text,
    dob date,
    email text,
    profile_photo_url text,
    bank_name text,
    account_number text,
    branch_code text,
    role public.user_role DEFAULT 'Shipper'::public.user_role NOT NULL,
    id_no text,
    address public.geometry,
    driver_verified_at timestamp with time zone,
    address_name text,
    fcm_token text,
    notification_radius_km integer DEFAULT 200,
    last_login_at timestamp with time zone,
    failed_login_attempts integer DEFAULT 0,
    locked_until timestamp with time zone,
    driver_verification_status public.verification_status DEFAULT 'pending'::public.verification_status,
    driver_verified_by uuid,
    verification_notes text,
    is_suspended boolean DEFAULT false,
    suspended_at timestamp with time zone,
    suspended_reason text,
    suspended_by uuid,
    suspension_ends_at timestamp with time zone,
    CONSTRAINT users_notification_radius_check CHECK (((notification_radius_km >= 10) AND (notification_radius_km <= 500)))
);


--
-- TOC entry 6105 (class 0 OID 0)
-- Dependencies: 345
-- Name: COLUMN users.notification_radius_km; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.users.notification_radius_km IS 'Notification radius in kilometers for new shipment notifications (10-500km)';


--
-- TOC entry 370 (class 1259 OID 270978)
-- Name: sms_status_simple; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.sms_status_simple AS
 SELECT n.id AS notification_id,
    n.user_id,
    n.type,
    n.message,
    n.delivery_method,
    n.created_at,
    n.sent_at,
    u.phone_number,
    sb.cost_cents,
    sb.sent_at AS sms_sent_at,
        CASE
            WHEN (n.delivery_method = 'push'::text) THEN 'Push Only'::text
            WHEN ((n.delivery_method = 'sms'::text) AND (n.sent_at IS NULL)) THEN 'SMS Pending'::text
            WHEN ((n.delivery_method = 'sms'::text) AND (sb.id IS NOT NULL)) THEN 'SMS Sent'::text
            WHEN ((n.delivery_method = 'both'::text) AND (sb.id IS NOT NULL)) THEN 'Both Sent'::text
            ELSE 'Unknown'::text
        END AS status
   FROM ((public.notifications n
     LEFT JOIN public.users u ON ((n.user_id = u.id)))
     LEFT JOIN public.sms_billing sb ON ((n.id = sb.notification_id)))
  WHERE (n.delivery_method = ANY (ARRAY['sms'::text, 'both'::text]))
  ORDER BY n.created_at DESC;


--
-- TOC entry 395 (class 1259 OID 489244)
-- Name: tracking_health_events; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.tracking_health_events (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    session_id uuid,
    event_type text NOT NULL,
    minutes_stale integer,
    notification_sent boolean DEFAULT false,
    notification_type text,
    metadata jsonb,
    created_at timestamp with time zone DEFAULT now(),
    CONSTRAINT tracking_health_events_event_type_check CHECK ((event_type = ANY (ARRAY['stale_detected'::text, 'recovery_detected'::text, 'notification_sent'::text, 'manual_restart'::text]))),
    CONSTRAINT tracking_health_events_notification_type_check CHECK ((notification_type = ANY (ARRAY['driver_push'::text, 'shipper_in_app'::text, 'both'::text])))
);


--
-- TOC entry 6106 (class 0 OID 0)
-- Dependencies: 395
-- Name: TABLE tracking_health_events; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.tracking_health_events IS 'Logs all tracking health monitoring events for analytics and debugging';


--
-- TOC entry 6107 (class 0 OID 0)
-- Dependencies: 395
-- Name: COLUMN tracking_health_events.event_type; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.tracking_health_events.event_type IS 'Type of health event: stale_detected (no updates), recovery_detected (updates resumed), notification_sent, manual_restart';


--
-- TOC entry 6108 (class 0 OID 0)
-- Dependencies: 395
-- Name: COLUMN tracking_health_events.minutes_stale; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.tracking_health_events.minutes_stale IS 'Number of minutes since last location update when stale was detected';


--
-- TOC entry 6109 (class 0 OID 0)
-- Dependencies: 395
-- Name: COLUMN tracking_health_events.notification_type; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.tracking_health_events.notification_type IS 'Type of notification sent: driver_push (FCM), shipper_in_app, or both';


--
-- TOC entry 396 (class 1259 OID 489269)
-- Name: tracking_health_summary; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.tracking_health_summary AS
 SELECT date_trunc('day'::text, tracking_health_events.created_at) AS date,
    tracking_health_events.event_type,
    count(*) AS event_count,
    count(DISTINCT tracking_health_events.session_id) AS unique_sessions,
    avg(tracking_health_events.minutes_stale) FILTER (WHERE (tracking_health_events.minutes_stale IS NOT NULL)) AS avg_minutes_stale,
    max(tracking_health_events.minutes_stale) FILTER (WHERE (tracking_health_events.minutes_stale IS NOT NULL)) AS max_minutes_stale
   FROM public.tracking_health_events
  WHERE (tracking_health_events.created_at >= (now() - '30 days'::interval))
  GROUP BY (date_trunc('day'::text, tracking_health_events.created_at)), tracking_health_events.event_type
  ORDER BY (date_trunc('day'::text, tracking_health_events.created_at)) DESC, tracking_health_events.event_type;


--
-- TOC entry 6110 (class 0 OID 0)
-- Dependencies: 396
-- Name: VIEW tracking_health_summary; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.tracking_health_summary IS 'Daily summary of tracking health events for the last 30 days';


--
-- TOC entry 375 (class 1259 OID 361937)
-- Name: tracking_points; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.tracking_points (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    tracking_id uuid,
    location public.geometry(Point,4326),
    latitude double precision NOT NULL,
    longitude double precision NOT NULL,
    accuracy double precision,
    altitude double precision,
    speed double precision,
    heading double precision,
    type public.tracking_point_type DEFAULT 'tracking'::public.tracking_point_type NOT NULL,
    "timestamp" timestamp with time zone DEFAULT now() NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    address text,
    distance_from_previous double precision,
    duration_from_previous integer,
    notes text,
    metadata jsonb,
    sequence_number integer,
    driver_tracking_id uuid
);
ALTER TABLE ONLY public.tracking_points ALTER COLUMN tracking_id SET STATISTICS 1000;
ALTER TABLE ONLY public.tracking_points ALTER COLUMN "timestamp" SET STATISTICS 1000;

ALTER TABLE ONLY public.tracking_points REPLICA IDENTITY FULL;


--
-- TOC entry 6111 (class 0 OID 0)
-- Dependencies: 375
-- Name: TABLE tracking_points; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.tracking_points IS 'Individual GPS location points recorded during tracking';


--
-- TOC entry 6112 (class 0 OID 0)
-- Dependencies: 375
-- Name: COLUMN tracking_points.tracking_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.tracking_points.tracking_id IS 'DEPRECATED - Legacy tracking session ID (no longer used)';


--
-- TOC entry 6113 (class 0 OID 0)
-- Dependencies: 375
-- Name: COLUMN tracking_points.location; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.tracking_points.location IS 'PostGIS Point geometry for spatial queries';


--
-- TOC entry 6114 (class 0 OID 0)
-- Dependencies: 375
-- Name: COLUMN tracking_points.distance_from_previous; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.tracking_points.distance_from_previous IS 'Calculated distance from previous point in kilometers';


--
-- TOC entry 6115 (class 0 OID 0)
-- Dependencies: 375
-- Name: COLUMN tracking_points.duration_from_previous; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.tracking_points.duration_from_previous IS 'Time elapsed from previous point in seconds';


--
-- TOC entry 6116 (class 0 OID 0)
-- Dependencies: 375
-- Name: COLUMN tracking_points.sequence_number; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.tracking_points.sequence_number IS 'Chronological sequence number assigned by app. Gaps indicate app was killed or tracking degraded.';


--
-- TOC entry 6117 (class 0 OID 0)
-- Dependencies: 375
-- Name: COLUMN tracking_points.driver_tracking_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.tracking_points.driver_tracking_id IS 'Driver tracking session ID (unified system)';


--
-- TOC entry 357 (class 1259 OID 112672)
-- Name: v_driver_id; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.v_driver_id (
    driver_id uuid
);


--
-- TOC entry 346 (class 1259 OID 30900)
-- Name: vehicles; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.vehicles (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    driver_id uuid NOT NULL,
    type text NOT NULL,
    make text NOT NULL,
    model text NOT NULL,
    year integer,
    license_plate text NOT NULL,
    capacity_tons numeric,
    photo_url text NOT NULL,
    created_at timestamp with time zone DEFAULT now(),
    color text DEFAULT 'White'::text,
    verification_status public.verification_status DEFAULT 'pending'::public.verification_status,
    verified_by uuid,
    verified_at timestamp with time zone,
    registration_document_url text,
    insurance_document_url text,
    roadworthy_certificate_url text,
    additional_photos jsonb DEFAULT '[]'::jsonb,
    rejection_reason text,
    admin_notes text,
    CONSTRAINT vehicles_capacity_tons_check CHECK ((capacity_tons > (0)::numeric)),
    CONSTRAINT vehicles_type_check CHECK ((type = ANY (ARRAY['Cargo Van'::text, 'Pickup Truck'::text, 'Box Truck'::text, 'Flatbed Truck'::text, 'Refrigerated Truck'::text, 'Tanker'::text, 'Semi-Truck'::text])))
);


--
-- TOC entry 5027 (class 2604 OID 30966)
-- Name: refresh_tokens id; Type: DEFAULT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.refresh_tokens ALTER COLUMN id SET DEFAULT nextval('auth.refresh_tokens_id_seq'::regclass);


--
-- TOC entry 5264 (class 2606 OID 30968)
-- Name: mfa_amr_claims amr_id_pk; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.mfa_amr_claims
    ADD CONSTRAINT amr_id_pk PRIMARY KEY (id);


--
-- TOC entry 5248 (class 2606 OID 30970)
-- Name: audit_log_entries audit_log_entries_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.audit_log_entries
    ADD CONSTRAINT audit_log_entries_pkey PRIMARY KEY (id);


--
-- TOC entry 5252 (class 2606 OID 30972)
-- Name: flow_state flow_state_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.flow_state
    ADD CONSTRAINT flow_state_pkey PRIMARY KEY (id);


--
-- TOC entry 5257 (class 2606 OID 30974)
-- Name: identities identities_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.identities
    ADD CONSTRAINT identities_pkey PRIMARY KEY (id);


--
-- TOC entry 5259 (class 2606 OID 30976)
-- Name: identities identities_provider_id_provider_unique; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.identities
    ADD CONSTRAINT identities_provider_id_provider_unique UNIQUE (provider_id, provider);


--
-- TOC entry 5262 (class 2606 OID 30978)
-- Name: instances instances_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.instances
    ADD CONSTRAINT instances_pkey PRIMARY KEY (id);


--
-- TOC entry 5266 (class 2606 OID 30980)
-- Name: mfa_amr_claims mfa_amr_claims_session_id_authentication_method_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.mfa_amr_claims
    ADD CONSTRAINT mfa_amr_claims_session_id_authentication_method_pkey UNIQUE (session_id, authentication_method);


--
-- TOC entry 5269 (class 2606 OID 30982)
-- Name: mfa_challenges mfa_challenges_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.mfa_challenges
    ADD CONSTRAINT mfa_challenges_pkey PRIMARY KEY (id);


--
-- TOC entry 5272 (class 2606 OID 30984)
-- Name: mfa_factors mfa_factors_last_challenged_at_key; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.mfa_factors
    ADD CONSTRAINT mfa_factors_last_challenged_at_key UNIQUE (last_challenged_at);


--
-- TOC entry 5274 (class 2606 OID 30986)
-- Name: mfa_factors mfa_factors_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.mfa_factors
    ADD CONSTRAINT mfa_factors_pkey PRIMARY KEY (id);


--
-- TOC entry 5419 (class 2606 OID 393242)
-- Name: oauth_authorizations oauth_authorizations_authorization_code_key; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.oauth_authorizations
    ADD CONSTRAINT oauth_authorizations_authorization_code_key UNIQUE (authorization_code);


--
-- TOC entry 5421 (class 2606 OID 393240)
-- Name: oauth_authorizations oauth_authorizations_authorization_id_key; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.oauth_authorizations
    ADD CONSTRAINT oauth_authorizations_authorization_id_key UNIQUE (authorization_id);


--
-- TOC entry 5423 (class 2606 OID 393238)
-- Name: oauth_authorizations oauth_authorizations_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.oauth_authorizations
    ADD CONSTRAINT oauth_authorizations_pkey PRIMARY KEY (id);


--
-- TOC entry 5493 (class 2606 OID 457866)
-- Name: oauth_client_states oauth_client_states_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.oauth_client_states
    ADD CONSTRAINT oauth_client_states_pkey PRIMARY KEY (id);


--
-- TOC entry 5400 (class 2606 OID 338536)
-- Name: oauth_clients oauth_clients_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.oauth_clients
    ADD CONSTRAINT oauth_clients_pkey PRIMARY KEY (id);


--
-- TOC entry 5427 (class 2606 OID 393264)
-- Name: oauth_consents oauth_consents_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.oauth_consents
    ADD CONSTRAINT oauth_consents_pkey PRIMARY KEY (id);


--
-- TOC entry 5429 (class 2606 OID 393266)
-- Name: oauth_consents oauth_consents_user_client_unique; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.oauth_consents
    ADD CONSTRAINT oauth_consents_user_client_unique UNIQUE (user_id, client_id);


--
-- TOC entry 5279 (class 2606 OID 30988)
-- Name: one_time_tokens one_time_tokens_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.one_time_tokens
    ADD CONSTRAINT one_time_tokens_pkey PRIMARY KEY (id);


--
-- TOC entry 5287 (class 2606 OID 30990)
-- Name: refresh_tokens refresh_tokens_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.refresh_tokens
    ADD CONSTRAINT refresh_tokens_pkey PRIMARY KEY (id);


--
-- TOC entry 5290 (class 2606 OID 30992)
-- Name: refresh_tokens refresh_tokens_token_unique; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.refresh_tokens
    ADD CONSTRAINT refresh_tokens_token_unique UNIQUE (token);


--
-- TOC entry 5293 (class 2606 OID 30994)
-- Name: saml_providers saml_providers_entity_id_key; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.saml_providers
    ADD CONSTRAINT saml_providers_entity_id_key UNIQUE (entity_id);


--
-- TOC entry 5295 (class 2606 OID 30996)
-- Name: saml_providers saml_providers_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.saml_providers
    ADD CONSTRAINT saml_providers_pkey PRIMARY KEY (id);


--
-- TOC entry 5300 (class 2606 OID 30998)
-- Name: saml_relay_states saml_relay_states_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.saml_relay_states
    ADD CONSTRAINT saml_relay_states_pkey PRIMARY KEY (id);


--
-- TOC entry 5303 (class 2606 OID 31000)
-- Name: schema_migrations schema_migrations_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.schema_migrations
    ADD CONSTRAINT schema_migrations_pkey PRIMARY KEY (version);


--
-- TOC entry 5307 (class 2606 OID 31002)
-- Name: sessions sessions_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.sessions
    ADD CONSTRAINT sessions_pkey PRIMARY KEY (id);


--
-- TOC entry 5312 (class 2606 OID 31004)
-- Name: sso_domains sso_domains_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.sso_domains
    ADD CONSTRAINT sso_domains_pkey PRIMARY KEY (id);


--
-- TOC entry 5315 (class 2606 OID 31006)
-- Name: sso_providers sso_providers_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.sso_providers
    ADD CONSTRAINT sso_providers_pkey PRIMARY KEY (id);


--
-- TOC entry 5328 (class 2606 OID 31008)
-- Name: users users_phone_key; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.users
    ADD CONSTRAINT users_phone_key UNIQUE (phone);


--
-- TOC entry 5330 (class 2606 OID 31010)
-- Name: users users_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.users
    ADD CONSTRAINT users_pkey PRIMARY KEY (id);


--
-- TOC entry 5525 (class 2606 OID 511791)
-- Name: admin_audit_logs admin_audit_logs_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.admin_audit_logs
    ADD CONSTRAINT admin_audit_logs_pkey PRIMARY KEY (id);


--
-- TOC entry 5549 (class 2606 OID 511901)
-- Name: admin_messages admin_messages_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.admin_messages
    ADD CONSTRAINT admin_messages_pkey PRIMARY KEY (id);


--
-- TOC entry 5332 (class 2606 OID 31012)
-- Name: bids bids_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.bids
    ADD CONSTRAINT bids_pkey PRIMARY KEY (id);


--
-- TOC entry 5481 (class 2606 OID 444954)
-- Name: commission_ledger commission_ledger_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.commission_ledger
    ADD CONSTRAINT commission_ledger_pkey PRIMARY KEY (id);


--
-- TOC entry 5555 (class 2606 OID 522090)
-- Name: device_tokens device_tokens_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.device_tokens
    ADD CONSTRAINT device_tokens_pkey PRIMARY KEY (id);


--
-- TOC entry 5545 (class 2606 OID 511877)
-- Name: dispute_evidence dispute_evidence_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.dispute_evidence
    ADD CONSTRAINT dispute_evidence_pkey PRIMARY KEY (id);


--
-- TOC entry 5536 (class 2606 OID 511835)
-- Name: disputes disputes_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.disputes
    ADD CONSTRAINT disputes_pkey PRIMARY KEY (id);


--
-- TOC entry 5531 (class 2606 OID 511810)
-- Name: driver_approval_history driver_approval_history_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.driver_approval_history
    ADD CONSTRAINT driver_approval_history_pkey PRIMARY KEY (id);


--
-- TOC entry 5460 (class 2606 OID 444843)
-- Name: driver_bank_accounts driver_bank_accounts_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.driver_bank_accounts
    ADD CONSTRAINT driver_bank_accounts_pkey PRIMARY KEY (id);


--
-- TOC entry 5384 (class 2606 OID 146972)
-- Name: driver_docs driver_docs_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.driver_docs
    ADD CONSTRAINT driver_docs_pkey PRIMARY KEY (id);


--
-- TOC entry 5465 (class 2606 OID 444868)
-- Name: driver_payouts driver_payouts_paystack_transfer_reference_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.driver_payouts
    ADD CONSTRAINT driver_payouts_paystack_transfer_reference_key UNIQUE (paystack_transfer_reference);


--
-- TOC entry 5467 (class 2606 OID 444866)
-- Name: driver_payouts driver_payouts_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.driver_payouts
    ADD CONSTRAINT driver_payouts_pkey PRIMARY KEY (id);


--
-- TOC entry 5501 (class 2606 OID 479837)
-- Name: driver_tracking_sessions driver_tracking_sessions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.driver_tracking_sessions
    ADD CONSTRAINT driver_tracking_sessions_pkey PRIMARY KEY (id);


--
-- TOC entry 5507 (class 2606 OID 479853)
-- Name: driver_tracking_shipments driver_tracking_shipments_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.driver_tracking_shipments
    ADD CONSTRAINT driver_tracking_shipments_pkey PRIMARY KEY (id);


--
-- TOC entry 5453 (class 2606 OID 444803)
-- Name: escrow_holdings escrow_holdings_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.escrow_holdings
    ADD CONSTRAINT escrow_holdings_pkey PRIMARY KEY (id);


--
-- TOC entry 5495 (class 2606 OID 479771)
-- Name: flagged_documents flagged_documents_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.flagged_documents
    ADD CONSTRAINT flagged_documents_pkey PRIMARY KEY (id);


--
-- TOC entry 5337 (class 2606 OID 31014)
-- Name: freight_items freight_items_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.freight_items
    ADD CONSTRAINT freight_items_pkey PRIMARY KEY (id);


--
-- TOC entry 5440 (class 2606 OID 433367)
-- Name: freight_moving freight_moving_freight_post_id_unique; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.freight_moving
    ADD CONSTRAINT freight_moving_freight_post_id_unique UNIQUE (freight_post_id);


--
-- TOC entry 5442 (class 2606 OID 433365)
-- Name: freight_moving freight_moving_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.freight_moving
    ADD CONSTRAINT freight_moving_pkey PRIMARY KEY (id);


--
-- TOC entry 5340 (class 2606 OID 31016)
-- Name: freight_posts freight_posts_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.freight_posts
    ADD CONSTRAINT freight_posts_pkey PRIMARY KEY (id);


--
-- TOC entry 5445 (class 2606 OID 433388)
-- Name: freight_rubble freight_rubble_freight_post_id_unique; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.freight_rubble
    ADD CONSTRAINT freight_rubble_freight_post_id_unique UNIQUE (freight_post_id);


--
-- TOC entry 5447 (class 2606 OID 433386)
-- Name: freight_rubble freight_rubble_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.freight_rubble
    ADD CONSTRAINT freight_rubble_pkey PRIMARY KEY (id);


--
-- TOC entry 5450 (class 2606 OID 433407)
-- Name: freight_vehicles freight_vehicles_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.freight_vehicles
    ADD CONSTRAINT freight_vehicles_pkey PRIMARY KEY (id);


--
-- TOC entry 5390 (class 2606 OID 270561)
-- Name: notification_type_preferences notification_type_preferences_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.notification_type_preferences
    ADD CONSTRAINT notification_type_preferences_pkey PRIMARY KEY (id);


--
-- TOC entry 5353 (class 2606 OID 31018)
-- Name: notifications notifications_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.notifications
    ADD CONSTRAINT notifications_pkey PRIMARY KEY (id);


--
-- TOC entry 5479 (class 2606 OID 444913)
-- Name: payment_refunds payment_refunds_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payment_refunds
    ADD CONSTRAINT payment_refunds_pkey PRIMARY KEY (id);


--
-- TOC entry 5360 (class 2606 OID 444785)
-- Name: payments payments_paystack_reference_unique; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payments
    ADD CONSTRAINT payments_paystack_reference_unique UNIQUE (paystack_reference);


--
-- TOC entry 5362 (class 2606 OID 31020)
-- Name: payments payments_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payments
    ADD CONSTRAINT payments_pkey PRIMARY KEY (id);


--
-- TOC entry 5490 (class 2606 OID 444993)
-- Name: paystack_webhook_events paystack_webhook_events_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.paystack_webhook_events
    ADD CONSTRAINT paystack_webhook_events_pkey PRIMARY KEY (id);


--
-- TOC entry 5364 (class 2606 OID 31022)
-- Name: ratings ratings_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ratings
    ADD CONSTRAINT ratings_pkey PRIMARY KEY (id);


--
-- TOC entry 5436 (class 2606 OID 423778)
-- Name: route_cache route_cache_cache_key_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.route_cache
    ADD CONSTRAINT route_cache_cache_key_key UNIQUE (cache_key);


--
-- TOC entry 5438 (class 2606 OID 423776)
-- Name: route_cache route_cache_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.route_cache
    ADD CONSTRAINT route_cache_pkey PRIMARY KEY (id);


--
-- TOC entry 5516 (class 2606 OID 486865)
-- Name: shipment_tracking_metrics shipment_tracking_metrics_driver_tracking_session_id_shipme_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.shipment_tracking_metrics
    ADD CONSTRAINT shipment_tracking_metrics_driver_tracking_session_id_shipme_key UNIQUE (driver_tracking_session_id, shipment_id);


--
-- TOC entry 5518 (class 2606 OID 486863)
-- Name: shipment_tracking_metrics shipment_tracking_metrics_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.shipment_tracking_metrics
    ADD CONSTRAINT shipment_tracking_metrics_pkey PRIMARY KEY (id);


--
-- TOC entry 5397 (class 2606 OID 270655)
-- Name: sms_billing sms_billing_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sms_billing
    ADD CONSTRAINT sms_billing_pkey PRIMARY KEY (id);


--
-- TOC entry 5523 (class 2606 OID 489255)
-- Name: tracking_health_events tracking_health_events_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.tracking_health_events
    ADD CONSTRAINT tracking_health_events_pkey PRIMARY KEY (id);


--
-- TOC entry 5416 (class 2606 OID 361947)
-- Name: tracking_points tracking_points_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.tracking_points
    ADD CONSTRAINT tracking_points_pkey PRIMARY KEY (id);


--
-- TOC entry 5559 (class 2606 OID 522092)
-- Name: device_tokens unique_user_device_token; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.device_tokens
    ADD CONSTRAINT unique_user_device_token UNIQUE (user_id, fcm_token);


--
-- TOC entry 5392 (class 2606 OID 270563)
-- Name: notification_type_preferences unique_user_notification_type; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.notification_type_preferences
    ADD CONSTRAINT unique_user_notification_type UNIQUE (user_id, notification_type);


--
-- TOC entry 5373 (class 2606 OID 31024)
-- Name: users users_email_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.users
    ADD CONSTRAINT users_email_key UNIQUE (email);


--
-- TOC entry 5375 (class 2606 OID 31026)
-- Name: users users_phone_number_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.users
    ADD CONSTRAINT users_phone_number_key UNIQUE (phone_number);


--
-- TOC entry 5377 (class 2606 OID 31028)
-- Name: users users_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.users
    ADD CONSTRAINT users_pkey PRIMARY KEY (id);


--
-- TOC entry 5382 (class 2606 OID 31030)
-- Name: vehicles vehicles_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.vehicles
    ADD CONSTRAINT vehicles_pkey PRIMARY KEY (id);


--
-- TOC entry 5249 (class 1259 OID 31049)
-- Name: audit_logs_instance_id_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX audit_logs_instance_id_idx ON auth.audit_log_entries USING btree (instance_id);


--
-- TOC entry 5318 (class 1259 OID 31050)
-- Name: confirmation_token_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE UNIQUE INDEX confirmation_token_idx ON auth.users USING btree (confirmation_token) WHERE ((confirmation_token)::text !~ '^[0-9 ]*$'::text);


--
-- TOC entry 5319 (class 1259 OID 31051)
-- Name: email_change_token_current_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE UNIQUE INDEX email_change_token_current_idx ON auth.users USING btree (email_change_token_current) WHERE ((email_change_token_current)::text !~ '^[0-9 ]*$'::text);


--
-- TOC entry 5320 (class 1259 OID 31052)
-- Name: email_change_token_new_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE UNIQUE INDEX email_change_token_new_idx ON auth.users USING btree (email_change_token_new) WHERE ((email_change_token_new)::text !~ '^[0-9 ]*$'::text);


--
-- TOC entry 5270 (class 1259 OID 31053)
-- Name: factor_id_created_at_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX factor_id_created_at_idx ON auth.mfa_factors USING btree (user_id, created_at);


--
-- TOC entry 5250 (class 1259 OID 31054)
-- Name: flow_state_created_at_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX flow_state_created_at_idx ON auth.flow_state USING btree (created_at DESC);


--
-- TOC entry 5255 (class 1259 OID 31055)
-- Name: identities_email_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX identities_email_idx ON auth.identities USING btree (email text_pattern_ops);


--
-- TOC entry 6118 (class 0 OID 0)
-- Dependencies: 5255
-- Name: INDEX identities_email_idx; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON INDEX auth.identities_email_idx IS 'Auth: Ensures indexed queries on the email column';


--
-- TOC entry 5260 (class 1259 OID 31056)
-- Name: identities_user_id_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX identities_user_id_idx ON auth.identities USING btree (user_id);


--
-- TOC entry 5253 (class 1259 OID 31057)
-- Name: idx_auth_code; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX idx_auth_code ON auth.flow_state USING btree (auth_code);


--
-- TOC entry 5491 (class 1259 OID 457867)
-- Name: idx_oauth_client_states_created_at; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX idx_oauth_client_states_created_at ON auth.oauth_client_states USING btree (created_at);


--
-- TOC entry 5254 (class 1259 OID 31058)
-- Name: idx_user_id_auth_method; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX idx_user_id_auth_method ON auth.flow_state USING btree (user_id, authentication_method);


--
-- TOC entry 5267 (class 1259 OID 31059)
-- Name: mfa_challenge_created_at_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX mfa_challenge_created_at_idx ON auth.mfa_challenges USING btree (created_at DESC);


--
-- TOC entry 5275 (class 1259 OID 31060)
-- Name: mfa_factors_user_friendly_name_unique; Type: INDEX; Schema: auth; Owner: -
--

CREATE UNIQUE INDEX mfa_factors_user_friendly_name_unique ON auth.mfa_factors USING btree (friendly_name, user_id) WHERE (TRIM(BOTH FROM friendly_name) <> ''::text);


--
-- TOC entry 5276 (class 1259 OID 31061)
-- Name: mfa_factors_user_id_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX mfa_factors_user_id_idx ON auth.mfa_factors USING btree (user_id);


--
-- TOC entry 5417 (class 1259 OID 393253)
-- Name: oauth_auth_pending_exp_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX oauth_auth_pending_exp_idx ON auth.oauth_authorizations USING btree (expires_at) WHERE (status = 'pending'::auth.oauth_authorization_status);


--
-- TOC entry 5398 (class 1259 OID 338540)
-- Name: oauth_clients_deleted_at_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX oauth_clients_deleted_at_idx ON auth.oauth_clients USING btree (deleted_at);


--
-- TOC entry 5424 (class 1259 OID 393279)
-- Name: oauth_consents_active_client_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX oauth_consents_active_client_idx ON auth.oauth_consents USING btree (client_id) WHERE (revoked_at IS NULL);


--
-- TOC entry 5425 (class 1259 OID 393277)
-- Name: oauth_consents_active_user_client_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX oauth_consents_active_user_client_idx ON auth.oauth_consents USING btree (user_id, client_id) WHERE (revoked_at IS NULL);


--
-- TOC entry 5430 (class 1259 OID 393278)
-- Name: oauth_consents_user_order_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX oauth_consents_user_order_idx ON auth.oauth_consents USING btree (user_id, granted_at DESC);


--
-- TOC entry 5280 (class 1259 OID 31062)
-- Name: one_time_tokens_relates_to_hash_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX one_time_tokens_relates_to_hash_idx ON auth.one_time_tokens USING hash (relates_to);


--
-- TOC entry 5281 (class 1259 OID 31063)
-- Name: one_time_tokens_token_hash_hash_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX one_time_tokens_token_hash_hash_idx ON auth.one_time_tokens USING hash (token_hash);


--
-- TOC entry 5282 (class 1259 OID 31064)
-- Name: one_time_tokens_user_id_token_type_key; Type: INDEX; Schema: auth; Owner: -
--

CREATE UNIQUE INDEX one_time_tokens_user_id_token_type_key ON auth.one_time_tokens USING btree (user_id, token_type);


--
-- TOC entry 5321 (class 1259 OID 31065)
-- Name: reauthentication_token_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE UNIQUE INDEX reauthentication_token_idx ON auth.users USING btree (reauthentication_token) WHERE ((reauthentication_token)::text !~ '^[0-9 ]*$'::text);


--
-- TOC entry 5322 (class 1259 OID 31066)
-- Name: recovery_token_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE UNIQUE INDEX recovery_token_idx ON auth.users USING btree (recovery_token) WHERE ((recovery_token)::text !~ '^[0-9 ]*$'::text);


--
-- TOC entry 5283 (class 1259 OID 31067)
-- Name: refresh_tokens_instance_id_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX refresh_tokens_instance_id_idx ON auth.refresh_tokens USING btree (instance_id);


--
-- TOC entry 5284 (class 1259 OID 31068)
-- Name: refresh_tokens_instance_id_user_id_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX refresh_tokens_instance_id_user_id_idx ON auth.refresh_tokens USING btree (instance_id, user_id);


--
-- TOC entry 5285 (class 1259 OID 31069)
-- Name: refresh_tokens_parent_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX refresh_tokens_parent_idx ON auth.refresh_tokens USING btree (parent);


--
-- TOC entry 5288 (class 1259 OID 31070)
-- Name: refresh_tokens_session_id_revoked_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX refresh_tokens_session_id_revoked_idx ON auth.refresh_tokens USING btree (session_id, revoked);


--
-- TOC entry 5291 (class 1259 OID 31071)
-- Name: refresh_tokens_updated_at_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX refresh_tokens_updated_at_idx ON auth.refresh_tokens USING btree (updated_at DESC);


--
-- TOC entry 5296 (class 1259 OID 31072)
-- Name: saml_providers_sso_provider_id_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX saml_providers_sso_provider_id_idx ON auth.saml_providers USING btree (sso_provider_id);


--
-- TOC entry 5297 (class 1259 OID 31073)
-- Name: saml_relay_states_created_at_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX saml_relay_states_created_at_idx ON auth.saml_relay_states USING btree (created_at DESC);


--
-- TOC entry 5298 (class 1259 OID 31074)
-- Name: saml_relay_states_for_email_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX saml_relay_states_for_email_idx ON auth.saml_relay_states USING btree (for_email);


--
-- TOC entry 5301 (class 1259 OID 31075)
-- Name: saml_relay_states_sso_provider_id_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX saml_relay_states_sso_provider_id_idx ON auth.saml_relay_states USING btree (sso_provider_id);


--
-- TOC entry 5304 (class 1259 OID 31076)
-- Name: sessions_not_after_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX sessions_not_after_idx ON auth.sessions USING btree (not_after DESC);


--
-- TOC entry 5305 (class 1259 OID 393291)
-- Name: sessions_oauth_client_id_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX sessions_oauth_client_id_idx ON auth.sessions USING btree (oauth_client_id);


--
-- TOC entry 5308 (class 1259 OID 31077)
-- Name: sessions_user_id_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX sessions_user_id_idx ON auth.sessions USING btree (user_id);


--
-- TOC entry 5310 (class 1259 OID 31078)
-- Name: sso_domains_domain_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE UNIQUE INDEX sso_domains_domain_idx ON auth.sso_domains USING btree (lower(domain));


--
-- TOC entry 5313 (class 1259 OID 31079)
-- Name: sso_domains_sso_provider_id_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX sso_domains_sso_provider_id_idx ON auth.sso_domains USING btree (sso_provider_id);


--
-- TOC entry 5316 (class 1259 OID 31080)
-- Name: sso_providers_resource_id_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE UNIQUE INDEX sso_providers_resource_id_idx ON auth.sso_providers USING btree (lower(resource_id));


--
-- TOC entry 5317 (class 1259 OID 321829)
-- Name: sso_providers_resource_id_pattern_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX sso_providers_resource_id_pattern_idx ON auth.sso_providers USING btree (resource_id text_pattern_ops);


--
-- TOC entry 5277 (class 1259 OID 31081)
-- Name: unique_phone_factor_per_user; Type: INDEX; Schema: auth; Owner: -
--

CREATE UNIQUE INDEX unique_phone_factor_per_user ON auth.mfa_factors USING btree (user_id, phone);


--
-- TOC entry 5309 (class 1259 OID 31082)
-- Name: user_id_created_at_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX user_id_created_at_idx ON auth.sessions USING btree (user_id, created_at);


--
-- TOC entry 5323 (class 1259 OID 31083)
-- Name: users_email_partial_key; Type: INDEX; Schema: auth; Owner: -
--

CREATE UNIQUE INDEX users_email_partial_key ON auth.users USING btree (email) WHERE (is_sso_user = false);


--
-- TOC entry 6119 (class 0 OID 0)
-- Dependencies: 5323
-- Name: INDEX users_email_partial_key; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON INDEX auth.users_email_partial_key IS 'Auth: A partial unique index that applies only when is_sso_user is false';


--
-- TOC entry 5324 (class 1259 OID 31084)
-- Name: users_instance_id_email_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX users_instance_id_email_idx ON auth.users USING btree (instance_id, lower((email)::text));


--
-- TOC entry 5325 (class 1259 OID 31085)
-- Name: users_instance_id_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX users_instance_id_idx ON auth.users USING btree (instance_id);


--
-- TOC entry 5326 (class 1259 OID 31086)
-- Name: users_is_anonymous_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX users_is_anonymous_idx ON auth.users USING btree (is_anonymous);


--
-- TOC entry 5526 (class 1259 OID 511800)
-- Name: idx_admin_audit_logs_action; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_admin_audit_logs_action ON public.admin_audit_logs USING btree (action);


--
-- TOC entry 5527 (class 1259 OID 511797)
-- Name: idx_admin_audit_logs_admin_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_admin_audit_logs_admin_id ON public.admin_audit_logs USING btree (admin_id);


--
-- TOC entry 5528 (class 1259 OID 511799)
-- Name: idx_admin_audit_logs_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_admin_audit_logs_created_at ON public.admin_audit_logs USING btree (created_at DESC);


--
-- TOC entry 5529 (class 1259 OID 511798)
-- Name: idx_admin_audit_logs_target; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_admin_audit_logs_target ON public.admin_audit_logs USING btree (target_type, target_id);


--
-- TOC entry 5550 (class 1259 OID 511913)
-- Name: idx_admin_messages_recipient_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_admin_messages_recipient_id ON public.admin_messages USING btree (recipient_id);


--
-- TOC entry 5551 (class 1259 OID 511914)
-- Name: idx_admin_messages_sent_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_admin_messages_sent_at ON public.admin_messages USING btree (sent_at DESC);


--
-- TOC entry 5552 (class 1259 OID 511912)
-- Name: idx_admin_messages_sent_by; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_admin_messages_sent_by ON public.admin_messages USING btree (sent_by);


--
-- TOC entry 5553 (class 1259 OID 511915)
-- Name: idx_admin_messages_unread; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_admin_messages_unread ON public.admin_messages USING btree (recipient_id, read_at) WHERE (read_at IS NULL);


--
-- TOC entry 5333 (class 1259 OID 158844)
-- Name: idx_bids_freight_post_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_bids_freight_post_id ON public.bids USING btree (freight_post_id);


--
-- TOC entry 5334 (class 1259 OID 248329)
-- Name: idx_bids_vehicle_freight_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_bids_vehicle_freight_status ON public.bids USING btree (vehicle_id, freight_post_id, status);


--
-- TOC entry 5335 (class 1259 OID 158720)
-- Name: idx_bids_vehicle_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_bids_vehicle_id ON public.bids USING btree (vehicle_id);


--
-- TOC entry 5482 (class 1259 OID 444982)
-- Name: idx_commission_freight_post_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_commission_freight_post_id ON public.commission_ledger USING btree (freight_post_id);


--
-- TOC entry 5483 (class 1259 OID 444981)
-- Name: idx_commission_transaction_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_commission_transaction_date ON public.commission_ledger USING btree (transaction_date);


--
-- TOC entry 5484 (class 1259 OID 444980)
-- Name: idx_commission_transaction_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_commission_transaction_type ON public.commission_ledger USING btree (transaction_type);


--
-- TOC entry 5556 (class 1259 OID 522099)
-- Name: idx_device_tokens_token; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_device_tokens_token ON public.device_tokens USING btree (fcm_token);


--
-- TOC entry 5557 (class 1259 OID 522098)
-- Name: idx_device_tokens_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_device_tokens_user ON public.device_tokens USING btree (user_id);


--
-- TOC entry 5546 (class 1259 OID 511888)
-- Name: idx_dispute_evidence_dispute_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_dispute_evidence_dispute_id ON public.dispute_evidence USING btree (dispute_id);


--
-- TOC entry 5547 (class 1259 OID 511889)
-- Name: idx_dispute_evidence_submitted_by; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_dispute_evidence_submitted_by ON public.dispute_evidence USING btree (submitted_by);


--
-- TOC entry 5537 (class 1259 OID 511866)
-- Name: idx_disputes_admin_assigned; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_disputes_admin_assigned ON public.disputes USING btree (admin_assigned);


--
-- TOC entry 5538 (class 1259 OID 511867)
-- Name: idx_disputes_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_disputes_created_at ON public.disputes USING btree (created_at DESC);


--
-- TOC entry 5539 (class 1259 OID 511863)
-- Name: idx_disputes_freight_post_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_disputes_freight_post_id ON public.disputes USING btree (freight_post_id);


--
-- TOC entry 5540 (class 1259 OID 511862)
-- Name: idx_disputes_priority; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_disputes_priority ON public.disputes USING btree (priority);


--
-- TOC entry 5541 (class 1259 OID 511865)
-- Name: idx_disputes_raised_against; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_disputes_raised_against ON public.disputes USING btree (raised_against);


--
-- TOC entry 5542 (class 1259 OID 511864)
-- Name: idx_disputes_raised_by; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_disputes_raised_by ON public.disputes USING btree (raised_by);


--
-- TOC entry 5543 (class 1259 OID 511861)
-- Name: idx_disputes_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_disputes_status ON public.disputes USING btree (status);


--
-- TOC entry 5532 (class 1259 OID 511822)
-- Name: idx_driver_approval_history_admin_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_driver_approval_history_admin_id ON public.driver_approval_history USING btree (admin_id);


--
-- TOC entry 5533 (class 1259 OID 511823)
-- Name: idx_driver_approval_history_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_driver_approval_history_created_at ON public.driver_approval_history USING btree (created_at DESC);


--
-- TOC entry 5534 (class 1259 OID 511821)
-- Name: idx_driver_approval_history_driver_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_driver_approval_history_driver_id ON public.driver_approval_history USING btree (driver_id);


--
-- TOC entry 5461 (class 1259 OID 444849)
-- Name: idx_driver_bank_driver_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_driver_bank_driver_id ON public.driver_bank_accounts USING btree (driver_id);


--
-- TOC entry 5462 (class 1259 OID 444851)
-- Name: idx_driver_bank_primary; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX idx_driver_bank_primary ON public.driver_bank_accounts USING btree (driver_id) WHERE ((is_primary = true) AND (is_active = true));


--
-- TOC entry 5463 (class 1259 OID 444850)
-- Name: idx_driver_bank_recipient_code; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_driver_bank_recipient_code ON public.driver_bank_accounts USING btree (paystack_recipient_code) WHERE (paystack_recipient_code IS NOT NULL);


--
-- TOC entry 5385 (class 1259 OID 511768)
-- Name: idx_driver_docs_driver_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_driver_docs_driver_id ON public.driver_docs USING btree (driver_id);


--
-- TOC entry 5386 (class 1259 OID 511767)
-- Name: idx_driver_docs_verification_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_driver_docs_verification_status ON public.driver_docs USING btree (verification_status);


--
-- TOC entry 5502 (class 1259 OID 479843)
-- Name: idx_driver_tracking_driver_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_driver_tracking_driver_id ON public.driver_tracking_sessions USING btree (driver_id);


--
-- TOC entry 5503 (class 1259 OID 479845)
-- Name: idx_driver_tracking_started_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_driver_tracking_started_at ON public.driver_tracking_sessions USING btree (started_at DESC);


--
-- TOC entry 5504 (class 1259 OID 479844)
-- Name: idx_driver_tracking_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_driver_tracking_status ON public.driver_tracking_sessions USING btree (status);


--
-- TOC entry 5454 (class 1259 OID 444828)
-- Name: idx_escrow_bid_unique; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX idx_escrow_bid_unique ON public.escrow_holdings USING btree (bid_id);


--
-- TOC entry 5455 (class 1259 OID 444825)
-- Name: idx_escrow_freight_post_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_escrow_freight_post_id ON public.escrow_holdings USING btree (freight_post_id);


--
-- TOC entry 5456 (class 1259 OID 444824)
-- Name: idx_escrow_payment_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_escrow_payment_id ON public.escrow_holdings USING btree (payment_id);


--
-- TOC entry 5457 (class 1259 OID 444826)
-- Name: idx_escrow_shipper_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_escrow_shipper_id ON public.escrow_holdings USING btree (shipper_id);


--
-- TOC entry 5458 (class 1259 OID 444827)
-- Name: idx_escrow_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_escrow_status ON public.escrow_holdings USING btree (status);


--
-- TOC entry 5496 (class 1259 OID 479797)
-- Name: idx_flagged_documents_document_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_flagged_documents_document_id ON public.flagged_documents USING btree (document_id);


--
-- TOC entry 5497 (class 1259 OID 479798)
-- Name: idx_flagged_documents_driver_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_flagged_documents_driver_id ON public.flagged_documents USING btree (driver_id);


--
-- TOC entry 5498 (class 1259 OID 479799)
-- Name: idx_flagged_documents_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_flagged_documents_status ON public.flagged_documents USING btree (status);


--
-- TOC entry 5499 (class 1259 OID 479800)
-- Name: idx_flagged_documents_unique_flag; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX idx_flagged_documents_unique_flag ON public.flagged_documents USING btree (document_id, flagged_by_user_id) WHERE (status = 'pending'::text);


--
-- TOC entry 5338 (class 1259 OID 31088)
-- Name: idx_freight_items_post; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_freight_items_post ON public.freight_items USING btree (freight_post_id);


--
-- TOC entry 5443 (class 1259 OID 433373)
-- Name: idx_freight_moving_freight_post_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_freight_moving_freight_post_id ON public.freight_moving USING btree (freight_post_id);


--
-- TOC entry 5341 (class 1259 OID 69488)
-- Name: idx_freight_posts_currency; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_freight_posts_currency ON public.freight_posts USING btree (currency);


--
-- TOC entry 5342 (class 1259 OID 31089)
-- Name: idx_freight_posts_dropoff_location; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_freight_posts_dropoff_location ON public.freight_posts USING gist (dropoff_location);


--
-- TOC entry 5343 (class 1259 OID 373639)
-- Name: idx_freight_posts_dropoff_location_gist; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_freight_posts_dropoff_location_gist ON public.freight_posts USING gist (dropoff_location);


--
-- TOC entry 5344 (class 1259 OID 433352)
-- Name: idx_freight_posts_freight_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_freight_posts_freight_type ON public.freight_posts USING btree (freight_type);


--
-- TOC entry 5345 (class 1259 OID 31090)
-- Name: idx_freight_posts_pickup_location; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_freight_posts_pickup_location ON public.freight_posts USING gist (pickup_location);


--
-- TOC entry 5346 (class 1259 OID 373638)
-- Name: idx_freight_posts_pickup_location_gist; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_freight_posts_pickup_location_gist ON public.freight_posts USING gist (pickup_location);


--
-- TOC entry 5347 (class 1259 OID 248328)
-- Name: idx_freight_posts_shipper_status_archived; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_freight_posts_shipper_status_archived ON public.freight_posts USING btree (shipper_id, status, archived) WHERE (archived = false);


--
-- TOC entry 5348 (class 1259 OID 248048)
-- Name: idx_freight_posts_status_archived; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_freight_posts_status_archived ON public.freight_posts USING btree (status, archived) WHERE ((status = 'Bidding'::public.freight_status) AND (archived = false));


--
-- TOC entry 5448 (class 1259 OID 433394)
-- Name: idx_freight_rubble_freight_post_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_freight_rubble_freight_post_id ON public.freight_rubble USING btree (freight_post_id);


--
-- TOC entry 5451 (class 1259 OID 433413)
-- Name: idx_freight_vehicles_freight_post_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_freight_vehicles_freight_post_id ON public.freight_vehicles USING btree (freight_post_id);


--
-- TOC entry 5387 (class 1259 OID 270570)
-- Name: idx_notification_preferences_enabled; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_notification_preferences_enabled ON public.notification_type_preferences USING btree (user_id, push_enabled, sms_enabled);


--
-- TOC entry 5388 (class 1259 OID 270569)
-- Name: idx_notification_preferences_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_notification_preferences_user ON public.notification_type_preferences USING btree (user_id);


--
-- TOC entry 5349 (class 1259 OID 270711)
-- Name: idx_notifications_delivery; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_notifications_delivery ON public.notifications USING btree (user_id, delivery_method);


--
-- TOC entry 5350 (class 1259 OID 31092)
-- Name: idx_notifications_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_notifications_user ON public.notifications USING btree (user_id);


--
-- TOC entry 5351 (class 1259 OID 259020)
-- Name: idx_notifications_user_type_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_notifications_user_type_created ON public.notifications USING btree (user_id, type, created_at DESC);


--
-- TOC entry 5354 (class 1259 OID 158698)
-- Name: idx_payments_bid_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payments_bid_id ON public.payments USING btree (bid_id);


--
-- TOC entry 5355 (class 1259 OID 444786)
-- Name: idx_payments_paystack_reference; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payments_paystack_reference ON public.payments USING btree (paystack_reference) WHERE (paystack_reference IS NOT NULL);


--
-- TOC entry 5356 (class 1259 OID 444787)
-- Name: idx_payments_shipper_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payments_shipper_id ON public.payments USING btree (shipper_id);


--
-- TOC entry 5357 (class 1259 OID 444788)
-- Name: idx_payments_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payments_status ON public.payments USING btree (status);


--
-- TOC entry 5468 (class 1259 OID 444899)
-- Name: idx_payout_bid_unique; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX idx_payout_bid_unique ON public.driver_payouts USING btree (bid_id);


--
-- TOC entry 5469 (class 1259 OID 444895)
-- Name: idx_payout_driver_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payout_driver_id ON public.driver_payouts USING btree (driver_id);


--
-- TOC entry 5470 (class 1259 OID 444894)
-- Name: idx_payout_escrow_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payout_escrow_id ON public.driver_payouts USING btree (escrow_id);


--
-- TOC entry 5471 (class 1259 OID 444897)
-- Name: idx_payout_freight_post_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payout_freight_post_id ON public.driver_payouts USING btree (freight_post_id);


--
-- TOC entry 5472 (class 1259 OID 444896)
-- Name: idx_payout_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payout_status ON public.driver_payouts USING btree (status);


--
-- TOC entry 5473 (class 1259 OID 444898)
-- Name: idx_payout_transfer_reference; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payout_transfer_reference ON public.driver_payouts USING btree (paystack_transfer_reference) WHERE (paystack_transfer_reference IS NOT NULL);


--
-- TOC entry 5474 (class 1259 OID 444940)
-- Name: idx_refund_escrow_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_refund_escrow_id ON public.payment_refunds USING btree (escrow_id);


--
-- TOC entry 5475 (class 1259 OID 444939)
-- Name: idx_refund_payment_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_refund_payment_id ON public.payment_refunds USING btree (payment_id);


--
-- TOC entry 5476 (class 1259 OID 444941)
-- Name: idx_refund_shipper_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_refund_shipper_id ON public.payment_refunds USING btree (shipper_id);


--
-- TOC entry 5477 (class 1259 OID 444942)
-- Name: idx_refund_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_refund_status ON public.payment_refunds USING btree (status);


--
-- TOC entry 5431 (class 1259 OID 423787)
-- Name: idx_route_cache_accessed; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_route_cache_accessed ON public.route_cache USING btree (last_accessed_at);


--
-- TOC entry 5432 (class 1259 OID 423785)
-- Name: idx_route_cache_coords; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_route_cache_coords ON public.route_cache USING btree (origin_lat, origin_lng, destination_lat, destination_lng);


--
-- TOC entry 5433 (class 1259 OID 423786)
-- Name: idx_route_cache_expires; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_route_cache_expires ON public.route_cache USING btree (expires_at);


--
-- TOC entry 5434 (class 1259 OID 423784)
-- Name: idx_route_cache_key; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_route_cache_key ON public.route_cache USING btree (cache_key);


--
-- TOC entry 5513 (class 1259 OID 486876)
-- Name: idx_shipment_metrics_driver_tracking; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_shipment_metrics_driver_tracking ON public.shipment_tracking_metrics USING btree (driver_tracking_session_id);


--
-- TOC entry 5514 (class 1259 OID 486877)
-- Name: idx_shipment_metrics_shipment; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_shipment_metrics_shipment ON public.shipment_tracking_metrics USING btree (shipment_id);


--
-- TOC entry 5393 (class 1259 OID 270668)
-- Name: idx_sms_billing_sent_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_sms_billing_sent_date ON public.sms_billing USING btree (sent_at);


--
-- TOC entry 5394 (class 1259 OID 270667)
-- Name: idx_sms_billing_unpaid; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_sms_billing_unpaid ON public.sms_billing USING btree (user_id, is_paid) WHERE (is_paid = false);


--
-- TOC entry 5395 (class 1259 OID 270666)
-- Name: idx_sms_billing_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_sms_billing_user ON public.sms_billing USING btree (user_id);


--
-- TOC entry 5519 (class 1259 OID 489261)
-- Name: idx_tracking_health_events_session; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_tracking_health_events_session ON public.tracking_health_events USING btree (session_id, created_at DESC);


--
-- TOC entry 5520 (class 1259 OID 489263)
-- Name: idx_tracking_health_events_stale; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_tracking_health_events_stale ON public.tracking_health_events USING btree (session_id, event_type, created_at DESC) WHERE (event_type = 'stale_detected'::text);


--
-- TOC entry 5521 (class 1259 OID 489262)
-- Name: idx_tracking_health_events_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_tracking_health_events_type ON public.tracking_health_events USING btree (event_type, created_at DESC);


--
-- TOC entry 5401 (class 1259 OID 361963)
-- Name: idx_tracking_points_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_tracking_points_created_at ON public.tracking_points USING btree (created_at);


--
-- TOC entry 5402 (class 1259 OID 479917)
-- Name: idx_tracking_points_driver_tracking; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_tracking_points_driver_tracking ON public.tracking_points USING btree (driver_tracking_id);


--
-- TOC entry 5403 (class 1259 OID 479918)
-- Name: idx_tracking_points_driver_tracking_timestamp; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_tracking_points_driver_tracking_timestamp ON public.tracking_points USING btree (driver_tracking_id, "timestamp" DESC);


--
-- TOC entry 5404 (class 1259 OID 397424)
-- Name: idx_tracking_points_latest_position; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_tracking_points_latest_position ON public.tracking_points USING btree (tracking_id, "timestamp" DESC) WHERE (type = ANY (ARRAY['tracking'::public.tracking_point_type, 'pickup'::public.tracking_point_type, 'dropoff'::public.tracking_point_type]));


--
-- TOC entry 5405 (class 1259 OID 361964)
-- Name: idx_tracking_points_location; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_tracking_points_location ON public.tracking_points USING gist (location);


--
-- TOC entry 5406 (class 1259 OID 373635)
-- Name: idx_tracking_points_location_gist; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_tracking_points_location_gist ON public.tracking_points USING gist (location);


--
-- TOC entry 5407 (class 1259 OID 361966)
-- Name: idx_tracking_points_milestones; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_tracking_points_milestones ON public.tracking_points USING btree (tracking_id, type) WHERE (type = ANY (ARRAY['start'::public.tracking_point_type, 'pickup'::public.tracking_point_type, 'dropoff'::public.tracking_point_type, 'stop'::public.tracking_point_type]));


--
-- TOC entry 5408 (class 1259 OID 379456)
-- Name: idx_tracking_points_realtime_include; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_tracking_points_realtime_include ON public.tracking_points USING btree (tracking_id, "timestamp" DESC) INCLUDE (latitude, longitude, speed, heading);


--
-- TOC entry 6120 (class 0 OID 0)
-- Dependencies: 5408
-- Name: INDEX idx_tracking_points_realtime_include; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON INDEX public.idx_tracking_points_realtime_include IS 'Optimized for real-time position queries with included columns to avoid table lookups';


--
-- TOC entry 5409 (class 1259 OID 361965)
-- Name: idx_tracking_points_recent; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_tracking_points_recent ON public.tracking_points USING btree (tracking_id, "timestamp" DESC);


--
-- TOC entry 5410 (class 1259 OID 361961)
-- Name: idx_tracking_points_timestamp; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_tracking_points_timestamp ON public.tracking_points USING btree ("timestamp");


--
-- TOC entry 5411 (class 1259 OID 373648)
-- Name: idx_tracking_points_tracking_id_timestamp; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_tracking_points_tracking_id_timestamp ON public.tracking_points USING btree (tracking_id, "timestamp" DESC);


--
-- TOC entry 5412 (class 1259 OID 361962)
-- Name: idx_tracking_points_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_tracking_points_type ON public.tracking_points USING btree (type);


--
-- TOC entry 5413 (class 1259 OID 422640)
-- Name: idx_tracking_sequence; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_tracking_sequence ON public.tracking_points USING btree (tracking_id, sequence_number DESC);


--
-- TOC entry 5414 (class 1259 OID 422641)
-- Name: idx_tracking_sequence_asc; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_tracking_sequence_asc ON public.tracking_points USING btree (tracking_id, sequence_number);


--
-- TOC entry 5508 (class 1259 OID 479866)
-- Name: idx_tracking_shipments_removed; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_tracking_shipments_removed ON public.driver_tracking_shipments USING btree (removed_at) WHERE (removed_at IS NULL);


--
-- TOC entry 5509 (class 1259 OID 479865)
-- Name: idx_tracking_shipments_shipment; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_tracking_shipments_shipment ON public.driver_tracking_shipments USING btree (shipment_id);


--
-- TOC entry 5510 (class 1259 OID 479867)
-- Name: idx_tracking_shipments_shipment_removed; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_tracking_shipments_shipment_removed ON public.driver_tracking_shipments USING btree (shipment_id, removed_at);


--
-- TOC entry 5511 (class 1259 OID 479864)
-- Name: idx_tracking_shipments_tracking; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_tracking_shipments_tracking ON public.driver_tracking_shipments USING btree (driver_tracking_id);


--
-- TOC entry 5358 (class 1259 OID 455636)
-- Name: idx_unique_active_payment_per_shipment; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX idx_unique_active_payment_per_shipment ON public.payments USING btree (freight_post_id) WHERE (status = ANY (ARRAY['pending'::public.payment_status, 'completed'::public.payment_status]));


--
-- TOC entry 6121 (class 0 OID 0)
-- Dependencies: 5358
-- Name: INDEX idx_unique_active_payment_per_shipment; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON INDEX public.idx_unique_active_payment_per_shipment IS 'Ensures only one active (pending/completed) payment per shipment. Failed/refunded payments excluded to allow retries.';


--
-- TOC entry 5365 (class 1259 OID 259018)
-- Name: idx_users_address_role_driver; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_users_address_role_driver ON public.users USING gist (address) WHERE ((role = 'Driver'::public.user_role) AND (address IS NOT NULL));


--
-- TOC entry 5366 (class 1259 OID 259019)
-- Name: idx_users_address_role_shipper; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_users_address_role_shipper ON public.users USING gist (address) WHERE ((role = 'Shipper'::public.user_role) AND (address IS NOT NULL));


--
-- TOC entry 5367 (class 1259 OID 511759)
-- Name: idx_users_driver_verification_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_users_driver_verification_status ON public.users USING btree (driver_verification_status) WHERE (role = 'Driver'::public.user_role);


--
-- TOC entry 5368 (class 1259 OID 280066)
-- Name: idx_users_fcm_token; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_users_fcm_token ON public.users USING btree (fcm_token) WHERE (fcm_token IS NOT NULL);


--
-- TOC entry 5369 (class 1259 OID 511760)
-- Name: idx_users_is_suspended; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_users_is_suspended ON public.users USING btree (is_suspended) WHERE (is_suspended = true);


--
-- TOC entry 5370 (class 1259 OID 282746)
-- Name: idx_users_notification_radius; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_users_notification_radius ON public.users USING btree (notification_radius_km) WHERE (role = 'Driver'::public.user_role);


--
-- TOC entry 5371 (class 1259 OID 511758)
-- Name: idx_users_role; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_users_role ON public.users USING btree (role);


--
-- TOC entry 5378 (class 1259 OID 158742)
-- Name: idx_vehicles_driver_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_vehicles_driver_id ON public.vehicles USING btree (driver_id);


--
-- TOC entry 5379 (class 1259 OID 248330)
-- Name: idx_vehicles_driver_id_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_vehicles_driver_id_active ON public.vehicles USING btree (driver_id, id);


--
-- TOC entry 5380 (class 1259 OID 511776)
-- Name: idx_vehicles_verification_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_vehicles_verification_status ON public.vehicles USING btree (verification_status);


--
-- TOC entry 5485 (class 1259 OID 444994)
-- Name: idx_webhook_event_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_webhook_event_type ON public.paystack_webhook_events USING btree (event_type);


--
-- TOC entry 5486 (class 1259 OID 444996)
-- Name: idx_webhook_processed; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_webhook_processed ON public.paystack_webhook_events USING btree (processed);


--
-- TOC entry 5487 (class 1259 OID 444997)
-- Name: idx_webhook_received_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_webhook_received_at ON public.paystack_webhook_events USING btree (received_at);


--
-- TOC entry 5488 (class 1259 OID 444995)
-- Name: idx_webhook_reference; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_webhook_reference ON public.paystack_webhook_events USING btree (paystack_reference);


--
-- TOC entry 5505 (class 1259 OID 479846)
-- Name: one_active_session_per_driver; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX one_active_session_per_driver ON public.driver_tracking_sessions USING btree (driver_id) WHERE (status = 'active'::text);


--
-- TOC entry 5512 (class 1259 OID 479868)
-- Name: unique_active_tracking_shipment; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX unique_active_tracking_shipment ON public.driver_tracking_shipments USING btree (driver_tracking_id, shipment_id) WHERE (removed_at IS NULL);


--
-- TOC entry 5671 (class 2620 OID 522121)
-- Name: disputes trg_notify_dispute_filed; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_notify_dispute_filed AFTER INSERT ON public.disputes FOR EACH ROW EXECUTE FUNCTION public.trigger_notify_dispute_filed();


--
-- TOC entry 5672 (class 2620 OID 522123)
-- Name: disputes trg_notify_dispute_updated; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_notify_dispute_updated AFTER UPDATE ON public.disputes FOR EACH ROW EXECUTE FUNCTION public.trigger_notify_dispute_updated();


--
-- TOC entry 5661 (class 2620 OID 522129)
-- Name: driver_docs trg_notify_document_uploaded; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_notify_document_uploaded AFTER INSERT ON public.driver_docs FOR EACH ROW EXECUTE FUNCTION public.trigger_notify_document_uploaded();


--
-- TOC entry 5655 (class 2620 OID 522125)
-- Name: users trg_notify_driver_registered; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_notify_driver_registered AFTER INSERT ON public.users FOR EACH ROW EXECUTE FUNCTION public.trigger_notify_driver_registered();


--
-- TOC entry 5656 (class 2620 OID 522127)
-- Name: users trg_notify_driver_status_changed; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_notify_driver_status_changed AFTER UPDATE ON public.users FOR EACH ROW EXECUTE FUNCTION public.trigger_notify_driver_status_changed();


--
-- TOC entry 5669 (class 2620 OID 479874)
-- Name: driver_tracking_sessions trigger_auto_update_timestamp; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_auto_update_timestamp BEFORE UPDATE ON public.driver_tracking_sessions FOR EACH ROW EXECUTE FUNCTION public.auto_update_timestamp();


--
-- TOC entry 5647 (class 2620 OID 69203)
-- Name: bids trigger_bid_status_change; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_bid_status_change AFTER UPDATE OF status ON public.bids FOR EACH ROW EXECUTE FUNCTION public.handle_bid_status_change();


--
-- TOC entry 5648 (class 2620 OID 477417)
-- Name: bids trigger_bid_update; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_bid_update AFTER UPDATE OF bid_amount ON public.bids FOR EACH ROW WHEN ((old.bid_amount IS DISTINCT FROM new.bid_amount)) EXECUTE FUNCTION public.handle_bid_update();


--
-- TOC entry 6122 (class 0 OID 0)
-- Dependencies: 5648
-- Name: TRIGGER trigger_bid_update ON bids; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TRIGGER trigger_bid_update ON public.bids IS 'Triggers notification to shipper when driver updates their bid amount';


--
-- TOC entry 5670 (class 2620 OID 483378)
-- Name: driver_tracking_sessions trigger_calculate_distance_eta; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_calculate_distance_eta BEFORE UPDATE OF current_latitude, current_longitude, current_speed ON public.driver_tracking_sessions FOR EACH ROW EXECUTE FUNCTION public.auto_calculate_distance_eta();


--
-- TOC entry 6123 (class 0 OID 0)
-- Dependencies: 5670
-- Name: TRIGGER trigger_calculate_distance_eta ON driver_tracking_sessions; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TRIGGER trigger_calculate_distance_eta ON public.driver_tracking_sessions IS 'Triggers automatic distance and ETA calculation on location updates';


--
-- TOC entry 5662 (class 2620 OID 361968)
-- Name: tracking_points trigger_calculate_tracking_metrics; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_calculate_tracking_metrics BEFORE INSERT ON public.tracking_points FOR EACH ROW EXECUTE FUNCTION public.calculate_tracking_point_metrics();


--
-- TOC entry 5673 (class 2620 OID 511920)
-- Name: disputes trigger_disputes_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_disputes_updated_at BEFORE UPDATE ON public.disputes FOR EACH ROW EXECUTE FUNCTION public.update_disputes_updated_at();


--
-- TOC entry 5666 (class 2620 OID 445019)
-- Name: driver_bank_accounts trigger_driver_bank_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_driver_bank_updated_at BEFORE UPDATE ON public.driver_bank_accounts FOR EACH ROW EXECUTE FUNCTION public.update_payment_modified_at();


--
-- TOC entry 5657 (class 2620 OID 258945)
-- Name: users trigger_driver_registration; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_driver_registration AFTER UPDATE ON public.users FOR EACH ROW EXECUTE FUNCTION public.handle_driver_registration();


--
-- TOC entry 5665 (class 2620 OID 445018)
-- Name: escrow_holdings trigger_escrow_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_escrow_updated_at BEFORE UPDATE ON public.escrow_holdings FOR EACH ROW EXECUTE FUNCTION public.update_payment_modified_at();


--
-- TOC entry 5651 (class 2620 OID 112530)
-- Name: freight_posts trigger_freight_status_change; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_freight_status_change AFTER UPDATE OF status ON public.freight_posts FOR EACH ROW EXECUTE FUNCTION public.handle_freight_status_change();


--
-- TOC entry 5649 (class 2620 OID 258953)
-- Name: bids trigger_new_bid; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_new_bid AFTER INSERT ON public.bids FOR EACH ROW EXECUTE FUNCTION public.handle_new_bid();


--
-- TOC entry 5652 (class 2620 OID 258950)
-- Name: freight_posts trigger_new_shipment; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_new_shipment AFTER INSERT ON public.freight_posts FOR EACH ROW EXECUTE FUNCTION public.handle_new_shipment();


--
-- TOC entry 5658 (class 2620 OID 278738)
-- Name: users trigger_new_user_preferences; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_new_user_preferences AFTER INSERT ON public.users FOR EACH ROW EXECUTE FUNCTION public.handle_new_user_preferences();


--
-- TOC entry 5667 (class 2620 OID 445020)
-- Name: driver_payouts trigger_payout_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_payout_updated_at BEFORE UPDATE ON public.driver_payouts FOR EACH ROW EXECUTE FUNCTION public.update_payment_modified_at();


--
-- TOC entry 5653 (class 2620 OID 270977)
-- Name: notifications trigger_process_sms_notification; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_process_sms_notification AFTER INSERT ON public.notifications FOR EACH ROW EXECUTE FUNCTION public.process_sms_notification();


--
-- TOC entry 5659 (class 2620 OID 258943)
-- Name: users trigger_profile_update; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_profile_update AFTER UPDATE ON public.users FOR EACH ROW EXECUTE FUNCTION public.handle_profile_update();


--
-- TOC entry 5654 (class 2620 OID 258957)
-- Name: ratings trigger_rating_received; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_rating_received AFTER INSERT ON public.ratings FOR EACH ROW EXECUTE FUNCTION public.handle_rating_received();


--
-- TOC entry 5668 (class 2620 OID 445021)
-- Name: payment_refunds trigger_refund_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_refund_updated_at BEFORE UPDATE ON public.payment_refunds FOR EACH ROW EXECUTE FUNCTION public.update_payment_modified_at();


--
-- TOC entry 5663 (class 2620 OID 483411)
-- Name: tracking_points trigger_update_driver_tracking_on_point; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_driver_tracking_on_point AFTER INSERT ON public.tracking_points FOR EACH ROW EXECUTE FUNCTION public.update_driver_tracking_session_on_new_point();


--
-- TOC entry 6124 (class 0 OID 0)
-- Dependencies: 5663
-- Name: TRIGGER trigger_update_driver_tracking_on_point ON tracking_points; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TRIGGER trigger_update_driver_tracking_on_point ON public.tracking_points IS 'Triggers automatic update of driver tracking session metrics on new point insertion';


--
-- TOC entry 5664 (class 2620 OID 407111)
-- Name: tracking_points trigger_update_tracking_session; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_tracking_session AFTER INSERT ON public.tracking_points FOR EACH ROW EXECUTE FUNCTION public.update_tracking_session_on_new_point();


--
-- TOC entry 5660 (class 2620 OID 258947)
-- Name: vehicles trigger_vehicle_added; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_vehicle_added AFTER INSERT ON public.vehicles FOR EACH ROW EXECUTE FUNCTION public.handle_vehicle_added();


--
-- TOC entry 5650 (class 2620 OID 421429)
-- Name: bids update_freight_post_lowest_bid; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_freight_post_lowest_bid AFTER INSERT OR DELETE OR UPDATE ON public.bids FOR EACH ROW EXECUTE FUNCTION public.sync_freight_post_lowest_bid();


--
-- TOC entry 5560 (class 2606 OID 31103)
-- Name: identities identities_user_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.identities
    ADD CONSTRAINT identities_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;


--
-- TOC entry 5561 (class 2606 OID 31108)
-- Name: mfa_amr_claims mfa_amr_claims_session_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.mfa_amr_claims
    ADD CONSTRAINT mfa_amr_claims_session_id_fkey FOREIGN KEY (session_id) REFERENCES auth.sessions(id) ON DELETE CASCADE;


--
-- TOC entry 5562 (class 2606 OID 31113)
-- Name: mfa_challenges mfa_challenges_auth_factor_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.mfa_challenges
    ADD CONSTRAINT mfa_challenges_auth_factor_id_fkey FOREIGN KEY (factor_id) REFERENCES auth.mfa_factors(id) ON DELETE CASCADE;


--
-- TOC entry 5563 (class 2606 OID 31118)
-- Name: mfa_factors mfa_factors_user_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.mfa_factors
    ADD CONSTRAINT mfa_factors_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;


--
-- TOC entry 5594 (class 2606 OID 393243)
-- Name: oauth_authorizations oauth_authorizations_client_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.oauth_authorizations
    ADD CONSTRAINT oauth_authorizations_client_id_fkey FOREIGN KEY (client_id) REFERENCES auth.oauth_clients(id) ON DELETE CASCADE;


--
-- TOC entry 5595 (class 2606 OID 393248)
-- Name: oauth_authorizations oauth_authorizations_user_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.oauth_authorizations
    ADD CONSTRAINT oauth_authorizations_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;


--
-- TOC entry 5596 (class 2606 OID 393272)
-- Name: oauth_consents oauth_consents_client_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.oauth_consents
    ADD CONSTRAINT oauth_consents_client_id_fkey FOREIGN KEY (client_id) REFERENCES auth.oauth_clients(id) ON DELETE CASCADE;


--
-- TOC entry 5597 (class 2606 OID 393267)
-- Name: oauth_consents oauth_consents_user_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.oauth_consents
    ADD CONSTRAINT oauth_consents_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;


--
-- TOC entry 5564 (class 2606 OID 31123)
-- Name: one_time_tokens one_time_tokens_user_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.one_time_tokens
    ADD CONSTRAINT one_time_tokens_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;


--
-- TOC entry 5565 (class 2606 OID 31128)
-- Name: refresh_tokens refresh_tokens_session_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.refresh_tokens
    ADD CONSTRAINT refresh_tokens_session_id_fkey FOREIGN KEY (session_id) REFERENCES auth.sessions(id) ON DELETE CASCADE;


--
-- TOC entry 5566 (class 2606 OID 31133)
-- Name: saml_providers saml_providers_sso_provider_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.saml_providers
    ADD CONSTRAINT saml_providers_sso_provider_id_fkey FOREIGN KEY (sso_provider_id) REFERENCES auth.sso_providers(id) ON DELETE CASCADE;


--
-- TOC entry 5567 (class 2606 OID 31138)
-- Name: saml_relay_states saml_relay_states_flow_state_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.saml_relay_states
    ADD CONSTRAINT saml_relay_states_flow_state_id_fkey FOREIGN KEY (flow_state_id) REFERENCES auth.flow_state(id) ON DELETE CASCADE;


--
-- TOC entry 5568 (class 2606 OID 31143)
-- Name: saml_relay_states saml_relay_states_sso_provider_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.saml_relay_states
    ADD CONSTRAINT saml_relay_states_sso_provider_id_fkey FOREIGN KEY (sso_provider_id) REFERENCES auth.sso_providers(id) ON DELETE CASCADE;


--
-- TOC entry 5569 (class 2606 OID 393286)
-- Name: sessions sessions_oauth_client_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.sessions
    ADD CONSTRAINT sessions_oauth_client_id_fkey FOREIGN KEY (oauth_client_id) REFERENCES auth.oauth_clients(id) ON DELETE CASCADE;


--
-- TOC entry 5570 (class 2606 OID 31148)
-- Name: sessions sessions_user_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.sessions
    ADD CONSTRAINT sessions_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;


--
-- TOC entry 5571 (class 2606 OID 31153)
-- Name: sso_domains sso_domains_sso_provider_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.sso_domains
    ADD CONSTRAINT sso_domains_sso_provider_id_fkey FOREIGN KEY (sso_provider_id) REFERENCES auth.sso_providers(id) ON DELETE CASCADE;


--
-- TOC entry 5634 (class 2606 OID 511792)
-- Name: admin_audit_logs admin_audit_logs_admin_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.admin_audit_logs
    ADD CONSTRAINT admin_audit_logs_admin_id_fkey FOREIGN KEY (admin_id) REFERENCES public.users(id);


--
-- TOC entry 5644 (class 2606 OID 511907)
-- Name: admin_messages admin_messages_recipient_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.admin_messages
    ADD CONSTRAINT admin_messages_recipient_id_fkey FOREIGN KEY (recipient_id) REFERENCES public.users(id);


--
-- TOC entry 5645 (class 2606 OID 511902)
-- Name: admin_messages admin_messages_sent_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.admin_messages
    ADD CONSTRAINT admin_messages_sent_by_fkey FOREIGN KEY (sent_by) REFERENCES public.users(id);


--
-- TOC entry 5572 (class 2606 OID 31163)
-- Name: bids bids_freight_post_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.bids
    ADD CONSTRAINT bids_freight_post_id_fkey FOREIGN KEY (freight_post_id) REFERENCES public.freight_posts(id);


--
-- TOC entry 5573 (class 2606 OID 35796)
-- Name: bids bids_vehicle_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.bids
    ADD CONSTRAINT bids_vehicle_id_fkey FOREIGN KEY (vehicle_id) REFERENCES public.vehicles(id);


--
-- TOC entry 5618 (class 2606 OID 444965)
-- Name: commission_ledger commission_ledger_escrow_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.commission_ledger
    ADD CONSTRAINT commission_ledger_escrow_id_fkey FOREIGN KEY (escrow_id) REFERENCES public.escrow_holdings(id);


--
-- TOC entry 5619 (class 2606 OID 444955)
-- Name: commission_ledger commission_ledger_freight_post_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.commission_ledger
    ADD CONSTRAINT commission_ledger_freight_post_id_fkey FOREIGN KEY (freight_post_id) REFERENCES public.freight_posts(id);


--
-- TOC entry 5620 (class 2606 OID 444960)
-- Name: commission_ledger commission_ledger_payment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.commission_ledger
    ADD CONSTRAINT commission_ledger_payment_id_fkey FOREIGN KEY (payment_id) REFERENCES public.payments(id);


--
-- TOC entry 5621 (class 2606 OID 444970)
-- Name: commission_ledger commission_ledger_payout_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.commission_ledger
    ADD CONSTRAINT commission_ledger_payout_id_fkey FOREIGN KEY (payout_id) REFERENCES public.driver_payouts(id);


--
-- TOC entry 5622 (class 2606 OID 444975)
-- Name: commission_ledger commission_ledger_refund_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.commission_ledger
    ADD CONSTRAINT commission_ledger_refund_id_fkey FOREIGN KEY (refund_id) REFERENCES public.payment_refunds(id);


--
-- TOC entry 5646 (class 2606 OID 522093)
-- Name: device_tokens device_tokens_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.device_tokens
    ADD CONSTRAINT device_tokens_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id) ON DELETE CASCADE;


--
-- TOC entry 5642 (class 2606 OID 511878)
-- Name: dispute_evidence dispute_evidence_dispute_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.dispute_evidence
    ADD CONSTRAINT dispute_evidence_dispute_id_fkey FOREIGN KEY (dispute_id) REFERENCES public.disputes(id) ON DELETE CASCADE;


--
-- TOC entry 5643 (class 2606 OID 511883)
-- Name: dispute_evidence dispute_evidence_submitted_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.dispute_evidence
    ADD CONSTRAINT dispute_evidence_submitted_by_fkey FOREIGN KEY (submitted_by) REFERENCES public.users(id);


--
-- TOC entry 5637 (class 2606 OID 511851)
-- Name: disputes disputes_admin_assigned_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.disputes
    ADD CONSTRAINT disputes_admin_assigned_fkey FOREIGN KEY (admin_assigned) REFERENCES public.users(id);


--
-- TOC entry 5638 (class 2606 OID 511836)
-- Name: disputes disputes_freight_post_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.disputes
    ADD CONSTRAINT disputes_freight_post_id_fkey FOREIGN KEY (freight_post_id) REFERENCES public.freight_posts(id);


--
-- TOC entry 5639 (class 2606 OID 511846)
-- Name: disputes disputes_raised_against_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.disputes
    ADD CONSTRAINT disputes_raised_against_fkey FOREIGN KEY (raised_against) REFERENCES public.users(id);


--
-- TOC entry 5640 (class 2606 OID 511841)
-- Name: disputes disputes_raised_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.disputes
    ADD CONSTRAINT disputes_raised_by_fkey FOREIGN KEY (raised_by) REFERENCES public.users(id);


--
-- TOC entry 5641 (class 2606 OID 511856)
-- Name: disputes disputes_resolved_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.disputes
    ADD CONSTRAINT disputes_resolved_by_fkey FOREIGN KEY (resolved_by) REFERENCES public.users(id);


--
-- TOC entry 5635 (class 2606 OID 511816)
-- Name: driver_approval_history driver_approval_history_admin_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.driver_approval_history
    ADD CONSTRAINT driver_approval_history_admin_id_fkey FOREIGN KEY (admin_id) REFERENCES public.users(id);


--
-- TOC entry 5636 (class 2606 OID 511811)
-- Name: driver_approval_history driver_approval_history_driver_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.driver_approval_history
    ADD CONSTRAINT driver_approval_history_driver_id_fkey FOREIGN KEY (driver_id) REFERENCES public.users(id);


--
-- TOC entry 5606 (class 2606 OID 444844)
-- Name: driver_bank_accounts driver_bank_accounts_driver_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.driver_bank_accounts
    ADD CONSTRAINT driver_bank_accounts_driver_id_fkey FOREIGN KEY (driver_id) REFERENCES public.users(id) ON DELETE CASCADE;


--
-- TOC entry 5607 (class 2606 OID 511777)
-- Name: driver_bank_accounts driver_bank_accounts_verified_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.driver_bank_accounts
    ADD CONSTRAINT driver_bank_accounts_verified_by_fkey FOREIGN KEY (verified_by) REFERENCES public.users(id);


--
-- TOC entry 5588 (class 2606 OID 153420)
-- Name: driver_docs driver_docs_driver_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.driver_docs
    ADD CONSTRAINT driver_docs_driver_id_fkey FOREIGN KEY (driver_id) REFERENCES public.users(id) ON DELETE CASCADE;


--
-- TOC entry 5589 (class 2606 OID 511762)
-- Name: driver_docs driver_docs_verified_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.driver_docs
    ADD CONSTRAINT driver_docs_verified_by_fkey FOREIGN KEY (verified_by) REFERENCES public.users(id);


--
-- TOC entry 5608 (class 2606 OID 444889)
-- Name: driver_payouts driver_payouts_bank_account_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.driver_payouts
    ADD CONSTRAINT driver_payouts_bank_account_id_fkey FOREIGN KEY (bank_account_id) REFERENCES public.driver_bank_accounts(id);


--
-- TOC entry 5609 (class 2606 OID 444879)
-- Name: driver_payouts driver_payouts_bid_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.driver_payouts
    ADD CONSTRAINT driver_payouts_bid_id_fkey FOREIGN KEY (bid_id) REFERENCES public.bids(id);


--
-- TOC entry 5610 (class 2606 OID 444884)
-- Name: driver_payouts driver_payouts_driver_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.driver_payouts
    ADD CONSTRAINT driver_payouts_driver_id_fkey FOREIGN KEY (driver_id) REFERENCES public.users(id);


--
-- TOC entry 5611 (class 2606 OID 444869)
-- Name: driver_payouts driver_payouts_escrow_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.driver_payouts
    ADD CONSTRAINT driver_payouts_escrow_id_fkey FOREIGN KEY (escrow_id) REFERENCES public.escrow_holdings(id);


--
-- TOC entry 5612 (class 2606 OID 444874)
-- Name: driver_payouts driver_payouts_freight_post_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.driver_payouts
    ADD CONSTRAINT driver_payouts_freight_post_id_fkey FOREIGN KEY (freight_post_id) REFERENCES public.freight_posts(id);


--
-- TOC entry 5628 (class 2606 OID 479838)
-- Name: driver_tracking_sessions driver_tracking_sessions_driver_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.driver_tracking_sessions
    ADD CONSTRAINT driver_tracking_sessions_driver_id_fkey FOREIGN KEY (driver_id) REFERENCES public.users(id) ON DELETE CASCADE;


--
-- TOC entry 5629 (class 2606 OID 479854)
-- Name: driver_tracking_shipments driver_tracking_shipments_driver_tracking_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.driver_tracking_shipments
    ADD CONSTRAINT driver_tracking_shipments_driver_tracking_id_fkey FOREIGN KEY (driver_tracking_id) REFERENCES public.driver_tracking_sessions(id) ON DELETE CASCADE;


--
-- TOC entry 5630 (class 2606 OID 479859)
-- Name: driver_tracking_shipments driver_tracking_shipments_shipment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.driver_tracking_shipments
    ADD CONSTRAINT driver_tracking_shipments_shipment_id_fkey FOREIGN KEY (shipment_id) REFERENCES public.freight_posts(id) ON DELETE CASCADE;


--
-- TOC entry 5602 (class 2606 OID 444814)
-- Name: escrow_holdings escrow_holdings_bid_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.escrow_holdings
    ADD CONSTRAINT escrow_holdings_bid_id_fkey FOREIGN KEY (bid_id) REFERENCES public.bids(id);


--
-- TOC entry 5603 (class 2606 OID 444809)
-- Name: escrow_holdings escrow_holdings_freight_post_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.escrow_holdings
    ADD CONSTRAINT escrow_holdings_freight_post_id_fkey FOREIGN KEY (freight_post_id) REFERENCES public.freight_posts(id);


--
-- TOC entry 5604 (class 2606 OID 444804)
-- Name: escrow_holdings escrow_holdings_payment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.escrow_holdings
    ADD CONSTRAINT escrow_holdings_payment_id_fkey FOREIGN KEY (payment_id) REFERENCES public.payments(id) ON DELETE CASCADE;


--
-- TOC entry 5605 (class 2606 OID 444819)
-- Name: escrow_holdings escrow_holdings_shipper_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.escrow_holdings
    ADD CONSTRAINT escrow_holdings_shipper_id_fkey FOREIGN KEY (shipper_id) REFERENCES public.users(id);


--
-- TOC entry 5623 (class 2606 OID 479772)
-- Name: flagged_documents flagged_documents_document_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.flagged_documents
    ADD CONSTRAINT flagged_documents_document_id_fkey FOREIGN KEY (document_id) REFERENCES public.driver_docs(id) ON DELETE CASCADE;


--
-- TOC entry 5624 (class 2606 OID 479777)
-- Name: flagged_documents flagged_documents_driver_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.flagged_documents
    ADD CONSTRAINT flagged_documents_driver_id_fkey FOREIGN KEY (driver_id) REFERENCES public.users(id) ON DELETE CASCADE;


--
-- TOC entry 5625 (class 2606 OID 479782)
-- Name: flagged_documents flagged_documents_flagged_by_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.flagged_documents
    ADD CONSTRAINT flagged_documents_flagged_by_user_id_fkey FOREIGN KEY (flagged_by_user_id) REFERENCES public.users(id) ON DELETE CASCADE;


--
-- TOC entry 5626 (class 2606 OID 479792)
-- Name: flagged_documents flagged_documents_reviewed_by_admin_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.flagged_documents
    ADD CONSTRAINT flagged_documents_reviewed_by_admin_id_fkey FOREIGN KEY (reviewed_by_admin_id) REFERENCES public.users(id) ON DELETE SET NULL;


--
-- TOC entry 5627 (class 2606 OID 479787)
-- Name: flagged_documents flagged_documents_shipment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.flagged_documents
    ADD CONSTRAINT flagged_documents_shipment_id_fkey FOREIGN KEY (shipment_id) REFERENCES public.freight_posts(id) ON DELETE SET NULL;


--
-- TOC entry 5574 (class 2606 OID 31168)
-- Name: freight_items freight_items_freight_post_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.freight_items
    ADD CONSTRAINT freight_items_freight_post_id_fkey FOREIGN KEY (freight_post_id) REFERENCES public.freight_posts(id) ON DELETE CASCADE;


--
-- TOC entry 5599 (class 2606 OID 433368)
-- Name: freight_moving freight_moving_freight_post_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.freight_moving
    ADD CONSTRAINT freight_moving_freight_post_id_fkey FOREIGN KEY (freight_post_id) REFERENCES public.freight_posts(id) ON DELETE CASCADE;


--
-- TOC entry 5575 (class 2606 OID 31173)
-- Name: freight_posts freight_posts_shipper_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.freight_posts
    ADD CONSTRAINT freight_posts_shipper_id_fkey FOREIGN KEY (shipper_id) REFERENCES public.users(id);


--
-- TOC entry 5600 (class 2606 OID 433389)
-- Name: freight_rubble freight_rubble_freight_post_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.freight_rubble
    ADD CONSTRAINT freight_rubble_freight_post_id_fkey FOREIGN KEY (freight_post_id) REFERENCES public.freight_posts(id) ON DELETE CASCADE;


--
-- TOC entry 5601 (class 2606 OID 433408)
-- Name: freight_vehicles freight_vehicles_freight_post_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.freight_vehicles
    ADD CONSTRAINT freight_vehicles_freight_post_id_fkey FOREIGN KEY (freight_post_id) REFERENCES public.freight_posts(id) ON DELETE CASCADE;


--
-- TOC entry 5590 (class 2606 OID 270564)
-- Name: notification_type_preferences notification_type_preferences_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.notification_type_preferences
    ADD CONSTRAINT notification_type_preferences_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id) ON DELETE CASCADE;


--
-- TOC entry 5576 (class 2606 OID 31178)
-- Name: notifications notifications_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.notifications
    ADD CONSTRAINT notifications_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id);


--
-- TOC entry 5613 (class 2606 OID 444934)
-- Name: payment_refunds payment_refunds_cancelled_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payment_refunds
    ADD CONSTRAINT payment_refunds_cancelled_by_fkey FOREIGN KEY (cancelled_by) REFERENCES public.users(id);


--
-- TOC entry 5614 (class 2606 OID 444919)
-- Name: payment_refunds payment_refunds_escrow_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payment_refunds
    ADD CONSTRAINT payment_refunds_escrow_id_fkey FOREIGN KEY (escrow_id) REFERENCES public.escrow_holdings(id);


--
-- TOC entry 5615 (class 2606 OID 444924)
-- Name: payment_refunds payment_refunds_freight_post_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payment_refunds
    ADD CONSTRAINT payment_refunds_freight_post_id_fkey FOREIGN KEY (freight_post_id) REFERENCES public.freight_posts(id);


--
-- TOC entry 5616 (class 2606 OID 444914)
-- Name: payment_refunds payment_refunds_payment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payment_refunds
    ADD CONSTRAINT payment_refunds_payment_id_fkey FOREIGN KEY (payment_id) REFERENCES public.payments(id);


--
-- TOC entry 5617 (class 2606 OID 444929)
-- Name: payment_refunds payment_refunds_shipper_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payment_refunds
    ADD CONSTRAINT payment_refunds_shipper_id_fkey FOREIGN KEY (shipper_id) REFERENCES public.users(id);


--
-- TOC entry 5577 (class 2606 OID 31183)
-- Name: payments payments_bid_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payments
    ADD CONSTRAINT payments_bid_id_fkey FOREIGN KEY (bid_id) REFERENCES public.bids(id);


--
-- TOC entry 5578 (class 2606 OID 31193)
-- Name: payments payments_freight_post_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payments
    ADD CONSTRAINT payments_freight_post_id_fkey FOREIGN KEY (freight_post_id) REFERENCES public.freight_posts(id);


--
-- TOC entry 5579 (class 2606 OID 444779)
-- Name: payments payments_shipper_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payments
    ADD CONSTRAINT payments_shipper_id_fkey FOREIGN KEY (shipper_id) REFERENCES public.users(id);


--
-- TOC entry 5580 (class 2606 OID 31203)
-- Name: ratings ratings_freight_post_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ratings
    ADD CONSTRAINT ratings_freight_post_id_fkey FOREIGN KEY (freight_post_id) REFERENCES public.freight_posts(id);


--
-- TOC entry 5581 (class 2606 OID 31208)
-- Name: ratings ratings_rated_by_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ratings
    ADD CONSTRAINT ratings_rated_by_user_id_fkey FOREIGN KEY (rated_by_user_id) REFERENCES public.users(id);


--
-- TOC entry 5582 (class 2606 OID 31213)
-- Name: ratings ratings_rated_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ratings
    ADD CONSTRAINT ratings_rated_user_id_fkey FOREIGN KEY (rated_user_id) REFERENCES public.users(id);


--
-- TOC entry 5598 (class 2606 OID 423779)
-- Name: route_cache route_cache_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.route_cache
    ADD CONSTRAINT route_cache_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id);


--
-- TOC entry 5631 (class 2606 OID 486866)
-- Name: shipment_tracking_metrics shipment_tracking_metrics_driver_tracking_session_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.shipment_tracking_metrics
    ADD CONSTRAINT shipment_tracking_metrics_driver_tracking_session_id_fkey FOREIGN KEY (driver_tracking_session_id) REFERENCES public.driver_tracking_sessions(id) ON DELETE CASCADE;


--
-- TOC entry 5632 (class 2606 OID 486871)
-- Name: shipment_tracking_metrics shipment_tracking_metrics_shipment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.shipment_tracking_metrics
    ADD CONSTRAINT shipment_tracking_metrics_shipment_id_fkey FOREIGN KEY (shipment_id) REFERENCES public.freight_posts(id) ON DELETE CASCADE;


--
-- TOC entry 5591 (class 2606 OID 270661)
-- Name: sms_billing sms_billing_notification_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sms_billing
    ADD CONSTRAINT sms_billing_notification_id_fkey FOREIGN KEY (notification_id) REFERENCES public.notifications(id);


--
-- TOC entry 5592 (class 2606 OID 270656)
-- Name: sms_billing sms_billing_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sms_billing
    ADD CONSTRAINT sms_billing_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id) ON DELETE CASCADE;


--
-- TOC entry 5633 (class 2606 OID 489256)
-- Name: tracking_health_events tracking_health_events_session_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.tracking_health_events
    ADD CONSTRAINT tracking_health_events_session_id_fkey FOREIGN KEY (session_id) REFERENCES public.driver_tracking_sessions(id) ON DELETE CASCADE;


--
-- TOC entry 5593 (class 2606 OID 479911)
-- Name: tracking_points tracking_points_driver_tracking_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.tracking_points
    ADD CONSTRAINT tracking_points_driver_tracking_id_fkey FOREIGN KEY (driver_tracking_id) REFERENCES public.driver_tracking_sessions(id) ON DELETE CASCADE;


--
-- TOC entry 5583 (class 2606 OID 511747)
-- Name: users users_driver_verified_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.users
    ADD CONSTRAINT users_driver_verified_by_fkey FOREIGN KEY (driver_verified_by) REFERENCES public.users(id);


--
-- TOC entry 5584 (class 2606 OID 31218)
-- Name: users users_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.users
    ADD CONSTRAINT users_id_fkey FOREIGN KEY (id) REFERENCES auth.users(id);


--
-- TOC entry 5585 (class 2606 OID 511753)
-- Name: users users_suspended_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.users
    ADD CONSTRAINT users_suspended_by_fkey FOREIGN KEY (suspended_by) REFERENCES public.users(id);


--
-- TOC entry 5586 (class 2606 OID 153374)
-- Name: vehicles vehicles_driver_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.vehicles
    ADD CONSTRAINT vehicles_driver_id_fkey FOREIGN KEY (driver_id) REFERENCES public.users(id);


--
-- TOC entry 5587 (class 2606 OID 511770)
-- Name: vehicles vehicles_verified_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.vehicles
    ADD CONSTRAINT vehicles_verified_by_fkey FOREIGN KEY (verified_by) REFERENCES public.users(id);


--
-- TOC entry 5830 (class 0 OID 30732)
-- Dependencies: 322
-- Name: audit_log_entries; Type: ROW SECURITY; Schema: auth; Owner: -
--

ALTER TABLE auth.audit_log_entries ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5831 (class 0 OID 30738)
-- Dependencies: 323
-- Name: flow_state; Type: ROW SECURITY; Schema: auth; Owner: -
--

ALTER TABLE auth.flow_state ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5832 (class 0 OID 30743)
-- Dependencies: 324
-- Name: identities; Type: ROW SECURITY; Schema: auth; Owner: -
--

ALTER TABLE auth.identities ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5833 (class 0 OID 30750)
-- Dependencies: 325
-- Name: instances; Type: ROW SECURITY; Schema: auth; Owner: -
--

ALTER TABLE auth.instances ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5834 (class 0 OID 30755)
-- Dependencies: 326
-- Name: mfa_amr_claims; Type: ROW SECURITY; Schema: auth; Owner: -
--

ALTER TABLE auth.mfa_amr_claims ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5835 (class 0 OID 30760)
-- Dependencies: 327
-- Name: mfa_challenges; Type: ROW SECURITY; Schema: auth; Owner: -
--

ALTER TABLE auth.mfa_challenges ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5836 (class 0 OID 30765)
-- Dependencies: 328
-- Name: mfa_factors; Type: ROW SECURITY; Schema: auth; Owner: -
--

ALTER TABLE auth.mfa_factors ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5837 (class 0 OID 30770)
-- Dependencies: 329
-- Name: one_time_tokens; Type: ROW SECURITY; Schema: auth; Owner: -
--

ALTER TABLE auth.one_time_tokens ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5838 (class 0 OID 30778)
-- Dependencies: 330
-- Name: refresh_tokens; Type: ROW SECURITY; Schema: auth; Owner: -
--

ALTER TABLE auth.refresh_tokens ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5839 (class 0 OID 30784)
-- Dependencies: 332
-- Name: saml_providers; Type: ROW SECURITY; Schema: auth; Owner: -
--

ALTER TABLE auth.saml_providers ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5840 (class 0 OID 30792)
-- Dependencies: 333
-- Name: saml_relay_states; Type: ROW SECURITY; Schema: auth; Owner: -
--

ALTER TABLE auth.saml_relay_states ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5841 (class 0 OID 30798)
-- Dependencies: 334
-- Name: schema_migrations; Type: ROW SECURITY; Schema: auth; Owner: -
--

ALTER TABLE auth.schema_migrations ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5842 (class 0 OID 30801)
-- Dependencies: 335
-- Name: sessions; Type: ROW SECURITY; Schema: auth; Owner: -
--

ALTER TABLE auth.sessions ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5843 (class 0 OID 30806)
-- Dependencies: 336
-- Name: sso_domains; Type: ROW SECURITY; Schema: auth; Owner: -
--

ALTER TABLE auth.sso_domains ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5844 (class 0 OID 30812)
-- Dependencies: 337
-- Name: sso_providers; Type: ROW SECURITY; Schema: auth; Owner: -
--

ALTER TABLE auth.sso_providers ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5845 (class 0 OID 30818)
-- Dependencies: 338
-- Name: users; Type: ROW SECURITY; Schema: auth; Owner: -
--

ALTER TABLE auth.users ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5971 (class 3256 OID 511926)
-- Name: disputes Admins can manage all disputes; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Admins can manage all disputes" ON public.disputes TO authenticated USING ((EXISTS ( SELECT 1
   FROM public.users
  WHERE ((users.id = auth.uid()) AND (users.role = 'Admin'::public.user_role)))));


--
-- TOC entry 5974 (class 3256 OID 511929)
-- Name: dispute_evidence Admins can manage all evidence; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Admins can manage all evidence" ON public.dispute_evidence TO authenticated USING ((EXISTS ( SELECT 1
   FROM public.users
  WHERE ((users.id = auth.uid()) AND (users.role = 'Admin'::public.user_role)))));


--
-- TOC entry 5946 (class 3256 OID 479803)
-- Name: flagged_documents Admins can manage all flags; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Admins can manage all flags" ON public.flagged_documents TO authenticated USING ((EXISTS ( SELECT 1
   FROM public.users
  WHERE ((users.id = auth.uid()) AND (users.role = 'Admin'::public.user_role))))) WITH CHECK ((EXISTS ( SELECT 1
   FROM public.users
  WHERE ((users.id = auth.uid()) AND (users.role = 'Admin'::public.user_role)))));


--
-- TOC entry 5977 (class 3256 OID 511932)
-- Name: admin_messages Admins can manage messages; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Admins can manage messages" ON public.admin_messages TO authenticated USING ((EXISTS ( SELECT 1
   FROM public.users
  WHERE ((users.id = auth.uid()) AND (users.role = 'Admin'::public.user_role)))));


--
-- TOC entry 5968 (class 3256 OID 511923)
-- Name: driver_approval_history Admins can view all approval history; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Admins can view all approval history" ON public.driver_approval_history FOR SELECT TO authenticated USING ((EXISTS ( SELECT 1
   FROM public.users
  WHERE ((users.id = auth.uid()) AND (users.role = 'Admin'::public.user_role)))));


--
-- TOC entry 5966 (class 3256 OID 511921)
-- Name: admin_audit_logs Admins can view audit logs; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Admins can view audit logs" ON public.admin_audit_logs FOR SELECT TO authenticated USING ((EXISTS ( SELECT 1
   FROM public.users
  WHERE ((users.id = auth.uid()) AND (users.role = 'Admin'::public.user_role)))));


--
-- TOC entry 5879 (class 3256 OID 60984)
-- Name: payments Allow read access to payments; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Allow read access to payments" ON public.payments FOR SELECT TO authenticated USING (true);


--
-- TOC entry 5880 (class 3256 OID 61006)
-- Name: users Allow read access to users; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Allow read access to users" ON public.users FOR SELECT TO authenticated USING (true);


--
-- TOC entry 5889 (class 3256 OID 216702)
-- Name: vehicles Allow read access to vehicles for bidding; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Allow read access to vehicles for bidding" ON public.vehicles FOR SELECT TO authenticated USING (true);


--
-- TOC entry 5925 (class 3256 OID 437965)
-- Name: freight_items Anyone can view items data for bidding shipments; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Anyone can view items data for bidding shipments" ON public.freight_items FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.freight_posts fp
  WHERE ((fp.id = freight_items.freight_post_id) AND (fp.status = 'Bidding'::public.freight_status) AND (fp.archived = false)))));


--
-- TOC entry 5916 (class 3256 OID 437959)
-- Name: freight_moving Anyone can view moving data for bidding shipments; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Anyone can view moving data for bidding shipments" ON public.freight_moving FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.freight_posts fp
  WHERE ((fp.id = freight_moving.freight_post_id) AND (fp.status = 'Bidding'::public.freight_status) AND (fp.archived = false)))));


--
-- TOC entry 5921 (class 3256 OID 437961)
-- Name: freight_rubble Anyone can view rubble data for bidding shipments; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Anyone can view rubble data for bidding shipments" ON public.freight_rubble FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.freight_posts fp
  WHERE ((fp.id = freight_rubble.freight_post_id) AND (fp.status = 'Bidding'::public.freight_status) AND (fp.archived = false)))));


--
-- TOC entry 5923 (class 3256 OID 437963)
-- Name: freight_vehicles Anyone can view vehicles data for bidding shipments; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Anyone can view vehicles data for bidding shipments" ON public.freight_vehicles FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.freight_posts fp
  WHERE ((fp.id = freight_vehicles.freight_post_id) AND (fp.status = 'Bidding'::public.freight_status) AND (fp.archived = false)))));


--
-- TOC entry 5897 (class 3256 OID 248200)
-- Name: users Deny public access to users; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Deny public access to users" ON public.users USING (false);


--
-- TOC entry 5898 (class 3256 OID 248201)
-- Name: vehicles Deny public access to vehicles; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Deny public access to vehicles" ON public.vehicles USING (false);


--
-- TOC entry 5976 (class 3256 OID 511931)
-- Name: dispute_evidence Dispute parties can add evidence; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Dispute parties can add evidence" ON public.dispute_evidence FOR INSERT TO authenticated WITH CHECK (((submitted_by = auth.uid()) AND (EXISTS ( SELECT 1
   FROM public.disputes d
  WHERE ((d.id = dispute_evidence.dispute_id) AND ((d.raised_by = auth.uid()) OR (d.raised_against = auth.uid())) AND (d.status <> ALL (ARRAY['resolved'::public.dispute_status, 'closed'::public.dispute_status])))))));


--
-- TOC entry 5975 (class 3256 OID 511930)
-- Name: dispute_evidence Dispute parties can view evidence; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Dispute parties can view evidence" ON public.dispute_evidence FOR SELECT TO authenticated USING ((EXISTS ( SELECT 1
   FROM public.disputes d
  WHERE ((d.id = dispute_evidence.dispute_id) AND ((d.raised_by = auth.uid()) OR (d.raised_against = auth.uid()))))));


--
-- TOC entry 5963 (class 3256 OID 486946)
-- Name: tracking_points Drivers can insert points for their driver sessions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Drivers can insert points for their driver sessions" ON public.tracking_points FOR INSERT WITH CHECK ((driver_tracking_id IN ( SELECT driver_tracking_sessions.id
   FROM public.driver_tracking_sessions
  WHERE ((driver_tracking_sessions.driver_id = auth.uid()) AND (driver_tracking_sessions.status = ANY (ARRAY['active'::text, 'paused'::text]))))));


--
-- TOC entry 5903 (class 3256 OID 445003)
-- Name: driver_bank_accounts Drivers can insert their own bank accounts; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Drivers can insert their own bank accounts" ON public.driver_bank_accounts FOR INSERT TO authenticated WITH CHECK ((driver_id = auth.uid()));


--
-- TOC entry 5885 (class 3256 OID 195044)
-- Name: driver_docs Drivers can manage their own documents; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Drivers can manage their own documents" ON public.driver_docs USING ((auth.uid() = driver_id));


--
-- TOC entry 5888 (class 3256 OID 216701)
-- Name: vehicles Drivers can manage their own vehicles; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Drivers can manage their own vehicles" ON public.vehicles TO authenticated USING ((driver_id = auth.uid())) WITH CHECK ((driver_id = auth.uid()));


--
-- TOC entry 5930 (class 3256 OID 445004)
-- Name: driver_bank_accounts Drivers can update their own bank accounts; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Drivers can update their own bank accounts" ON public.driver_bank_accounts FOR UPDATE TO authenticated USING ((driver_id = auth.uid())) WITH CHECK ((driver_id = auth.uid()));


--
-- TOC entry 5919 (class 3256 OID 444999)
-- Name: escrow_holdings Drivers can view escrow for their accepted bids; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Drivers can view escrow for their accepted bids" ON public.escrow_holdings FOR SELECT TO authenticated USING ((EXISTS ( SELECT 1
   FROM (public.bids b
     JOIN public.vehicles v ON ((b.vehicle_id = v.id)))
  WHERE ((b.id = escrow_holdings.bid_id) AND (v.driver_id = auth.uid())))));


--
-- TOC entry 5882 (class 3256 OID 216708)
-- Name: payments Drivers can view payments for their completed deliveries; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Drivers can view payments for their completed deliveries" ON public.payments FOR SELECT TO authenticated USING ((EXISTS ( SELECT 1
   FROM (public.bids b
     JOIN public.vehicles v ON ((b.vehicle_id = v.id)))
  WHERE ((b.id = payments.bid_id) AND (v.driver_id = auth.uid())))));


--
-- TOC entry 5969 (class 3256 OID 511924)
-- Name: driver_approval_history Drivers can view their own approval history; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Drivers can view their own approval history" ON public.driver_approval_history FOR SELECT TO authenticated USING ((driver_id = auth.uid()));


--
-- TOC entry 5883 (class 3256 OID 445002)
-- Name: driver_bank_accounts Drivers can view their own bank accounts; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Drivers can view their own bank accounts" ON public.driver_bank_accounts FOR SELECT TO authenticated USING ((driver_id = auth.uid()));


--
-- TOC entry 5932 (class 3256 OID 445006)
-- Name: driver_payouts Drivers can view their own payouts; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Drivers can view their own payouts" ON public.driver_payouts FOR SELECT TO authenticated USING ((driver_id = auth.uid()));


--
-- TOC entry 5964 (class 3256 OID 486947)
-- Name: tracking_points Drivers can view their own tracking points; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Drivers can view their own tracking points" ON public.tracking_points FOR SELECT USING ((driver_tracking_id IN ( SELECT driver_tracking_sessions.id
   FROM public.driver_tracking_sessions
  WHERE (driver_tracking_sessions.driver_id = auth.uid()))));


--
-- TOC entry 5877 (class 3256 OID 31248)
-- Name: freight_items Freight item access; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Freight item access" ON public.freight_items FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.freight_posts
  WHERE ((freight_posts.id = freight_items.freight_post_id) AND (freight_posts.shipper_id = auth.uid())))));


--
-- TOC entry 5884 (class 3256 OID 423788)
-- Name: route_cache Public read access to route cache; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Public read access to route cache" ON public.route_cache FOR SELECT TO authenticated USING (true);


--
-- TOC entry 5937 (class 3256 OID 445011)
-- Name: commission_ledger Service role can manage commission ledger; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role can manage commission ledger" ON public.commission_ledger TO service_role USING (true) WITH CHECK (true);


--
-- TOC entry 5931 (class 3256 OID 445005)
-- Name: driver_bank_accounts Service role can manage driver bank accounts; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role can manage driver bank accounts" ON public.driver_bank_accounts TO service_role USING (true) WITH CHECK (true);


--
-- TOC entry 5934 (class 3256 OID 445008)
-- Name: driver_payouts Service role can manage driver payouts; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role can manage driver payouts" ON public.driver_payouts TO service_role USING (true) WITH CHECK (true);


--
-- TOC entry 5920 (class 3256 OID 445001)
-- Name: escrow_holdings Service role can manage escrow holdings; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role can manage escrow holdings" ON public.escrow_holdings TO service_role USING (true) WITH CHECK (true);


--
-- TOC entry 5936 (class 3256 OID 445010)
-- Name: payment_refunds Service role can manage refunds; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role can manage refunds" ON public.payment_refunds TO service_role USING (true) WITH CHECK (true);


--
-- TOC entry 5893 (class 3256 OID 423789)
-- Name: route_cache Service role can manage route cache; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role can manage route cache" ON public.route_cache TO service_role USING (true) WITH CHECK (true);


--
-- TOC entry 5938 (class 3256 OID 445012)
-- Name: paystack_webhook_events Service role can manage webhook events; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role can manage webhook events" ON public.paystack_webhook_events TO service_role USING (true) WITH CHECK (true);


--
-- TOC entry 5970 (class 3256 OID 511925)
-- Name: driver_approval_history Service role full access to approval history; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to approval history" ON public.driver_approval_history TO service_role USING (true) WITH CHECK (true);


--
-- TOC entry 5967 (class 3256 OID 511922)
-- Name: admin_audit_logs Service role full access to audit logs; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to audit logs" ON public.admin_audit_logs TO service_role USING (true) WITH CHECK (true);


--
-- TOC entry 5915 (class 3256 OID 489264)
-- Name: tracking_health_events Service role has full access to tracking_health_events; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role has full access to tracking_health_events" ON public.tracking_health_events TO service_role USING (true) WITH CHECK (true);


--
-- TOC entry 5944 (class 3256 OID 479801)
-- Name: flagged_documents Shippers can flag documents during bid review; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Shippers can flag documents during bid review" ON public.flagged_documents FOR INSERT TO authenticated WITH CHECK (((flagged_by_user_id = auth.uid()) AND (EXISTS ( SELECT 1
   FROM public.users
  WHERE ((users.id = auth.uid()) AND (users.role = ANY (ARRAY['Shipper'::public.user_role, 'Admin'::public.user_role])))))));


--
-- TOC entry 5939 (class 3256 OID 455637)
-- Name: payments Shippers can mark their payments as failed; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Shippers can mark their payments as failed" ON public.payments FOR UPDATE TO authenticated USING (((shipper_id = auth.uid()) AND (status = 'pending'::public.payment_status))) WITH CHECK (((status = 'failed'::public.payment_status) AND (shipper_id = auth.uid())));


--
-- TOC entry 6125 (class 0 OID 0)
-- Dependencies: 5939
-- Name: POLICY "Shippers can mark their payments as failed" ON payments; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON POLICY "Shippers can mark their payments as failed" ON public.payments IS 'Allows shippers to mark their own pending payments as failed when they cancel. This enables immediate payment retry without waiting for the 30-minute timeout.';


--
-- TOC entry 5947 (class 3256 OID 479805)
-- Name: driver_docs Shippers can view documents of drivers bidding on their shipmen; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Shippers can view documents of drivers bidding on their shipmen" ON public.driver_docs FOR SELECT TO authenticated USING (((driver_id = auth.uid()) OR (EXISTS ( SELECT 1
   FROM ((public.bids b
     JOIN public.freight_posts fp ON ((b.freight_post_id = fp.id)))
     JOIN public.vehicles v ON ((b.vehicle_id = v.id)))
  WHERE ((v.driver_id = driver_docs.driver_id) AND (fp.shipper_id = auth.uid()) AND (b.status = ANY (ARRAY['Open'::public.bid_status, 'Accepted'::public.bid_status])))))));


--
-- TOC entry 5962 (class 3256 OID 489266)
-- Name: tracking_health_events Shippers can view health events for their shipments; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Shippers can view health events for their shipments" ON public.tracking_health_events FOR SELECT TO authenticated USING ((session_id IN ( SELECT DISTINCT dts.id
   FROM ((public.driver_tracking_sessions dts
     JOIN public.driver_tracking_shipments dship ON ((dship.driver_tracking_id = dts.id)))
     JOIN public.freight_posts fp ON ((fp.id = dship.shipment_id)))
  WHERE (fp.shipper_id = auth.uid()))));


--
-- TOC entry 5894 (class 3256 OID 216710)
-- Name: payments Shippers can view payments for their shipments; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Shippers can view payments for their shipments" ON public.payments FOR SELECT TO authenticated USING ((EXISTS ( SELECT 1
   FROM public.freight_posts fp
  WHERE ((fp.id = payments.freight_post_id) AND (fp.shipper_id = auth.uid())))));


--
-- TOC entry 5933 (class 3256 OID 445007)
-- Name: driver_payouts Shippers can view payouts for their shipments; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Shippers can view payouts for their shipments" ON public.driver_payouts FOR SELECT TO authenticated USING ((EXISTS ( SELECT 1
   FROM public.freight_posts fp
  WHERE ((fp.id = driver_payouts.freight_post_id) AND (fp.shipper_id = auth.uid())))));


--
-- TOC entry 5918 (class 3256 OID 444998)
-- Name: escrow_holdings Shippers can view their escrow holdings; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Shippers can view their escrow holdings" ON public.escrow_holdings FOR SELECT TO authenticated USING ((shipper_id = auth.uid()));


--
-- TOC entry 5935 (class 3256 OID 445009)
-- Name: payment_refunds Shippers can view their own refunds; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Shippers can view their own refunds" ON public.payment_refunds FOR SELECT TO authenticated USING ((shipper_id = auth.uid()));


--
-- TOC entry 5965 (class 3256 OID 486948)
-- Name: tracking_points Shippers can view tracking points for their shipments; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Shippers can view tracking points for their shipments" ON public.tracking_points FOR SELECT USING ((driver_tracking_id IN ( SELECT DISTINCT dts.id
   FROM ((public.driver_tracking_sessions dts
     JOIN public.driver_tracking_shipments ds ON ((ds.driver_tracking_id = dts.id)))
     JOIN public.freight_posts fp ON ((fp.id = ds.shipment_id)))
  WHERE ((fp.shipper_id = auth.uid()) AND (ds.removed_at IS NULL)))));


--
-- TOC entry 5895 (class 3256 OID 216711)
-- Name: payments System can manage payments; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can manage payments" ON public.payments TO service_role USING (true) WITH CHECK (true);


--
-- TOC entry 5973 (class 3256 OID 511928)
-- Name: disputes Users can create disputes; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can create disputes" ON public.disputes FOR INSERT TO authenticated WITH CHECK ((raised_by = auth.uid()));


--
-- TOC entry 5886 (class 3256 OID 216673)
-- Name: freight_items Users can create freight items for their shipments; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can create freight items for their shipments" ON public.freight_items FOR INSERT TO authenticated WITH CHECK ((EXISTS ( SELECT 1
   FROM public.freight_posts
  WHERE ((freight_posts.id = freight_items.freight_post_id) AND (freight_posts.shipper_id = auth.uid())))));


--
-- TOC entry 5891 (class 3256 OID 216705)
-- Name: ratings Users can create ratings for completed shipments; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can create ratings for completed shipments" ON public.ratings FOR INSERT TO authenticated WITH CHECK (((rated_by_user_id = auth.uid()) AND (EXISTS ( SELECT 1
   FROM public.freight_posts fp
  WHERE ((fp.id = ratings.freight_post_id) AND ((fp.shipper_id = auth.uid()) OR (EXISTS ( SELECT 1
           FROM (public.bids b
             JOIN public.vehicles v ON ((b.vehicle_id = v.id)))
          WHERE ((b.freight_post_id = fp.id) AND (v.driver_id = auth.uid()) AND (b.status = 'Accepted'::public.bid_status))))))))));


--
-- TOC entry 5908 (class 3256 OID 433377)
-- Name: freight_moving Users can delete their own moving records; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete their own moving records" ON public.freight_moving FOR DELETE USING ((EXISTS ( SELECT 1
   FROM public.freight_posts fp
  WHERE ((fp.id = freight_moving.freight_post_id) AND (fp.shipper_id = auth.uid())))));


--
-- TOC entry 5911 (class 3256 OID 433398)
-- Name: freight_rubble Users can delete their own rubble records; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete their own rubble records" ON public.freight_rubble FOR DELETE USING ((EXISTS ( SELECT 1
   FROM public.freight_posts fp
  WHERE ((fp.id = freight_rubble.freight_post_id) AND (fp.shipper_id = auth.uid())))));


--
-- TOC entry 5914 (class 3256 OID 433417)
-- Name: freight_vehicles Users can delete their own vehicle records; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete their own vehicle records" ON public.freight_vehicles FOR DELETE USING ((EXISTS ( SELECT 1
   FROM public.freight_posts fp
  WHERE ((fp.id = freight_vehicles.freight_post_id) AND (fp.shipper_id = auth.uid())))));


--
-- TOC entry 5906 (class 3256 OID 433375)
-- Name: freight_moving Users can insert their own moving records; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can insert their own moving records" ON public.freight_moving FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.freight_posts fp
  WHERE ((fp.id = freight_moving.freight_post_id) AND (fp.shipper_id = auth.uid())))));


--
-- TOC entry 5909 (class 3256 OID 433396)
-- Name: freight_rubble Users can insert their own rubble records; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can insert their own rubble records" ON public.freight_rubble FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.freight_posts fp
  WHERE ((fp.id = freight_rubble.freight_post_id) AND (fp.shipper_id = auth.uid())))));


--
-- TOC entry 5912 (class 3256 OID 433415)
-- Name: freight_vehicles Users can insert their own vehicle records; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can insert their own vehicle records" ON public.freight_vehicles FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.freight_posts fp
  WHERE ((fp.id = freight_vehicles.freight_post_id) AND (fp.shipper_id = auth.uid())))));


--
-- TOC entry 5878 (class 3256 OID 31250)
-- Name: users Users can manage their own data; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can manage their own data" ON public.users USING ((auth.uid() = id));


--
-- TOC entry 5958 (class 3256 OID 522100)
-- Name: device_tokens Users can manage their own device tokens; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can manage their own device tokens" ON public.device_tokens USING ((auth.uid() = user_id)) WITH CHECK ((auth.uid() = user_id));


--
-- TOC entry 5979 (class 3256 OID 511934)
-- Name: admin_messages Users can mark messages as read; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can mark messages as read" ON public.admin_messages FOR UPDATE TO authenticated USING ((recipient_id = auth.uid())) WITH CHECK ((recipient_id = auth.uid()));


--
-- TOC entry 5887 (class 3256 OID 216674)
-- Name: freight_items Users can update freight items for their shipments; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update freight items for their shipments" ON public.freight_items FOR UPDATE TO authenticated USING ((EXISTS ( SELECT 1
   FROM public.freight_posts
  WHERE ((freight_posts.id = freight_items.freight_post_id) AND (freight_posts.shipper_id = auth.uid()))))) WITH CHECK ((EXISTS ( SELECT 1
   FROM public.freight_posts
  WHERE ((freight_posts.id = freight_items.freight_post_id) AND (freight_posts.shipper_id = auth.uid())))));


--
-- TOC entry 5907 (class 3256 OID 433376)
-- Name: freight_moving Users can update their own moving records; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update their own moving records" ON public.freight_moving FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.freight_posts fp
  WHERE ((fp.id = freight_moving.freight_post_id) AND (fp.shipper_id = auth.uid())))));


--
-- TOC entry 5892 (class 3256 OID 216707)
-- Name: ratings Users can update their own ratings; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update their own ratings" ON public.ratings FOR UPDATE TO authenticated USING ((rated_by_user_id = auth.uid())) WITH CHECK ((rated_by_user_id = auth.uid()));


--
-- TOC entry 5910 (class 3256 OID 433397)
-- Name: freight_rubble Users can update their own rubble records; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update their own rubble records" ON public.freight_rubble FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.freight_posts fp
  WHERE ((fp.id = freight_rubble.freight_post_id) AND (fp.shipper_id = auth.uid())))));


--
-- TOC entry 5913 (class 3256 OID 433416)
-- Name: freight_vehicles Users can update their own vehicle records; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update their own vehicle records" ON public.freight_vehicles FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.freight_posts fp
  WHERE ((fp.id = freight_vehicles.freight_post_id) AND (fp.shipper_id = auth.uid())))));


--
-- TOC entry 5890 (class 3256 OID 216704)
-- Name: ratings Users can view ratings for drivers; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view ratings for drivers" ON public.ratings FOR SELECT TO authenticated USING (true);


--
-- TOC entry 5978 (class 3256 OID 511933)
-- Name: admin_messages Users can view their messages; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view their messages" ON public.admin_messages FOR SELECT TO authenticated USING (((recipient_id = auth.uid()) OR ((message_type = 'broadcast'::text) AND ((recipient_role IS NULL) OR (recipient_role = ( SELECT users.role
   FROM public.users
  WHERE (users.id = auth.uid())))))));


--
-- TOC entry 5972 (class 3256 OID 511927)
-- Name: disputes Users can view their own disputes; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view their own disputes" ON public.disputes FOR SELECT TO authenticated USING (((raised_by = auth.uid()) OR (raised_against = auth.uid())));


--
-- TOC entry 5945 (class 3256 OID 479802)
-- Name: flagged_documents Users can view their own flags; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view their own flags" ON public.flagged_documents FOR SELECT TO authenticated USING ((flagged_by_user_id = auth.uid()));


--
-- TOC entry 5926 (class 3256 OID 437966)
-- Name: freight_items Users can view their own items data; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view their own items data" ON public.freight_items FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.freight_posts fp
  WHERE ((fp.id = freight_items.freight_post_id) AND (fp.shipper_id = auth.uid())))));


--
-- TOC entry 5917 (class 3256 OID 437960)
-- Name: freight_moving Users can view their own moving data; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view their own moving data" ON public.freight_moving FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.freight_posts fp
  WHERE ((fp.id = freight_moving.freight_post_id) AND (fp.shipper_id = auth.uid())))));


--
-- TOC entry 5922 (class 3256 OID 437962)
-- Name: freight_rubble Users can view their own rubble data; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view their own rubble data" ON public.freight_rubble FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.freight_posts fp
  WHERE ((fp.id = freight_rubble.freight_post_id) AND (fp.shipper_id = auth.uid())))));


--
-- TOC entry 5961 (class 3256 OID 489265)
-- Name: tracking_health_events Users can view their own tracking health events; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view their own tracking health events" ON public.tracking_health_events FOR SELECT TO authenticated USING ((session_id IN ( SELECT driver_tracking_sessions.id
   FROM public.driver_tracking_sessions
  WHERE (driver_tracking_sessions.driver_id = auth.uid()))));


--
-- TOC entry 5924 (class 3256 OID 437964)
-- Name: freight_vehicles Users can view their own vehicles data; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view their own vehicles data" ON public.freight_vehicles FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.freight_posts fp
  WHERE ((fp.id = freight_vehicles.freight_post_id) AND (fp.shipper_id = auth.uid())))));


--
-- TOC entry 5871 (class 0 OID 511783)
-- Dependencies: 397
-- Name: admin_audit_logs; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.admin_audit_logs ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5875 (class 0 OID 511890)
-- Dependencies: 401
-- Name: admin_messages; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.admin_messages ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5905 (class 3256 OID 483382)
-- Name: driver_tracking_sessions authenticated_view_tracking; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY authenticated_view_tracking ON public.driver_tracking_sessions FOR SELECT USING (true);


--
-- TOC entry 5846 (class 0 OID 30833)
-- Dependencies: 339
-- Name: bids; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.bids ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5942 (class 3256 OID 485725)
-- Name: bids bids_driver_manage_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY bids_driver_manage_own ON public.bids TO authenticated USING (public.user_owns_vehicle(vehicle_id)) WITH CHECK (public.user_owns_vehicle(vehicle_id));


--
-- TOC entry 6126 (class 0 OID 0)
-- Dependencies: 5942
-- Name: POLICY bids_driver_manage_own ON bids; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON POLICY bids_driver_manage_own ON public.bids IS 'Drivers can manage bids from their vehicles using SECURITY DEFINER function';


--
-- TOC entry 5927 (class 3256 OID 485712)
-- Name: bids bids_realtime_anon; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY bids_realtime_anon ON public.bids FOR SELECT TO anon USING (true);


--
-- TOC entry 6127 (class 0 OID 0)
-- Dependencies: 5927
-- Name: POLICY bids_realtime_anon ON bids; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON POLICY bids_realtime_anon ON public.bids IS 'Allow anon role to SELECT for realtime subscriptions (filtered by subscription filter)';


--
-- TOC entry 5928 (class 3256 OID 485713)
-- Name: bids bids_service_role_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY bids_service_role_all ON public.bids TO service_role USING (true) WITH CHECK (true);


--
-- TOC entry 6128 (class 0 OID 0)
-- Dependencies: 5928
-- Name: POLICY bids_service_role_all ON bids; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON POLICY bids_service_role_all ON public.bids IS 'Service role has full access for background jobs and migrations';


--
-- TOC entry 5943 (class 3256 OID 485726)
-- Name: bids bids_shipper_select; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY bids_shipper_select ON public.bids FOR SELECT TO authenticated USING (public.user_owns_freight_post(freight_post_id));


--
-- TOC entry 6129 (class 0 OID 0)
-- Dependencies: 5943
-- Name: POLICY bids_shipper_select ON bids; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON POLICY bids_shipper_select ON public.bids IS 'Shippers can view bids on their freight posts using SECURITY DEFINER function';


--
-- TOC entry 5948 (class 3256 OID 485727)
-- Name: bids bids_shipper_update; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY bids_shipper_update ON public.bids FOR UPDATE TO authenticated USING (public.user_owns_freight_post(freight_post_id)) WITH CHECK (public.user_owns_freight_post(freight_post_id));


--
-- TOC entry 6130 (class 0 OID 0)
-- Dependencies: 5948
-- Name: POLICY bids_shipper_update ON bids; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON POLICY bids_shipper_update ON public.bids IS 'Shippers can update bids on their freight posts using SECURITY DEFINER function';


--
-- TOC entry 5864 (class 0 OID 444943)
-- Dependencies: 388
-- Name: commission_ledger; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.commission_ledger ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5876 (class 0 OID 522080)
-- Dependencies: 402
-- Name: device_tokens; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.device_tokens ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5874 (class 0 OID 511868)
-- Dependencies: 400
-- Name: dispute_evidence; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.dispute_evidence ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5873 (class 0 OID 511824)
-- Dependencies: 399
-- Name: disputes; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.disputes ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5872 (class 0 OID 511801)
-- Dependencies: 398
-- Name: driver_approval_history; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.driver_approval_history ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5861 (class 0 OID 444829)
-- Dependencies: 385
-- Name: driver_bank_accounts; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.driver_bank_accounts ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5854 (class 0 OID 146962)
-- Dependencies: 367
-- Name: driver_docs; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.driver_docs ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5951 (class 3256 OID 479876)
-- Name: driver_tracking_sessions driver_insert_own_sessions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY driver_insert_own_sessions ON public.driver_tracking_sessions FOR INSERT WITH CHECK ((auth.uid() = driver_id));


--
-- TOC entry 5862 (class 0 OID 444852)
-- Dependencies: 386
-- Name: driver_payouts; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.driver_payouts ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5867 (class 0 OID 479822)
-- Dependencies: 392
-- Name: driver_tracking_sessions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.driver_tracking_sessions ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5868 (class 0 OID 479847)
-- Dependencies: 393
-- Name: driver_tracking_shipments; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.driver_tracking_shipments ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5952 (class 3256 OID 479877)
-- Name: driver_tracking_sessions driver_update_own_sessions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY driver_update_own_sessions ON public.driver_tracking_sessions FOR UPDATE USING ((auth.uid() = driver_id));


--
-- TOC entry 5960 (class 3256 OID 486880)
-- Name: shipment_tracking_metrics driver_update_shipment_metrics; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY driver_update_shipment_metrics ON public.shipment_tracking_metrics USING ((EXISTS ( SELECT 1
   FROM public.driver_tracking_sessions
  WHERE ((driver_tracking_sessions.id = shipment_tracking_metrics.driver_tracking_session_id) AND (driver_tracking_sessions.driver_id = auth.uid())))));


--
-- TOC entry 5940 (class 3256 OID 479875)
-- Name: driver_tracking_sessions driver_view_own_sessions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY driver_view_own_sessions ON public.driver_tracking_sessions FOR SELECT USING ((auth.uid() = driver_id));


--
-- TOC entry 5860 (class 0 OID 444789)
-- Dependencies: 384
-- Name: escrow_holdings; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.escrow_holdings ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5866 (class 0 OID 479761)
-- Dependencies: 391
-- Name: flagged_documents; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.flagged_documents ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5847 (class 0 OID 30842)
-- Dependencies: 340
-- Name: freight_items; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.freight_items ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5857 (class 0 OID 433353)
-- Dependencies: 381
-- Name: freight_moving; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.freight_moving ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5848 (class 0 OID 30856)
-- Dependencies: 341
-- Name: freight_posts; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.freight_posts ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5955 (class 3256 OID 485730)
-- Name: freight_posts freight_posts_drivers_view_bidding; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY freight_posts_drivers_view_bidding ON public.freight_posts FOR SELECT TO authenticated USING (((status = 'Bidding'::public.freight_status) AND (archived = false) AND (shipper_id <> public.get_current_user_id())));


--
-- TOC entry 5956 (class 3256 OID 485731)
-- Name: freight_posts freight_posts_drivers_view_jobs; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY freight_posts_drivers_view_jobs ON public.freight_posts FOR SELECT TO authenticated USING (public.user_has_accepted_bid(id));


--
-- TOC entry 6131 (class 0 OID 0)
-- Dependencies: 5956
-- Name: POLICY freight_posts_drivers_view_jobs ON freight_posts; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON POLICY freight_posts_drivers_view_jobs ON public.freight_posts IS 'Drivers can view freight posts for their accepted bids using SECURITY DEFINER function';


--
-- TOC entry 5957 (class 3256 OID 485732)
-- Name: freight_posts freight_posts_owner_manage; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY freight_posts_owner_manage ON public.freight_posts TO authenticated USING ((shipper_id = public.get_current_user_id())) WITH CHECK ((shipper_id = public.get_current_user_id()));


--
-- TOC entry 5929 (class 3256 OID 485720)
-- Name: freight_posts freight_posts_realtime_anon; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY freight_posts_realtime_anon ON public.freight_posts FOR SELECT TO anon USING (true);


--
-- TOC entry 6132 (class 0 OID 0)
-- Dependencies: 5929
-- Name: POLICY freight_posts_realtime_anon ON freight_posts; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON POLICY freight_posts_realtime_anon ON public.freight_posts IS 'Allow anon role to SELECT for realtime subscriptions';


--
-- TOC entry 5941 (class 3256 OID 485721)
-- Name: freight_posts freight_posts_service_role_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY freight_posts_service_role_all ON public.freight_posts TO service_role USING (true) WITH CHECK (true);


--
-- TOC entry 6133 (class 0 OID 0)
-- Dependencies: 5941
-- Name: POLICY freight_posts_service_role_all ON freight_posts; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON POLICY freight_posts_service_role_all ON public.freight_posts IS 'Service role has full access';


--
-- TOC entry 5949 (class 3256 OID 485728)
-- Name: freight_posts freight_posts_shipper_insert; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY freight_posts_shipper_insert ON public.freight_posts FOR INSERT TO authenticated WITH CHECK ((shipper_id = public.get_current_user_id()));


--
-- TOC entry 5950 (class 3256 OID 485729)
-- Name: freight_posts freight_posts_shipper_update; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY freight_posts_shipper_update ON public.freight_posts FOR UPDATE TO authenticated USING ((shipper_id = public.get_current_user_id())) WITH CHECK ((shipper_id = public.get_current_user_id()));


--
-- TOC entry 5858 (class 0 OID 433378)
-- Dependencies: 382
-- Name: freight_rubble; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.freight_rubble ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5859 (class 0 OID 433399)
-- Dependencies: 383
-- Name: freight_vehicles; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.freight_vehicles ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5849 (class 0 OID 30865)
-- Dependencies: 342
-- Name: notifications; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.notifications ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5901 (class 3256 OID 254894)
-- Name: notifications notifications_delete_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY notifications_delete_own ON public.notifications FOR DELETE TO authenticated USING (((auth.uid() IS NOT NULL) AND (auth.uid() <> '00000000-0000-0000-0000-000000000000'::uuid) AND (user_id = auth.uid())));


--
-- TOC entry 5904 (class 3256 OID 254936)
-- Name: notifications notifications_realtime_select; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY notifications_realtime_select ON public.notifications FOR SELECT TO authenticated, anon USING (true);


--
-- TOC entry 5899 (class 3256 OID 254892)
-- Name: notifications notifications_select_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY notifications_select_own ON public.notifications FOR SELECT TO authenticated USING (((auth.uid() IS NOT NULL) AND (auth.uid() <> '00000000-0000-0000-0000-000000000000'::uuid) AND (user_id = auth.uid())));


--
-- TOC entry 5902 (class 3256 OID 254895)
-- Name: notifications notifications_service_role_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY notifications_service_role_all ON public.notifications TO service_role USING (true) WITH CHECK (true);


--
-- TOC entry 5900 (class 3256 OID 254893)
-- Name: notifications notifications_update_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY notifications_update_own ON public.notifications FOR UPDATE TO authenticated USING (((auth.uid() IS NOT NULL) AND (auth.uid() <> '00000000-0000-0000-0000-000000000000'::uuid) AND (user_id = auth.uid()))) WITH CHECK (((auth.uid() IS NOT NULL) AND (auth.uid() <> '00000000-0000-0000-0000-000000000000'::uuid) AND (user_id = auth.uid())));


--
-- TOC entry 5863 (class 0 OID 444900)
-- Dependencies: 387
-- Name: payment_refunds; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.payment_refunds ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5850 (class 0 OID 30874)
-- Dependencies: 343
-- Name: payments; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.payments ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5865 (class 0 OID 444983)
-- Dependencies: 389
-- Name: paystack_webhook_events; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.paystack_webhook_events ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5953 (class 3256 OID 479878)
-- Name: driver_tracking_shipments public_view_tracking_shipments; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY public_view_tracking_shipments ON public.driver_tracking_shipments FOR SELECT USING (true);


--
-- TOC entry 5851 (class 0 OID 30882)
-- Dependencies: 344
-- Name: ratings; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.ratings ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5856 (class 0 OID 423762)
-- Dependencies: 378
-- Name: route_cache; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.route_cache ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5869 (class 0 OID 486856)
-- Dependencies: 394
-- Name: shipment_tracking_metrics; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.shipment_tracking_metrics ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5959 (class 3256 OID 486879)
-- Name: shipment_tracking_metrics shipper_view_shipment_metrics; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY shipper_view_shipment_metrics ON public.shipment_tracking_metrics FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.freight_posts
  WHERE ((freight_posts.id = shipment_tracking_metrics.shipment_id) AND (freight_posts.shipper_id = auth.uid())))));


--
-- TOC entry 5954 (class 3256 OID 479879)
-- Name: driver_tracking_shipments system_manage_tracking_shipments; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY system_manage_tracking_shipments ON public.driver_tracking_shipments USING (true);


--
-- TOC entry 5870 (class 0 OID 489244)
-- Dependencies: 395
-- Name: tracking_health_events; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.tracking_health_events ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5855 (class 0 OID 361937)
-- Dependencies: 375
-- Name: tracking_points; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.tracking_points ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5881 (class 3256 OID 413808)
-- Name: tracking_points tracking_points_realtime_anon; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY tracking_points_realtime_anon ON public.tracking_points FOR SELECT TO anon USING (true);


--
-- TOC entry 5896 (class 3256 OID 361977)
-- Name: tracking_points tracking_points_service_role_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY tracking_points_service_role_all ON public.tracking_points TO service_role USING (true) WITH CHECK (true);


--
-- TOC entry 5852 (class 0 OID 30890)
-- Dependencies: 345
-- Name: users; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;

--
-- TOC entry 5853 (class 0 OID 30900)
-- Dependencies: 346
-- Name: vehicles; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.vehicles ENABLE ROW LEVEL SECURITY;

-- Completed on 2026-02-16 15:42:42

--
-- PostgreSQL database dump complete
--

\unrestrict wb3J0fnyZNsiwAQ5r5fTnZ4j8WCYtIRH4yH8KY6O4jcYDfnEEJkH0wXgck41blw

